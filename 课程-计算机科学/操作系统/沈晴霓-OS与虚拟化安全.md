
OS安全分级：1-4？

课程简介：
- os
- 虚拟化安全理论技术、方法、应用

内容：
- 预备知识
- 安全概念与标准
- 安全机制
- 安全模型
- 安全体系结构
- 安全开发方法
- os与虚拟化安全实践

网课：[link](https://www.bilibili.com/video/BV18x411U7MW/)

考核方法：30平时成绩+30 project+40考试=100
- 项目：论文报告/技术项目二选一
- 平时：作业+实验

参考书目：
- 黑皮书《操作系统安全设计》
- 《Linux内核安全模块深入剖析》

## sec0-预备知识

### 0.1-os原理概述

宏vs微：
- 微内核：Windows/Minix/MacOS
- 宏内核：Linux/Unix

os特性：并发/共享/异步

os引导过程：上电-BIOS自检-加载引导扇区-加载OS-运行OS

cpu管理：
- 中断
- 调度：进程、线程、调度算法

进程vs线程：
- 上下文切换：线程更快
- 并发性：线程更高
- 系统开销：进程更大
- 地址空间和其他资源：进程间互斥，同进程内线程共享
- 通信：进程通过socket/pipe/ipc/信号等，线程通过进程数据段

cpu调度层次：作业调度>进程调度>内存调度

调度算法目标：资源利用率、公平性、均衡性、策略强制执行

调度算法：SJF、HRRN、FIFO、时间片轮转、优先权（抢占/非抢占）

### 0.2-os设计技术

os层次：
- 用户级：用户程序、程序库
- 内核级：
	- 系统调用接口
	- 文件子系统、进程控制子系统等
	- 存储管理系统、驱动程序等
	- 硬件控制逻辑
- 硬件级

os子系统：
- 文件子系统：外存空间管理、文件存取、数据检索
- 进程控制子系统：同步/互斥、IPC、MM、调度
- 硬件控制：处理中断、与硬件通信

文件内部表示：
- 索引结点表（inode table）
	- 磁盘索引结点
	- 内存索引结点：额外记录锁、文件引用数等信息
- 文件表（file table）：系统全局记录所有打开的文件
- 用户文件描述符表（user fd table）：每进程一个，Linux中为`file_struct`和`fs_struct`

建议看P15/38的图

虚拟文件系统VFS：
- 统筹外存、设备等为虚拟文件
- `struct file_operations`

进程结构：
- 数据结构：PID、状态、调度信息、IPC信息、链接信息、时间相关、文件系统信息、上下文信息
- 进程树：0生1、1生万物
- 上下文：用户上下文（程序+数据+堆栈）、寄存器上下文、系统级上下文
- u区：内核操纵的进程数据区
- 系统段表、进程段表：地址映射，便于对段共享

进程间通信（IPC）：
- 基本机制：PIPE/FIFO/软中断/Sockets
- UNIX V机制：消息队列（`struct msg`）、共享存储区（`struct shm`）、信号量（`struct sem`）
	- 对应的系统调用：P31-33/38

I/O子系统：
- 块设备、字符设备
- 每个设备对应一个文件

### 0.3-虚拟化技术概述

- 数据中心现状/趋势
- 虚拟化定义
- 虚拟化类型
- 服务器虚拟化关键技术
- 主流虚拟化软件/技术实践

数据中心现状/趋势（P3-9/65）：
- 烟囱式结构：使用率低、部署不灵活、管理成本巨大
- 冰山模式：表面（小额新设施建设）+深层（大额人员支出/设施维护）
- IT基础架构发展的*三个阶段*：
	- 整合：降本增效
	- 虚拟化：增加弹性/效率和使用
	- 自动化：支持业务

虚拟化定义（P10-11/65）：
- 表示计算机资源的抽象方法

虚拟化的常见类型（P12-18/65）：
- 常见类型：
	- 基础设施虚拟化：网络虚拟化（VLAN/VPN/SDN）、存储虚拟化（基于存储设备：磁盘阵列；基于网络：NAS/SAN/Hadoop）
	- 系统虚拟化：虚拟机（服务器虚拟化/桌面虚拟化）
	- 软件虚拟化：高级语言虚拟化（JVM）、应用程序虚拟化（App与OS解耦）
- 技术分类：应用程序级/编程语言级/程序库级/OS级/指令级/硬件级

服务器虚拟化关键技术（P19-/65）：
- since 1960'（利用珍贵的计算资源）->80'/90'（暂冷）->now（重新火热）
- 体系结构（P25）
- 虚拟机系统=裸机+VMM层：VMM（虚拟机监控软件）、VM（虚拟机软件）、host OS（宿主机）
- 实现技术分类：
	- 全虚拟化：特权指令拦截机制，开销大
	- 泛虚拟化：修改内核使其支持VM运行在机器级，需要改内核
	- 硬件辅助虚拟化：添加权限更高的根模式，依赖硬件支持
- VMM分类（P30）：
	- 宿主型：VMWare Workstation、KVM
	- 独立监控型：Xen
- VMM实现技术（P33）：
	- CPU虚拟化：仿真执行特权指令
		- 硬件CPU虚拟化：硬件完成ring切换，如Intel VT-x、AMD-V
	- 内存虚拟化：VMM必须直接控制物理内存
		- 影子页表
	- I/O虚拟化

主流虚拟化软件/技术实践（P43-/65）：
- 主流虚拟化软件：
	- VMWare
	- Xen VMM：完全/半虚拟化
- 硬件虚拟化支持：
	- Intel：VT-x（处理器辅助）、VT-d（直接I/O）、VT-c（网络辅助）、TXT（可信执行）

### 0.4-虚拟化关键技术

- 系统虚拟化主要作用
- CPU虚拟化
- 内存虚拟化
- I/O虚拟化

虚拟化主要作用：隔离、合并、迁移、个性化

CPU虚拟化（P2-15/35）：
- 本质：每个虚拟机使用一或多个vCPU，vCPU使用CPU
- *Xen Credit额度调度算法*：
	- 威胁：拒绝服务攻击、信息泄露
	- 软件解决：客户端降权
- 虚拟化挑战：机内对外不知情、VMM提供接口/保护虚拟机/使虚拟机彼此独立
- 硬件辅助CPU虚拟化：引入新指令和CPU运行模式，使VMM与guest OS在不同模式运行
- Intel VT-x：
	- VMX root模式：拥有全部权限，运行VMM
	- VMX non-root模式：运行guest OS，权限受限
	- VMX指令集
	- 虚拟机控制结构（VMCS）

内存虚拟化（P16-25/35）：
- 三层地址结构：机器地址（真实地址）-物理地址（VMM抽象的伪物理地址）-虚拟地址（guest OS提供程序的地址）
- 页表虚拟化：
	- MMU泛虚拟化：直接将复合映射写入guest OS页表
	- 影子页表：guest OS的页表对应一个影子页表
- 内存虚拟化优化机制：
	- 按需取页与虚拟存储：两种方案
		- VMM层实现内存换页
		- 虚拟机间实现气球驱动（balloon driver），动态调控guest OS可用的物理内存
	- 内存共享（页面写时复制）：共享页面只读，修改前必须复制
	- 内存可写工作集：频繁被修改的内存作为工作集
	- 硬件辅助内存虚拟化：
		- Intel VPIDs（虚拟处理器标识）：在TLB中添加vCPU编号标记不同的CPU地址空间，避免VM切换时TLB大规模失效
		- Intel EPT（扩展页表）：从硬件上进行页表再映射，解决x86只能映射一次页表的缺陷，允许影子页表实现

I/O虚拟化（P26-35/35）：
- 两种方式：
	- 模拟I/O设备：对VM模拟I/O设备行为，兼容强性能差
	- 额外软件接口：对VM提供直通设备接口，性能高兼容差
- Intel VT-d：
	- 解决问题：提供guest OS直接访问硬件的机制，降低物理CPU负载
	- 优势：几乎完全消除了VMM中运行驱动程序的需求
	- 设计：
		- 关键：解决DMA和IRQ中断请求
		- DMA重映射：实现IOMMU用于保护多个DMA区域
		- 中断重映射：通过重新定义MSI（消息终端）解决中断隔离问题，MSI中现在指定DMA区域ID而非物理地址，避免未授权的内存写入

乐。——241029

## sec1-安全概念和标准

### 1.1-os安全的重要性

计算机系统安全性要求=法律法规+人身安全+信息/资产保护

系统面临的威胁：
- 客观：软件漏洞、未授权访问、硬件错误
- 主观：恶意用户、人员错误

系统面临的攻击：
- 攻击：恶意代码、拒绝服务
- 窃取：系统渗透、网络嗅探、信息泄露
- 其他：中间人、社会工程

安全性的两个方面：
- 计算机安全
- 通信安全（网络安全）

系统安全问题多来自于os的安全脆弱性。

安全性原则：
- 安全性必须逐层建立
- 每一层的安全性都必须建立在底层可信的前提上
- 安全应用不应建立在不可信层上

安全系统的定义：自可信状态出发，不会停留于不可信状态

安全VS可信：
- 安全是绝对、二元的概念，是系统的目标
- 可信是相对、分级的评估结果，是系统的特点

### 1.2-国内外技术现状

- 60s：美国开始os安全的研究
- 70s：军方和gov开始使用安全系统
- 80-90s：TCSEC标准，B1、B2、B3、A1级
- 2001-now：EAL4/EAL5评估级别产品

国外知名项目：

| 名称                    | 时间/开发者                  | 特点                              |
| --------------------- | ----------------------- | ------------------------------- |
| Multics               | 1965，Bell Lab & MIT MAC | 并发访问信息存储系统时的高安全性                |
| Adept-50              | 1969，美国军方               | 第一个实用分时安全系统，以高水印模型为基础，提供形式化解决方案 |
| J. P. Anderson Report | 1972, J. P. Anderson    | 提出引用监控、引用验证、安全内核和安全建模思想         |
| PSOS                  | 1973-80                 | 层次化、基于权能的安全os，分解系统的安全性论证问题      |
| KSOS                  | 1977，Ford               | 高安全可信性                          |
| LOCK                  | 1987-92，美国国家安全计算中心      | 达到或超过TCSEC A1级安全的系统             |
| XENIX                 | 1986-94，IBM/TIS         | TCSEC B2-A1级的安全操作系统             |
| TMach/DTMach          | 1987-93，TIS             | B3级系统，基于Mach和LOCK               |
| DTOS                  | 1997                    | 安全微内核                           |
| TUNIS                 | 1989                    | 实现BLP模型，重写UNIX                  |
| ASOS                  | 1990，TRW                | 基于访问控制列表、BLP模型、Biba模型的安全机制      |
| STOP                  | 1985，Honeywall          | A1级系统，安全仲裁机制                    |
| SELinux               | 2001，美国NSA              | 基于Flask体系结构的强制访问控制策略            |

### 1.3-国内外相关标准

标准：
- TCSEC：Trusted Computer System Evaluation Criteria
- ITSEC：Information Technology Security Evaluation Criteria
- FC
- CC
- etc.

彩虹系列丛书：
- [link](www.chinacissp.com/knowledge/Rainbow/rainbow_series.htm)
- [link2](www.governmentsecurity.org/articles/RainbowSeriesLibraryTheOneTheOnly.php)

*TCSEC等级*：

![[Pasted image 20241105190604.png]]

TCSEC评估的产品：P7/46

ITSEC标准：
- since 1990，1991发布1.2版本
- 首次提出保密性、完整性、可用性和ST（安全目标）的改变
- 安全性分为：
	- 功能要求：为满足安全需求采取的技术措施，如访问控制、审计、鉴别等
	- 保证要求：确保功能有效实现的安全措施，如渗透测试、安全脆弱性分析等
- 安全功能等级（F1-F10）、安全保证等级（E0-E6）
- 定义产品/系统的评估目标（TOE，target of evaluation），并声明：
	- 安全策略/原则、功能/规范
	- 安全机制的定义/强度
	- 功能和有效性的目标评估等级
- 评估者需要判定：
	- 功能的适当性/有效性、易用性
	- 机制强度和脆弱性

CC（Common Criteria）标准：
- 1991（指定）-1996（v1.0）-1997（v2.0）-1999（ISO/IEC 15408）
- 三种角色：消费者、开发者、评估者
- 三个方面考量：一般模型、安全功能要求、安全保证要求
- 关键概念：![[Pasted image 20241105195137.png]]
	- 评估对象（TOE）：受评估的主体
	- 保护轮廓（PP）：与实现无关的安全要求
	- 安全目标（ST）：作为既定TOE评估基础使用的一组安全要求/规范
	- TOE安全策略（TSP）：TOE种管理资产的一组规则
	- TOE安全功能（TSF）：正确执行TOE所必需的所有部件集合
	- 见P21/56
	- 用户方-Profile Prot.-ST-设计文档-TOE-开发者
- 核心内容：
	- 简介及一般模型（P23-26）
	- 安全功能要求（P27-28）
	- 安全保证要求（P29-39）

CC/TCSEC/ITSEC对比：
- CC级别：EAL0-EAL7
- ITSEC级别：E0-E6
- TCSEC级别：D/C1/C2/B1/B2/B3/A1

我国标准：P43

### 1.4-安全概念和设计思想

安全概念：
- 引用监控器
- 安全内核及其设计原则
- 可信计算基
- 系统边界和安全周界
- 可信软件与不可信软件

设计思想：
- 主体、客体、访问控制矩阵
- 安全策略与安全建模
- 安全功能与安全保证
- 安全体系结构

访问控制思想：
- 主体+客体+访问控制矩阵

*主体*（subjects）：引起信息在客体之间流动的实体，如人、进程、设备等。

*客体*（objects）：一个被动实体，如数据文件等

访问控制：
- 定义：存在于系统中的，授予或撤销用户访问、修改某些数据权限的机制
- 分类：文件权限、执行权限、数据库权限

访问控制矩阵（access control matrix）：不同用户访问不同资源的权限表

*通用安全需求*：（P6/44）
- 机密性：加密、访问控制
- 完整性：访问控制
- 可追究性：标识、鉴别、审计
- 可用性

*安全三要素*（P7）：
- 安全策略（P8）：做什么
- 安全机制（P30）：怎么做
- 安全保证（P40）：效果如何

*安全策略*（P8）：
- 定义：一种将系统状态划分为安全和不安全状态集合的方法
- 类型：
	- 机密性策略：防止未授权访问
	- 完整性策略：防止未授权修改

*策略语言*（P11）：
- 定义：描述安全策略的语言
- 分类：
	- 高级策略语言：描述每个域的详细权限规则
	- 低级策略语言：简单/二元权限规则

*安全建模思想*（P14）：
- 不安全性：安全控制漏洞+安全定义缺陷

*安全模型*（sec' policy model，P15）：
- 定义：系统执行的安全策略的清晰表述
- 特点：精确无歧义、简单抽象、只涉及安全性质
- 作用：
	- 明确安全性定义，指导os设计和实现
	- 为安全测试提供上下文，提供论证保障

安全模型实例*HRU Model*（P17）

*安全机制*（P30）：实现安全策略的手段
- 分类：预防（最常用）、检测、恢复
- *引用监控器*：对主体对客体访问行为进行监控的机制
	- *引用验证机制*（RVM）：
		- 安全内核方法（P34）
		- 三个设计原则：完整性、隔离性、可验证性
- 系统边界与安全周界
- 可信计算基
- 可信软件与不可信软件

*安全功能、安全保证*（P40）：
- 安全功能（提供什么保护功能？）、安全保证（保护功能多强？）
- 信任：任何安全策略/机制都基于某种假设/信任
- 安全体系结构：描述系统达到安全要求必需的组织方式。

