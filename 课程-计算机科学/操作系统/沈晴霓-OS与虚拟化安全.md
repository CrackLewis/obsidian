
OS安全分级：1-4？

课程简介：
- os
- 虚拟化安全理论技术、方法、应用

内容：
- 预备知识
- 安全概念与标准
- 安全机制
- 安全模型
- 安全体系结构
- 安全开发方法
- os与虚拟化安全实践

网课：[link](https://www.bilibili.com/video/BV18x411U7MW/)

考核方法：30平时成绩+30 project+40考试=100
- 项目：论文报告/技术项目二选一
- 平时：作业+实验

参考书目：
- 黑皮书《操作系统安全设计》
- 《Linux内核安全模块深入剖析》

## sec0-预备知识

### 0.1-os原理概述

宏vs微：
- 微内核：Windows/Minix/MacOS
- 宏内核：Linux/Unix

os特性：并发/共享/异步

os引导过程：上电-BIOS自检-加载引导扇区-加载OS-运行OS

cpu管理：
- 中断
- 调度：进程、线程、调度算法

进程vs线程：
- 上下文切换：线程更快
- 并发性：线程更高
- 系统开销：进程更大
- 地址空间和其他资源：进程间互斥，同进程内线程共享
- 通信：进程通过socket/pipe/ipc/信号等，线程通过进程数据段

cpu调度层次：作业调度>进程调度>内存调度

调度算法目标：资源利用率、公平性、均衡性、策略强制执行

调度算法：SJF、HRRN、FIFO、时间片轮转、优先权（抢占/非抢占）

### 0.2-os设计技术

os层次：
- 用户级：用户程序、程序库
- 内核级：
	- 系统调用接口
	- 文件子系统、进程控制子系统等
	- 存储管理系统、驱动程序等
	- 硬件控制逻辑
- 硬件级

os子系统：
- 文件子系统：外存空间管理、文件存取、数据检索
- 进程控制子系统：同步/互斥、IPC、MM、调度
- 硬件控制：处理中断、与硬件通信

文件内部表示：
- 索引结点表（inode table）
	- 磁盘索引结点
	- 内存索引结点：额外记录锁、文件引用数等信息
- 文件表（file table）：系统全局记录所有打开的文件
- 用户文件描述符表（user fd table）：每进程一个，Linux中为`file_struct`和`fs_struct`

建议看P15/38的图

虚拟文件系统VFS：
- 统筹外存、设备等为虚拟文件
- `struct file_operations`

进程结构：
- 数据结构：PID、状态、调度信息、IPC信息、链接信息、时间相关、文件系统信息、上下文信息
- 进程树：0生1、1生万物
- 上下文：用户上下文（程序+数据+堆栈）、寄存器上下文、系统级上下文
- u区：内核操纵的进程数据区
- 系统段表、进程段表：地址映射，便于对段共享

进程间通信（IPC）：
- 基本机制：PIPE/FIFO/软中断/Sockets
- UNIX V机制：消息队列（`struct msg`）、共享存储区（`struct shm`）、信号量（`struct sem`）
	- 对应的系统调用：P31-33/38

I/O子系统：
- 块设备、字符设备
- 每个设备对应一个文件

### 0.3-虚拟化技术概述

- 数据中心现状/趋势
- 虚拟化定义
- 虚拟化类型
- 服务器虚拟化关键技术
- 主流虚拟化软件/技术实践

数据中心现状/趋势（P3-9/65）：
- 烟囱式结构：使用率低、部署不灵活、管理成本巨大
- 冰山模式：表面（小额新设施建设）+深层（大额人员支出/设施维护）
- IT基础架构发展的*三个阶段*：
	- 整合：降本增效
	- 虚拟化：增加弹性/效率和使用
	- 自动化：支持业务

虚拟化定义（P10-11/65）：
- 表示计算机资源的抽象方法

虚拟化的常见类型（P12-18/65）：
- 常见类型：
	- 基础设施虚拟化：网络虚拟化（VLAN/VPN/SDN）、存储虚拟化（基于存储设备：磁盘阵列；基于网络：NAS/SAN/Hadoop）
	- 系统虚拟化：虚拟机（服务器虚拟化/桌面虚拟化）
	- 软件虚拟化：高级语言虚拟化（JVM）、应用程序虚拟化（App与OS解耦）
- 技术分类：应用程序级/编程语言级/程序库级/OS级/指令级/硬件级

服务器虚拟化关键技术（P19-/65）：
- since 1960'（利用珍贵的计算资源）->80'/90'（暂冷）->now（重新火热）
- 体系结构（P25）
- 虚拟机系统=裸机+VMM层：VMM（虚拟机监控软件）、VM（虚拟机软件）、host OS（宿主机）
- 实现技术分类：
	- 全虚拟化：特权指令拦截机制，开销大
	- 泛虚拟化：修改内核使其支持VM运行在机器级，需要改内核
	- 硬件辅助虚拟化：添加权限更高的根模式，依赖硬件支持
- VMM分类（P30）：
	- 宿主型：VMWare Workstation、KVM
	- 独立监控型：Xen
- VMM实现技术（P33）：
	- CPU虚拟化：仿真执行特权指令
		- 硬件CPU虚拟化：硬件完成ring切换，如Intel VT-x、AMD-V
	- 内存虚拟化：VMM必须直接控制物理内存
		- 影子页表
	- I/O虚拟化

主流虚拟化软件/技术实践（P43-/65）：
- 主流虚拟化软件：
	- VMWare
	- Xen VMM：完全/半虚拟化
- 硬件虚拟化支持：
	- Intel：VT-x（处理器辅助）、VT-d（直接I/O）、VT-c（网络辅助）、TXT（可信执行）

### 0.4-虚拟化关键技术

- 系统虚拟化主要作用
- CPU虚拟化
- 内存虚拟化
- I/O虚拟化

虚拟化主要作用：隔离、合并、迁移、个性化

CPU虚拟化（P2-15/35）：
- 本质：每个虚拟机使用一或多个vCPU，vCPU使用CPU
- *Xen Credit额度调度算法*：
	- 威胁：拒绝服务攻击、信息泄露
	- 软件解决：客户端降权
- 虚拟化挑战：机内对外不知情、VMM提供接口/保护虚拟机/使虚拟机彼此独立
- 硬件辅助CPU虚拟化：引入新指令和CPU运行模式，使VMM与guest OS在不同模式运行
- Intel VT-x：
	- VMX root模式：拥有全部权限，运行VMM
	- VMX non-root模式：运行guest OS，权限受限
	- VMX指令集
	- 虚拟机控制结构（VMCS）

内存虚拟化（P16-25/35）：
- 三层地址结构：机器地址（真实地址）-物理地址（VMM抽象的伪物理地址）-虚拟地址（guest OS提供程序的地址）
- 页表虚拟化：
	- MMU泛虚拟化：直接将复合映射写入guest OS页表
	- 影子页表：guest OS的页表对应一个影子页表
- 内存虚拟化优化机制：
	- 按需取页与虚拟存储：两种方案
		- VMM层实现内存换页
		- 虚拟机间实现气球驱动（balloon driver），动态调控guest OS可用的物理内存
	- 内存共享（页面写时复制）：共享页面只读，修改前必须复制
	- 内存可写工作集：频繁被修改的内存作为工作集
	- 硬件辅助内存虚拟化：
		- Intel VPIDs（虚拟处理器标识）：在TLB中添加vCPU编号标记不同的CPU地址空间，避免VM切换时TLB大规模失效
		- Intel EPT（扩展页表）：从硬件上进行页表再映射，解决x86只能映射一次页表的缺陷，允许影子页表实现

I/O虚拟化（P26-35/35）：
- 两种方式：
	- 模拟I/O设备：对VM模拟I/O设备行为，兼容强性能差
	- 额外软件接口：对VM提供直通设备接口，性能高兼容差
- Intel VT-d：
	- 解决问题：提供guest OS直接访问硬件的机制，降低物理CPU负载
	- 优势：几乎完全消除了VMM中运行驱动程序的需求
	- 设计：
		- 关键：解决DMA和IRQ中断请求
		- DMA重映射：实现IOMMU用于保护多个DMA区域
		- 中断重映射：通过重新定义MSI（消息终端）解决中断隔离问题，MSI中现在指定DMA区域ID而非物理地址，避免未授权的内存写入

乐。——241029

## sec1-安全概念和标准

