
## 框架

- 存储器概述
	- 分类：
		- 按层次分类：主存储器、辅助存储器、高速缓冲存储器
		- 按介质分类：磁表面存储器、磁芯存储器、半导体存储器、光存储器
		- 按存取方式分类：RAM、ROM、串行访问存储器
	- 性能指标：存储容量、单位成本、存储速度
	- 多级层次的存储系统
		- 目的：解决大容量、高速度和低成本3个相互制约的矛盾
- 主存储器
	- **SRAM和DRAM**
	- 只读存储器（ROM）
	- 主存储器的基本组成
	- 多模块存储器：
		- 单体多字存储器
		- 多体并行存储器：高位交叉编址、低位交叉编址
- 主存储器和CPU的连接
	- 连接原理
	- 主存容量扩展
	- 存储芯片的地址分配和片选
	- 存储器与CPU的连接
- 外部存储器
	- 磁盘存储器
	- 固态硬盘
- 高速缓冲存储器
	- 程序访问的局部性原理
	- Cache的基本工作原理
	- Cache和主存的映射方式
	- Cache中主存块的替换算法
	- Cache写策略
- 虚拟存储器
	- 基本概念
	- 页式虚拟存储器
	- 段式虚拟存储器
	- 段页式虚拟存储器
	- 虚拟存储器和Cache的比较

## 存储器的性能指标

**存储容量**：存储字数\*字长（如1M\*8B）。
- 存储字数：存储器的地址空间大小。
- 字长：一次存取操作的数据量。

**单位成本**：总成本/总容量。

**存储速度**：
- 存取时间（$T_a$）：从启动一次存储器操作到完成该操作经历的时间。
- 存取周期（$T_m$，读写周期、访问周期）：存储器进行一次完整读写操作所需全部时间，即连续两次独立访问存储器操作（读或写操作）之间所需的最小时间间隔。
- 主存带宽（$B_m$，数据传输率）：数据传输率=数据宽度/存储周期。
- **关系**：存取周期=存取时间+恢复时间

## SRAM和DRAM

### DRAM工作原理

**刷新周期**：DRAM是基于电容的存储器，每隔约一段时间就必须刷新一次电荷，否则信息会消失。一般取2ms。

**刷新方式**：
- 集中刷新：一个刷新周期内设置一段固定时间，不接受访存请求，只刷新存储器。
- 分散刷新：把每行的刷新分散到各个工作周期中，每个工作周期中一小段时间用于刷新。
- 异步刷新：将刷新周期除以行数，得到两次刷新的时间间隔，在硬件层次上每隔这个时间便发出一次刷新请求。

**地址复用技术**：如无特殊说明，DRAM一般采用将地址分两个周期传输的方法，因此引脚数减半。SRAM不使用该技术。

### 比较

![[Pasted image 20230924145535.png]]

## 多体并行存储器

### 高位交叉编址（顺序方式）

![[Pasted image 20230924151755.png]]

高位地址表示**存储体号**，低位地址为**体内地址**。

缺点：各模块并不能被并行访问，不能提高存储器的吞吐率。

### 低位交叉编址（交叉方式）

![[Pasted image 20230924152013.png]]

低位地址为**存储体号**，高位地址为**体内地址**。

特点：可以实现流水线式并行存取。

## 主存容量的扩展方法

### 位扩展法

CPU的数据线数和存储芯片的数据位数不等，则必须扩位。通过将一个字的不同位存储在不同的芯片，使存储体的数据位数和CPU的数据线数相等。（**基于字长的分划**）

![[Pasted image 20230924172804.png]]

### 字扩展法

位数不变，只增加存储器中字的数量。一般选地址总线中的最高几位作为片选信号的原始信号。（**基于字数的分划**）

![[Pasted image 20230924173152.png]]

上图的A15、A14作为片选信号的原始信号，通过译码器生成片选信号。

**片选信号产生的两种方法**：
- 线选法：不译码，N根片选线表示1个片选信号。
- 译码片选法：$\log_2 N$根片选线表示1个片选信号，需要引入译码器。

### 字位同时扩展法

既扩展存储器的字长，也扩充存储器的字数。

![[Pasted image 20230924173854.png]]

## 几种外部存储器

**磁盘存储器**：详见[[OS05-IO管理#磁盘结构]]。

**磁盘阵列**：RAIDx。

**固态硬盘**：基于闪存技术的存储器，容量比U盘更大，存取性能更佳。
- 优点：随机访问快，无机械噪声和震动，能耗更低，抗震性更好，安全性更高。
- 缺点：易磨损，随机写很慢。

## Cache和主存的映射方式

设Cache行数为N，主存块数为M，主存块大小等于Cache行。

### 直接映射

主存中的每一块装入Cache的位置都是唯一的。如果Cache位置已有内容，则发生块冲突，内容被无条件替换出去：
$$
I_c=I_m\bmod N,0\le I_m<M
$$

![[Pasted image 20230924204800.png]]

特点：
- 实现简单。
- 不够灵活，冲突概率最高，空间利用率最低。

### 全相联映射

主存中每一块可以装入Cache中的任何位置，每行标记用于指出该行取自主存的哪一块。CPU访存需要与所有Cache行的标记进行比较。

![[Pasted image 20230924210325.png]]

特点：
- 冲突概率低，空间利用率高，命中率也高。
- 标记的比较速度较慢，实现成本较高。

### 组相联映射

将Cache分为$Q$个大小相等的组，主存中的每个块只能装进某个特定组，但组内装进哪个块是任意的：
$$
I_q=I_m\bmod Q
$$

![[Pasted image 20230924211951.png]]

Q=1时为全相联映射，Q=M时变为直接映射。若每组行数为K，则映射方式也称为**K路组相联映射**。

**地址结构**：
- 标记：高位地址，用于在Cache组内标识内存块。
- Cache组号：中间位地址，用于表示内存块映射到的Cache组编号。
- 块内地址：低位地址，用于描述块内偏移值。

## Cache的基本工作原理

**基本职能**：
- 数据查找：判断数据是否在Cache中。
- 地址映射：主存块如何存放在Cache中，如何将主存地址转换为Cache地址。
- 替换策略：Cache满后，如何淘汰旧的Cache块。
- 写入策略：如何既保证主存块和Cache的数据一致性，又尽量提升效率。

### 命中率和访存时间的关系

命中率$H$表示CPU欲访问的信息在Cache中存在的概率。设访问一次Cache时间$t_c$，访问一次主存时间$t_m$，则单次访存时间$T_a$：
$$
T_a=Ht_c+(1-H)t_m
$$

### 主存块的替换算法

- 随机算法（RAND）：随机确定。
- FIFO：队列类算法，选择最早调入的行进行替换。局部性差。
- LRU：**堆栈类算法**，选择近期内最久未访问的Cache行作为替换的行。局部性强，命中率略高。
- LFU：选择最不频繁使用的Cache行作为替换的行。

### 写策略

**写命中的两种处理方法**：
- 全写法：访存命中时，同时写入主存和Cache。
- 回写法：只有块被换出时才写回主存。

**写不命中的两种处理方法**：
- 写分配法：加载块进入Cache，再更新它。
- 非写分配法：只写入主存，不调块。

## 虚拟存储器

参考[[OS03-内存管理#虚拟存储器性能影响因素]]。

### 页式虚拟存储器

![[Pasted image 20230925102044.png]]

机制：
- 页表
- 快表（TLB）

### 具有TLB、Cache的多级存储系统

**结构**：
- TLB：全相联快表，存储地址映射关系。
- Cache：二路组相联，存储数据。

**访存情形**：
- 根据虚拟地址VA查TLB。
- TLB命中：
	- 根据TLB中的物理地址查Cache。
- TLB缺失：
	- 访问主存中的页表。
	- 页表在主存：更新TLB并将VA转换为物理地址。
	- 页表不在主存：调入页表，更新页表和TLB，转换为物理地址。
	- 查Cache。
- 查Cache：
	- Cache命中：访问Cache存取数据。
	- Cache缺失：调入对应主存块，再访问Cache。

![[Pasted image 20230925110458.png]]

**五种可能的缺失组合**：注意如果TLB和Cache中至少一个命中，其对应数据在主存便不会缺失。
![[Pasted image 20230925110555.png]]

### 段式、段页式虚拟存储器

WIP

## 解题

### RAM芯片的引脚数量计算

引脚数量：
- 数据线：等于存储字长。
- 地址线：
	- DRAM：等于地址空间位数的一半（地址复用技术）。
	- SRAM：等于地址空间位数。
- 控制线：
	- 片选线：SRAM一根，DRAM两根（行通选线和列通选线）。
	- 读写控制线：一般为读、写两根，具体以题目为准。

### Cache地址映射表大小计算

地址映射表大小=块数\*映射项。

映射项长度：
- 标记位，记录与该Cache块对应的内存块的高位地址。
- 有效位。
- 一致维护和替换算法位。

## 选择题整理-非真题

### 3.1-存储器概述

![[Pasted image 20230924135451.png]]

1题选D。三种存取顺序：
- 随机存取：同一时间访问任一组件。
- 顺序存取：从存储器的头部顺序查找读写位置。
- 直接存取：存储部件确定读写区域的大致范围，在该范围内顺序查找并存取。
磁盘属于**直接存取设备**，选D。

2题选C。D项是存取时间，并不是完整的存取周期（还包括恢复时间）。

![[Pasted image 20230924135501.png]]

4题选D。涉及到后面的概念。

![[Pasted image 20230924135514.png]]

13题选A。第二和第三个说法都是错误的：
- 第二个说法，只对应用级程序员透明。主存和辅存之间的数据调动是由硬件和操作系统协调完成的，对操作系统程序员并不透明。
- 第三个说法，CPU和主存**可以直接交换信息**，这一般发生在Cache不命中的情形下。

### 3.2-主存储器

**这部分题目很重要。**

![[Pasted image 20230924152845.png]]

1题选A。地址线10根，数据线8根，控制线（片选线、读控制线、写控制线）3根，总计21根。

![[Pasted image 20230924153026.png]]

7题选C。注意，DRAM也**不会丢信息**，因为DRAM会自行刷新。

![[Pasted image 20230924153035.png]]

9题选B。共有以下17根引脚：
- 地址线5根：原10根，因地址复用技术（地址分两个周期传输），地址引脚减半。
- 数据线8根。
- 片选线2根：DRAM分行通选线和列通选线两根。
- 读写控制线2根。

![[Pasted image 20230924153123.png]]

11题选C。U盘本质上是ROM，虽然它支持多次读写，但并不能和RAM一样高速读写，只能充当外部存储。

![[Pasted image 20230924153135.png]]
![[Pasted image 20230924153144.png]]

14题选C。第一个说法是错的，第二个说法是对的。一次完整刷新耗费一个存储周期。

![[Pasted image 20230924153300.png]]

17题选C。本题必须注意到，N体低位交叉存储器支持并行度为N的读写。所以：读取6个或者8个连续地址单元中存放的存储字均耗费2个存储周期。因此两种操作的耗费时间等于重复次数的比值，即4:3。

18题选B。本题争议较大。下面是知乎答主对第一个说法的解释：

> [!question] 为什么高位多体交叉存储器不能满足程序的局部性原理？
> 局部性指的是你刚刚访问了它，那么大概率很快要继续访问它。高位是在一个存储模块里连续存放，这就造成你要一直访问同一个存储模块，最坏的话存一次就要等完整的一个存取周期才能继续访问下一次，这显然太慢了。而低位的话就算一直重复访问一段连续的地址，因为是交叉存放的，显然比高低等待的时间要少的多。

第二个说法，高位四体交叉存储器不能满足程序的连续读取，但仍然可能一次连续读出彼此地址相差一个存储体容量的四个字（M、N+M、2N+M、3N+M）。

第三、四个说法，双端口存储器有两套独立的读写口，可以同时访问一个存储单元，只要不同时写就不会发生冲突。第三个说法正确，第四个说法错误。

### 3.3-主存储器和CPU连接

![[Pasted image 20230924191908.png]]

7题选A。容易误选C。注意题目中强调了高位在A0侧，尽管地址线确实有14根，但它们却是`A2,A3`两根，而不是`A12,A13`两根。最高位的两根地址线未使用。

![[Pasted image 20230924191922.png]]
![[Pasted image 20230924191935.png]]

11题选D。图中译码器的逻辑表达式是：
$$
\overline{CS}=\overline{A_{19}(A_{18}+A_{17})A_{15}A_{13}A_{12}}
$$
- A项，高位二进制为10101011，CS=1。
- B项，高位二进制为10111011，CS=1。
- C项，高位二进制为11101111，CS=1。
- D项，高位二进制为11111110，CS=0。
综上，不属于译码空间的地址为`FE000H~FEFFFH`。

### 3.4-外部存储器

![[Pasted image 20230924195518.png]]

3题选D。SSD随机写比较慢，容易磨损。

4题截图截重复了，看真题部分。

### 3.5-Cache

![[Pasted image 20230924215336.png]]

10题选C。容易误选B，注意在虚拟存储器中CPU发送的才是虚拟地址，这里没指出是虚拟存储系统。

![[Pasted image 20230924215348.png]]

14题选C。一次Cache缺失需要一次总线事务，每次总线事务需要1+8+1个周期，交换64B则需要8次总线事务。总共需要80个时钟周期。

15题选A，主要考察突发传输。突发传输下，64B可在一次突发传输中传送完毕。8个总线事务并行，总耗时为1+8+8=17个时钟周期。

### 3.6-虚拟存储器

N/A

## 选择题整理-真题

![[Pasted image 20230924153327.png]]

21题选A。闪存本质上是EEPROM存储器的进一步发展，其读取速度高于写入速度。

22题选A。注意：256MB存储器是个干扰信息，与DRAM芯片的引脚数无关；本题的DRAM默认采用地址复用技术，地址线减半：
- 8根数据线。
- 11根地址线。地址空间有22位，分两次传输则需要11根引脚。

![[Pasted image 20230924153338.png]]

25题选C。这道题易错选B，细节极多。由交叉编址方式得知，最低两位为存储体编号。变量`x`的主存地址为`804001AH`，其最低两位为`10`，说明变量的始址在第三个存储器。读取该变量需要三轮：
- 第一轮：从第三、四个DRAM芯片读取`804001AH`和`804001BH`两个字节。
- 第二轮：从所有DRAM芯片分别读取`8040001CH~804001FH`四个字节。
- 第三轮：从第一、二个DRAM芯片读取`8040020H`和`8040021H`两个字节。
总共需要3个存储周期。

26题选C。C项，DRAM采用地址复用技术，芯片的地址引脚数量为地址空间位数的一半，即13根；D项是正确的。

![[Pasted image 20230924215247.png]]

4题选B。读取时间分为三个部分：
- 寻道时间：平均为6ms。
- 延迟时间：盘片转到读取位置的期望时间为3ms，延迟为0.2ms，总共3.2ms。
- 读取时间：4KB/20(MB/s)=0.2ms。
总共9.4ms。

![[Pasted image 20230924195903.png]]

6题选B。存取时间分为三个部分：
- 寻道时间：平均为8ms。
- 延迟时间：由转速为7200r/min，得知转半圈大约是4.167ms。
- 存取时间：磁臂在一个扇区停留的时间是转一圈的时间除以1000，即约0.008ms。
总共约12.175ms，即约12.2ms。

![[Pasted image 20230924215405.png]]
![[Pasted image 20230924215418.png]]

18题有争议，按旧版的组相联定义选C，新版教材应该选A。

![[Pasted image 20230924215434.png]]

20题选C，易错选D。要注意题目的`a[k]=a[k]+2`本质是两次访存，第一次读取，第二次写入，因此虽然在25%的循环节发生了缺失事件，但从访存操作的角度来看，只有12.5%的操作引发了缺失事件。

![[Pasted image 20230924215628.png]]

23题选A。题中所述Cache有64组，每组8个块，总计512个块；地址结构为20位标记、6位组号、6位块内偏移，因此比较器位数为20位。通过组号定位到对应的组后，用8个比较器分别和组内8个块的标记作比较，因此需要8个比较器。

![[Pasted image 20230925110703.png]]
![[Pasted image 20230925110712.png]]

9题选D。只要Cache或TLB命中，Page就不会存在不命中的情形。

![[Pasted image 20230925110826.png]]

11题选B，易误选C。注意x可能已经存在于Cache，所以不一定要通过访问主存读取。但写入则需要访问一次主存。

![[Pasted image 20230925110841.png]]

15题选C，易误选A、D。注意左侧的虚页号是**十进制数**，而地址上的`082`则是十六进制数，因此对应着130的虚页号。该页在主存的物理页框号是`018H`，因此转换得到的主存地址是`018840H`，选C。

选A的可能原因是，既没有进行十到十六进制转换，也没有关注存在位为0的事实。选D的可能原因是，注意到存在位为零，可惜没有进行十到十六进制转换。

## 大题整理

### 2010：Cache容量计算、命中率分析

![[Pasted image 20230925111643.png]]

第一问，每行的数据部分有64B，还包括存在位和标记位（题目规定，其他控制位不考虑）总共20位，因此总容量为：
$$
C=8\cdot(64+20/8)=532\text{B}
$$

第二问，`a[0,31]`的地址为444，对应编号为6的Cache行；`a[1,1]`的地址为1348，对应编号为5的Cache行。

第三问，每个Cache行可容纳16个int变量，对A程序而言，每遍历16个int会引发一次Cache缺失，因此命中率为`15/16=93.75%`；对B程序而言，每次遍历都不会命中，即命中率是零。执行时间更短的是程序A。

### 2013：指令执行的耗时分析（难！）

![[Pasted image 20230925111653.png]]
![[Pasted image 20230925111705.png]]

第一问，CPU周期为1.25ns，总线周期为5ns。总线带宽为800MB/s，注意不能用突发传送的数据率计算。

第二问，需要一个读突发传送事务。

第三问，一次读突发传送总线事务包括一次地址传送和32B数据传送：
- 1个总线时钟周期传送地址。
- 每隔5ns启动一个存储体工作，每个存储体用40ns（存储器的存储周期）读一个字，用5ns传输一次数据。总共耗时80ns。
因此总共耗时85ns。

第四问，一条指令执行的平均耗时分以下两个部分：
- 基本耗时：Cache命中情形下平均耗费4个CPU时钟周期，耗时4\*1.25=5ns。
- 缺失耗时：由Cache缺失引入的耗时。由于平均访存为1.2次，缺失率为5%，所以Cache缺失引入的耗时期望为1.2\*5%\*85ns=5.1ns。
总共10.1ns，因此100条指令的总执行时间为1010ns。

### 2016：TLB与Cache存储体系、写策略

![[Pasted image 20230925111720.png]]

第一问，页内偏移占11位，因此D=13，C=11，A=19。TLB的标记位数和A宽度等同，因此B=19。Cache块大小为64B，块内地址宽度为6，即G=6；Cache组有512组，组号宽度为9，即F=9，由于物理地址为24位，所以E=9。

TLB标记字段中的B存放的是虚页号，表示TLB项对应哪个虚页的页表项。

第二问，组号为3，标记字段的内容为8。

第三问，缺页处理的时间开销大，因为缺页需要访问磁盘，将对应的页调入，而Cache缺失是从主存调块到Cache。

第四问，直写策略需要同时写快速存储器和慢速存储器，速度由慢速存储器读写速度决定。采用直写策略对Cache性能的冲击没那么大，但对主存-磁盘存储体系的冲击就很大，因此后者必须使用回写策略。

### 2020：Cache缺失问题

![[Pasted image 20230925111733.png]]

第一问，标记位有20位，LRU位有3位。由于是直写策略（写Cache同时写主存），所以不设修改位。

第二问，缺失次数为64次。

第三问，过程如下：
- Cache解析该地址得到Cache组号0，块内偏移值3，标志位10H。
- Cache将标志位10H与第0组的所有块逐一对比。
- 由于Cache初始为空，所以必定发生Cache缺失事件。
- 将从地址`00010000H`开始的主存块存入Cache第0行中的任意一块。
- 访问Cache，取走偏移值为`03H`处的指令。

### 2011：

![[Pasted image 20230925111749.png]]
![[Pasted image 20230925111801.png]]

第一问，虚拟地址24位，后12位表示虚页号；物理地址20位，高8位表示虚页号。

第二问，划分为主存字块标记、Cache字块标记、块内地址三部分。块内地址5位，字块标记3位，主存字块标记12位。

第三问，页面在主存，物理地址是04C60H。访问Cache不命中，原因是被其他物理块占用。

第四问，存在于主存中，对应TLB的第0组，与第3行标记为012的TLB项匹配。

### 2018：TLB与Cache存储体系

![[Pasted image 20230925111822.png]]
![[Pasted image 20230925111832.png]]

第一问，虚地址映射后的物理地址有28位。

第二问，TLB采用全相联映射。用SRAM实现。

第三问，Cache采用组相联映射。还需要修改位、一致维护和替换算法位。从题目中看出Cache中有2行8组，因此总共16个Cache块，每个块有32B数据容量，还有1个LRU位、1个存在位、1个修改位和20个标志位。总计558B。有效位的作用是指出某个Cache行的信息是否有效。

第四问：
- 物理地址是0040040H，在Cache不命中，因为虽然有一个第2组的Cache块有相同的标志，但其有效位是0。
- 虚拟地址0007C260H映射到的Cache组号为3。

### 2021：TLB组相联

![[Pasted image 20230925111844.png]]

第一问，高18位表示虚页号，低12位表示页内地址。

第二问，由于TLB设8个组，所以高15位为TLB标记，低3位表示TLB组号。

第三问，虚页号为4对应的TLB表项被换出。映射到第4组的虚页号有4、12、20，其中4是最近访问最少的。

第四问，TLB表项会增加两位。