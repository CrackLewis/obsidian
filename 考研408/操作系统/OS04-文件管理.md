
## 框架

- 文件系统基础
	- 文件的基本概念
	- 文件控制块和索引节点
	- 文件的操作
	- 文件保护
	- 文件的逻辑结构
	- 文件的物理结构
- 目录
	- 目录的基本概念
	- 目录结构
	- 目录的操作
	- 文件共享
- 文件系统
	- 文件系统结构
	- 文件系统布局
	- 外存空闲空间管理
	- 虚拟文件系统（VFS）
	- 分区和安装

## 文件信息和文件控制结构的关系

**文件属性**：
- 名称、类型。
- 创建者、所有者。
- 位置、大小。
- 保护信息。
- 创建时间、最后一次修改时间和最后一次存储时间。

**FCB信息**：
- 基本信息：文件名、逻辑和物理结构、物理位置。
- 存取控制信息：各类用户的存取权限。
- 使用信息：文件建立和修改时间。

**磁盘索引结点信息**：类型、存取权限、物理地址、长度、存取时间、链接计数。

**内存索引结点信息**：索引结点编号、状态、访问计数、逻辑设备号、链接指针。

## 文件结构

### 逻辑结构

- 无结构文件（流式文件）
- 有结构文件（记录文件）
	- 顺序文件：串结构、顺序结构
	- 索引文件：
	- 索引顺序文件
	- 直接文件或散列文件

### 物理结构

- 连续分配
- 链接分配：隐式链接、显式链接
- 索引分配：对每个文件设置索引块。
- 混合索引分配：UNIX方式（一级、二级索引）。

比较：详见物理分配方式比较

## 文件操作

WIP

## 文件共享

**硬链接**：多个指针指向一个索引结点，保证只要有指针指向结点，索引结点便不删除。

**软链接**：把到达共享文件的路径记录下来。访问文件时，通过路径查找。

## 外存空闲空间管理

- 空闲表法
- 空闲链表法
- 位示图法
- 成组链接法

## 三种文件物理分配方式的比较

![[Pasted image 20230913213641.png]]

## 文件的打开方式

![[Pasted image 20230913213654.png]]

## 真题选择错题

![[Pasted image 20230919010453.png]]

答案选A。read系统调用一般接受文件描述符，而不是文件名，所以第三个说法是错的。

![[Pasted image 20230919010502.png]]

答案选A。索引结点数和文件长度无关。

![[Pasted image 20230919010514.png]]

36题选B。偏移值1234可通过第二个直接索引指针访问，偏移值307400需要通过二级索引指针访问。

37题选D。不要过多延申到其他系统的习惯，题目规定了4类用户5类权限，则权限位应当是20位。

38题选D。第二个说法中分配连续簇的好处是，省去了寻道时间和旋转时间。

![[Pasted image 20230919012218.png]]

答案选B。软链接直接复制原文件的引用计数，硬链接则将引用计数加一。删除文件时，删除操作对软链接不可见，对硬链接则必须将引用计数减一，如果引用计数不为零，则不能删除文件（存在其他硬链接）。

F2在产生时复制F1的引用计数，引用计数值始终为1；F3在产生时引用计数为2，删除F1后，F3引用计数减为1，其指向的文件并未删除。

![[Pasted image 20230919012229.png]]

答案选B。系统打开文件表是系统设施，而系统对单个文件只会打开一次。A项是错的，各进程都可以读写文件，互斥性由进程自行通过加锁操作来保证。

## 真题大题

### 2011：

![[Pasted image 20230913225607.png]]

第一问，连续存放方式最适合，因为数据不会被修改，而是会一次写入完毕。采用连续存放方式，磁盘寻道时间最短，文件随机访问效率最高。FCB中相关字段为：起始盘块号、盘块长度。

第二问，FCB集中存放更佳。这样随机查找文件只需遍历FCB区，而不需要连带遍历文件数据区。

### 2012：

![[Pasted image 20230913225644.png]]

第一问，磁盘块号至少占据4字节，可支持的单个文件最大大小为128KB。

第二问，直接索引结构有84个索引盘块，连续索引字段可以索引2^16个连续盘块，总共为`64MB+84KB`。

### 2014：

![[Pasted image 20230913225655.png]]
![[Pasted image 20230913225705.png]]

第一问，由于前后均有足够空间，所以考虑将记录前移。前29条记录分别需要前移一个盘块，每个盘块移动需要一次读取、一次写入，总共58次；第30条记录写入需要一次写入，因此总计59次。

第二问，通过29次访问找到第29个磁盘块，用一次访问将第30条记录写入一个新盘块，用一次操作修改第29个盘块的链接指针，总计操作31次。

### 2016：FAT表

![[Pasted image 20230913232512.png]]

第一问，两个目录文件的内容为：
![[Pasted image 20230916222828.png]]

第二问，簇号使用2字节存储，FAT的最大表项是2^16=65536个，所以FAT表的最大大小是`65536*2B=128KB`，文件的最大大小是`65536*4KB=256MB`。

第三问，FAT是链式索引机制，每个FAT表项内存放下一个簇号。所以106簇号存放在第100项，108簇号存放在第106项。

第四问，`dir/`目录文件已读入，所以直接找到`dir/dir1/`目录文件在48号簇，第一次读入；在该目录文件下找到`dir/dir1/file1`文件，拿到第一个簇号100。但由于要读取的第5000号字节在第二个簇，所以查FAT表得到第二个簇号106，进行第二次读入，读入完毕。因此要访问48、106两个簇。

### 2018：

![[Pasted image 20230913232524.png]]

第一问，每个间接索引簇可以存储`4KB/4B=1024`个簇号，最大文件长度`4KB*(8+1024+1024^2+1024^3)=32KB+4MB+4GB+4TB`。

第二问，文件索引结点区的文件数上限是64M个，一个图像文件的内容占用两个簇，而文件区最多可以容纳256M个这样的文件。所以文件系统最多可存放64M个这样的文件。

第三问，不同。F1的最后一个簇号在第二个直接地址项，F2的最后一个簇号在一级间接地址项索引的间接索引簇的第二项。前者索引时间小于后者。

### 2022：

![[Pasted image 20230913232539.png]]
![[Pasted image 20230913232555.png]]

第一问：
![[Pasted image 20230916230825.png]]

第二问，通过观察`course1`和`doc`两个文件的索引结点号，得知两个文件表示同一文件，因此磁盘块号也为30。

第三问，先读入`course1`索引结点所在的磁盘块，再读入`course1`文件内容对应的30号磁盘块，总共读取两个。

第四问，文件使用1536个磁盘块，会使用到二级间接索引项。