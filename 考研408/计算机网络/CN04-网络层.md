
## 主要内容

- 网络层的功能
	- 异构网络互连
	- 路由和转发
	- SDN基本概念
	- 拥塞控制
- 路由算法
	- 静态路由与动态路由
	- 距离-向量路由算法
	- 链路状态路由算法
	- 层次路由
- IPv4
	- IPv4分组
	- IPv4地址与NAT
	- 子网划分与子网掩码
	- CIDR
	- 路由聚合
	- ARP
	- DHCP与ICMP
- IPv6
	- IPv6的主要特点
	- IPv6地址
- 路由协议
	- 自治系统
	- 域内路由与域间路由
	- RIP路由协议
	- OSPF路由协议
	- BGP路由协议
- IP组播
	- 组播的概念
	- IP组播地址
- 移动IP
	- 移动IP的概念
	- 移动IP的通信过程
- 网络层设备
	- 路由器的组成和功能
	- 路由表与路由转发

## 网络层的功能

网络层的设计思路：向上提供简单灵活、无连接、尽最大努力交付的数据报服务。

设计思路的好处：降低网络造价，运行方式灵活，能够适应多种应用。

### 异构网络互连

网络互连：将两个以上的计算机网络，通过一定方法，用一些中间设备（**中继系统**）连接起来，以构成更大的网络系统。

中继系统分类：
- 网络扩大系统：
	- 物理层中继系统：转发器，集线器。
	- 数据链路层中继系统：网桥或交换机。
- 网络互连系统：
	- 网络层中继系统：路由器。
	- 网络层以上的中继系统：网关。

**虚拟互连网络**（逻辑互连网络）：互连起来的各种物理网路的异构性客观存在，但通过网络层协议可以使这些性能各异的网络看起来是一个统一的网络。
- **IP网络**：在网络层使用IP协议的虚拟互连网络。
- 好处：屏蔽了各网络的异构细节，简化通信流程。

### 路由与转发

路由器的两个主要功能：
- 路由选择：按照复杂的分布式算法，根据从各相邻路由器得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
- 分组转发：根据转发表将IP数据报从合适的端口转发出去。

### SDN的基本概念

**软件定义网络**（Software Definition Network，SDN）：
- 结构：两个由控制-数据接口连接的分离平面
	- 控制平面：集中式，远程控制器通过软件和接口对数据平面的路由器集中控制
	- 数据平面：分布式，各路由器根据远程控制器维护的路由表进行分组转发
- 接口：
	- 北向接口：SDN对上层应用开发者提供的编程接口。
	- 南向接口：SDN控制器通过南向接口协议（如Openflow）与转发设备建立双向会话的接口。
- 优点：
	- 全局集中式控制和分布式高速转发：利于控制平面的全局优化，也利于高性能的网络转发。
	- 灵活可编程与性能的平衡：控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置。
	- 降低成本：控制与数据平面分离后，可以实现网络设备制造和功能软件开发的分离，降低成本。
- 问题：
	- 安全风险：集中管理易受攻击，如果崩溃将影响整个网络。
	- 瓶颈问题：随着网络规模扩大，控制器可能成为网络性能的瓶颈。

![[Pasted image 20230701103443.png]]

### 拥塞控制

拥塞：在通信子网中，因出现过量分组而引起网络性能下降的现象。

判断网络拥塞的方法：观察网络的吞吐量和负载的关系。
- 吞吐量偏低：轻度拥塞
- 吞吐量低：拥塞
- 吞吐量为零：死锁

**拥塞控制**：
- 解决的问题：如何获取网络中发生拥塞的信息，并利用信息进行控制，以避免由于拥塞造成分组的丢失，以及严重拥塞引发的网络死锁现象。
- 与流量控制的区别：流量控制的核心思想是抑制点对点通信中的发送端，拥塞控制则确保网络内所有终端间的通信能力。
- 方法：
	- **开环控制**：静态方法，设计网络时事先考虑拥塞因素，而非考虑当前网络的状态，包括：确定何时可接收新流量、何时丢弃分组、丢弃哪些分组。
	- **闭环控制**：动态方法，事先不考虑拥塞因素，而是用监测网络系统检测拥塞，将拥塞信息传到合适的地方，以便调整网络的运行，并解决出现的问题。

## 路由算法

### 静态路由和动态路由

**静态路由算法**（**非自适应路由算法**）：网络管理员手工配置路由信息，当网络结构变更时需要手动调整。不能及时适应网络状态的变化。

**动态路由算法**（**自适应路由算法**）：路由器上的路由表项是通过相邻路由器间彼此交换信息，并按照一定算法优化出来的，会在一定时间内不断更新，以适应不断变化的网络。

比较：
- 静态路由算法：开销小，简便，适用于拓扑变化不大的小型网络。
- 动态路由算法：改善网络性能并有助于流量控制，但算法复杂，会增加网络负担。

两种常见的动态路由算法：距离-向量路由算法、链路状态路由算法。

### 距离-向量路由算法

原理：
- 所有结点都定期将它们的整个路由选择表发送给所有与之相邻的结点。路由选择表包含：每条路径的目的地（下一结点）、路径的代价（距离）。
- 所有结点都参与距离向量的交换，以保证路由的有效性和一致性。
- 所有结点监听路由选择更新信息，并在下列情形下更新路由表：
	- 添加本结点路由表中不存在的新路由。
	- 路由信息中有一条到达某目的结点距离更短的路由，则更新本表中的对应路由。

实质：迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短（最小代价）通路。

典型：RIP算法。

### 链路状态路由算法

原理：每个参与该算法的结点都有完全的网络拓扑信息，执行下列两项任务：
- 主动测试所有邻接结点的状态。
- 定期将链路状态广播给所有其他结点。

特征：
- **洪泛法**：路由器A通过所有端口向所有相邻的路由器x发送信息，每个相邻路由器x又将此信息发往其所有相邻路由器y（路由器A除外）。
- 链路状态：某个路由器所掌握的，相邻路由器信息以及对应链路的度量（费用、距离、时延、带宽等）。
- 只有链路变化时，路由器才会发送链路状态信息。

优点：
- 非迭代性：每个路由结点使用同样的原始状态数据独立计算路径，而非依赖中间结点的计算。
- 链路状态报文不加改变地传播，易于排障。
- 当一个结点从其他所有结点收到报文时，可以在本地立即计算正确的通路，保证一步汇聚。
- 由于链路状态报文只运载来自单个结点关于直接链路的信息，其大小与网络路由结点数无关，因此伸展性更好。

**与距离-向量路由算法比较**：
- 距离-向量路由算法：路由只与邻居交谈，但无所不谈（提供网络内其余所有结点的路由）。可能遇到环路情形。
- 链路状态路由算法：路由通过广播和网络内的其他路由交谈，但只谈自己邻居。

典型：OSPF算法。

### 层次路由

背景：网络扩大会导致路由表成比例增大，消耗路由器的资源，也会因为传输路由信息消耗网络带宽。

**路由选择协议**：
- 分类：
	- 内部网关协议（IGP）：域内路由选择，自治系统内使用的协议，如RIP或OSPF等。
	- 外部网关协议（EGP）：域间路由选择，两个自治系统间交换路由信息使用的协议，如BGP等。

## IPv4

IPv4：第四版IP协议。

大致内容：IP分组及其格式、分组相关规则。

### IPv4分组

#### IPv4分组的格式

结构：
- 首部：
	- 固定部分：必备，20B。
	- 可变部分：长度可变，0-40B。
- 数据部分

部分重要字段含义：
- 版本：4。
- 首部长度：4位，以32位为单位，最大为60B，最常用为20B（无可变部分）。
- 总长度：16位，包括首部和数据部分长度，理论最大为65535B，实际受数据链路层的最大传送单元（MTU）限制（如以太网帧的MTU为1500B）。
- 标识：16位，一种用于在分割过大的数据报后，记录数据报片所属原数据报编号的字段，方便接收端重组为IP数据报。
- 标志：3位，中间位DF（Don't Fragment）指示是否禁止分片，最低位MF（More Fragments）指示后续是否有分片。
- 片偏移：13位，指出较长的分组在分片后，某片在原分组中的相对位置，单位为8B。除了最后一个分片外，每个分片长度必是8的倍数。
- 生存时间（TTL）：8位，数据报可在网络中通过的路由器数的最大值。
- 协议：8位，此分组携带的数据使用何种协议，应上交给哪个协议处理。详见[IP协议号列表](https://zh.wikipedia.org/wiki/IP%E5%8D%8F%E8%AE%AE%E5%8F%B7%E5%88%97%E8%A1%A8)，常用：TCP=6，UDP=17。
- 首部校验和：16位，只校验首部。
- 源地址字段：4B，标识发送方IP地址。
- 目的地址字段：4B，标识接收方IP地址。

![[Pasted image 20230701142229.png]]

#### IP数据报分片

背景：数据链路层一般都会对帧的最大数据量进行限制，这个限制称为最大传送单元（Maximum Transmission Unit，MTU）。各段链路上采用的数据链路层协议不尽相同，因此MTU也不尽相同。这些MTU都对IP数据报的长度有限制。

流程：
- 当IP数据报的大小超过链路MTU时，需要将IP数据报中的数据分装在多个较小的IP数据报（称作**片**）中。
- 片在目的地的网络层被重新组装。组装使用IP首部的标识、标志和片偏移字段完成。
	- 标识字段：同一标识的所有数据报属于一个原始数据报。
	- 标志字段：
		- 如果DF=1，则说明该数据报不是片。
		- 如果DF=0，MF=1，则说明该数据报有后继数据报片。
		- 如果DF=0，MF=0，则说明该数据报是最后一个片。
	- 片偏移字段：指示数据报在原始数据报的哪个位置。

![[Pasted image 20230701145619.png]]

### IPv4地址与NAT

#### IPv4地址

IPv4地址：为每台连接到因特网上的主机（或路由器）分配一个32比特的全球唯一标识符。

**IP地址结构**：
- 网络号：标志主机连接到哪个网络。
- 主机号：标志某个具体的主机或路由器。

**五类IP地址**：

| 类别 | 范围 | 网络号位数 | 主机号位数 | 最大网络数 | 每个网络的最大主机数 |
| --- | --- | --- | --- | --- | --- |
| A | 1.0.0.0-126.255.255.255 | 8 | 24 | $2^7-2$ | $2^{24}-2$ |
| B | 128.0.0.0-191.255.255.255 | 16 | 16 | $2^{14}$ | $2^{16}-2$ |
| C | 192.0.0.0-223.255.255.255 | 24 | 8 | $2^{21}$ | $2^{8}-2$ |
| D | 224.0.0.0-239.255.255.255 | 不适用 | 不适用 | 不适用 | 不适用 |
| E | 240.0.0.0-255.255.255.255 | 不适用 | 不适用 | 不适用 | 不适用 |

D为轮播地址，E为保留地址。

**特殊含义的IP地址**：
- 表示本网络本身：主机号全为0。
- 表示本网络的广播地址：主机号全为1。
- 环回自检地址：127.x.x.x，表示主机自身，不会出现在任何网络上。
- 表示本网络上的本主机：0.0.0.0。
- 表示整个TCP/IP网络的广播地址：255.255.255.255。

**IP地址的重要特点**：
- 分等级：分为网络号和主机号。
	- IP地址管理机构只分配网络号，网络的对应单位分配主机号，方便IP地址的管理。
	- 路由器仅根据目的主机所连接的网络号转发分组，减小路由表占有的存储空间。
- 与主机和链路绑定：是标志一台主机（或路由器）和一条链路的端口。主机如果连接到多个网络，则对每个网络都需要一个该网络下的IP地址。
- 所有分配到网络号的网络都是平等的。
- 同一个局域网上的主机或路由器的IP地址中的网络号必须一致。
	- 用转发器或桥接器（网桥）连接的若干LAN属于同一个网络（同一个广播域），网络下所有IP的网络号相同，主机号不同。

#### 网络地址转换（NAT）

**网络地址转换**（NAT）：通过将专有地址转化为公共地址，从而对外隐藏内部管理IP地址的技术手段。

**私有IP地址**：只能用于局域网，不能在广域网上使用的IP地址。
- 特点：允许重用，又称可重用地址。
- 网段：
	- A类：10.0.0.0-10.255.255.255
	- B类：172.16.0.0-172.31.255.255
	- C类：192.168.0.0-192.168.255.255

**NAT原理**：
- 连接因特网的路由器内安装NAT软件，NAT软件维护一张从`[本地IP:端口]`到`[全球IP:端口]`的**NAT转换表**，初始时表为空。
- 用户主机请求访问Web服务器。
- NAT路由器收到IP分组后，为该IP分组生成一个新端口号，并将IP分组的源地址改为NAT服务器的全球地址，端口号改为新端口号。NAT转换表中新建一项，本地IP、端口填用户主机IP、端口，全球IP、端口填路由器全球IP、端口。
- Web服务器并不清楚NAT路由器的转发细节，认为该路由器是一个主机，并将响应分组发给NAT路由器。
- 响应分组到达NAT路由器后，通过NAT转换表填入对应的本地IP和端口，返回给用户主机。

特点：
- 节省IP地址的消耗。
- 隐藏了局域网的内部结构，降低了内部网络被攻击的风险。

![[Pasted image 20230701162642.png]]

### 子网划分与子网掩码、CIDR

#### 子网划分

背景：两级IP地址本身的缺陷。
- IP地址空间的利用率低。
- 给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏。
- 两级IP地址不够灵活。

**子网划分**：
- 本质：添加子网号字段，使两级IP地址变为三级IP地址。
- 基本思路：
	- 子网划分是网络单位内部的动作，对外部屏蔽细节。
	- 从主机号借用若干比特作为子网号，主机号减少相应的比特数。
	- IP数据报在到达本网络路由器之前，与不划分子网网络的IP数据报无异，在进入网络后，才会根据子网号找到子网。
- 特点：
	- 保守起见，子网划分应遵循传统IP地址规则的限制：子网号不应全0或全1，剩余的主机号也不应全0或全1。CIDR或许会容许违反该规则，但一般仍需注意。

#### 子网掩码

**子网掩码**：
- 与IP地址对应的、长32bit的二进制串，用于表达对原网络中主机号的借位。
- 由一串1和一串0组成，1表示网络号对应的位域，0表示主机号对应的位域。
- 与原网络内IP地址逐位与运算的结果即是网络号。
- 在无CIDR技术的情形下，必须伴随IP地址。

A、B、C类IP地址的子网掩码：
- A类：255.0.0.0
- B类：255.255.0.0
- C类：255.255.255.0

#### 无分类编址CIDR

**无分类域间路由选择**（Classless Inter-Domain Routing，CIDR）：
- 目的：基于变长子网掩码，消除网络类别的差异，实现超网构造。
- 网络前缀：位数可以不固定，表示IP地址的前多少位为网络号。
- 斜线记法：IP地址/网络前缀比特数，如192.168.1.1/24。
- 掩码：不再使用子网划分的概念，而是用掩码划分CIDR地址块。

CIDR地址块：一组网络前缀相同、主机号连续的IP地址。
- 路由聚合（构成超网）：一个CIDR地址块可以表示很多地址。
- 作用：增强路由表的功能，降低路由器负载和信息交换频率，提高网络性能。
- 地址数：2的若干次幂。

CIDR查找路由表的方法：将CIDR的路由表存放在一种层次式数据结构中，最常用二叉线索树。

CIDR优点：网络前缀长度灵活，降低路由负担。

#### 网络层转发分组的过程

路由器的转发表中的每一项必有两条信息：`[目的网络, 下一跳地址]`。

规则：
- 基于网络：分组转发基于目的主机的所在网络，因为网络数远小于主机数，可以极大压缩转发表的大小。
- 最长前缀匹配：使用CIDR时，会匹配公共前缀最长的目的网络地址。

两种特殊路由：
- 主机路由：对特定主机的IP地址专门指明一个路由`a.b.c.d/32`，用作控制或测试网络的用途。
- 默认路由：特殊前缀`0.0.0.0/0`表示默认路由，必定会和任何地址匹配，因此如果某个目的网络不在转发表中，则会落到该路由。

**路由器的分组转发算法**：
- 从收到的IP分组的首部提取目的主机的IP地址`D`（目的地址）。
- 若查找到特定主机路由（目的地址为`D`），则按照这条路由的下一跳转发分组，否则从转发表的下一条（即按前缀长度的顺序）开始检查。
- 将这一行的子网掩码和目标地址`D`进行按位与运算。如果和本行的前缀匹配，则查找结束，按照“下一跳”指出的进行处理（或者直接交付本网络的目标主机，或通过指定接口发送到下一跳路由器）。否则，如果转发表还有下一行，则检查下一行，重新执行本步骤。
- 如果转发表中有一个默认路由，则把分组传送给默认路由，否则报告出错。

### ARP、DHCP、ICMP

#### IP地址与硬件地址

IP与MAC地址：
- IP地址：网络层使用的地址，分层次等级。
- 硬件地址（MAC地址）：数据链路层使用的地址，平面式。

网络内的IP分组与MAC帧：
- IP层抽象的互联网上只能看到IP数据报。
- 虽然在IP数据报首部中有源IP地址，但路由器只根据目的IP地址进行转发。
- 在局域网的链路层，只能看见MAC帧。IP数据报被封装在MAC帧中，在不同网络间被路由器解封装和重新封装，其中MAC帧首部中的源地址和目标地址会不断改变。这也决定了无法使用MAC地址跨网络通信。
- IP层抽象的互联网屏蔽了下层网络硬件体系的复杂细节。只要在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机与主机或路由器之间的通信。

#### 地址解析协议（ARP）

**地址解析协议**（Address Resolution Protocol，ARP）：提供一种IP地址到MAC地址的映射方法，具体通过每台主机存储在ARP高速缓存的ARP表实现。

ARP表：存放本局域网内各主机、路由器的IP地址到MAC地址的映射表。

ARP工作原理：
- 在主机A发送IP数据报给主机B之前，先查ARP表中有无主机B的IP地址。
- 如果有：查出B的MAC地址，写入MAC帧。
- 如果无：通过使用`ffff-ff-ff-ff-ff`的MAC地址封装并广播ARP请求分组。B收到后给A发ARP响应分组（包括B的IP和MAC映射关系），A收到后记录在ARP表，并按照查询到的硬件地址发MAC帧。

ARP的四种情形：
- 发送方是主机（`H1`），接收方是同一网内的主机（`H2`）。`H1`在网内ARP，找到`H2`的MAC地址。
- 发送方是主机（`H1`），接收方是另一个网络中的主机（`H3`）。`H1`在网内ARP找到路由器`R1`的MAC地址，`R1`完成剩下的工作。
- 发送方是路由器（`R1`），接收方是相邻网络内的主机（`H3`）。`R1`需要用ARP找到`H3`的MAC地址。
- 发送方是路由器（`R1`），接收方是非相邻网络的主机（`H4`）。`R1`需要用ARP找到路由器`R2`的MAC地址，`R2`完成剩下的工作。

![[Pasted image 20230701210654.png]]

#### 动态主机配置协议（DHCP）

DHCP：一种给主机动态分配IP地址的网络层协议。

#### 网际控制报文协议（ICMP）

## IPv6

## 路由协议

## IP组播

## 移动IP

## 网络层设备
