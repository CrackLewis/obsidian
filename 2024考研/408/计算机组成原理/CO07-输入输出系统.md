
## 框架

- I/O系统基本概念（略）
- I/O接口
	- 功能：地址译码和设备选择、主机和外设的通信联络控制、数据缓冲、信号格式转换、传送控制命令和状态信息
	- 基本结构
	- 类型：并行/串行、程序查询/中断/DMA、可编程/不可编程
	- 端口及其编址：统一编址、独立编址
- I/O方式
	- 程序查询方式
	- 程序中断方式
	- DMA方式

## 程序查询方式

**工作流程**：
- 初始化：CPU预置传送参数、向I/O端口发送命令字、启动I/O设备。
- 等外设：从外设接口读状态信息、CPU不断查询I/O设备状态直到外设就绪。
- 传数据：传送一次数据、修改地址和计数器参数。
- 循环：如传送未结束则循环等外设、传数据两个操作。

## 程序中断方式

### 工作流程

**中断请求**

**中断响应判优**：
- 不可屏蔽中断：最高优先级
- 内部异常
	- 硬件故障
	- 软件中断
- 可屏蔽中断：最低优先级
	- DMA中断请求
	- I/O传送类请求：高速设备>低速设备、输入设备>输出设备、实时设备>普通设备

**CPU响应中断的条件**：
- 中断源有中断请求
- CPU允许中断及开中断（异常和NMI中断除外）
- 一条指令执行完毕（异常不受此限制），且无更紧迫的任务

**中断响应过程**：
- 关中断
- 保存断点
- 引出中断服务程序

**中断处理过程**：
- 中断响应：关中断、保存断点、引出中断服务程序
- 保存现场和屏蔽字
- 开中断
- 执行中断服务程序
- 关中断
- 恢复现场和屏蔽字
- 开中断、中断返回

### 多重中断和中断屏蔽技术

WIP

### 中断响应优先级、中断处理优先级

- 中断响应优先级：硬件排队电路决定，不能动态改变
- 中断处理优先级：中断屏蔽字决定，可以动态改变

## DMA方式

**特点**：
- 使主存和CPU的固定联系脱钩
- 传送时主存地址的确定、传送数据的计数等都由硬件电路直接实现
- 主存中要开辟专用缓冲区，及时供给和接收外设的数据
- 传送速度快，提高系统效率
- 有预处理和后处理机制

### DMA控制器

**主要功能**：
- 接受外设发出的DMA请求，并向CPU发出总线请求
- 在CPU响应后接管总线控制权，进入DMA操作周期
- 确定传送数据的主存单元和长度，自动修改主存地址和传送长度计数
- 规定传送方向，发控制信号，执行读写操作
- 向CPU报告读写操作结束

### 传送方式

- 停止CPU访存：DMA向CPU发送停止信号，CPU脱离总线，DMA传送一块后将总线控制权交还CPU。
- 周期挪用：
	- CPU不在访存：无冲突。
	- CPU正在访存：必须等待存取周期结束，再取得总线占有权。
	- CPU和DMA同时请求访存：CPU暂时放弃总线占有权。
- DMA与CPU交替访存：如果CPU周期大于主存存取周期，则可将CPU周期划分出一部分专用于DMA访存。

### 传送过程

- 预处理
- 数据传送
- 后处理

![[Pasted image 20230930231859.png]]

### DMA与中断方式的区别

- DMA不中断任何程序，不保护现场，除预处理和后处理外不占用CPU资源。
- 对DMA请求的响应可以发生在任一机器周期结束时。
- DMA传送过程不需要CPU的干预。
- DMA请求的优先级更高。
- DMA方式不具备处理异常的能力，仅局限于大批数据的传送。
- DMA方式靠硬件而非程序传送数据。

## 选择题整理-非真题

### 7.2-I/O接口

![[Pasted image 20230930212118.png]]

1题选A。统一编址没有专门的I/O指令，因此不能通过系统总线区分存储单元和I/O设备，而只能通过不同的地址区分。

![[Pasted image 20230930212130.png]]

7题选B。磁盘驱动器的写入机制是在同一磁道、同一柱面上逐个扇区写入，因此是并行方式写入。

8题选A。在系统调用层使用的地址是逻辑地址，到主存或外设层面才会使用物理地址。

### 7.3-I/O方式

![[Pasted image 20230930233039.png]]
![[Pasted image 20230930233054.png]]

4题选C。第三个说法反了。

![[Pasted image 20230930233109.png]]

5题选B。第二个说法错在，只有指令周期的末尾会检查一次中断请求；第三个说法错在，检测DMA请求一般在每个机器周期的末尾；第四个说法错在，最后指令一般是中断返回指令，不仅是返回程序。

6题选B。只有具有DMA接口的设备能够产生DMA请求。

7题选B。访管指令最急迫，优先级最高；程序性中断其次；重新启动应当等待其他任务完成。

![[Pasted image 20230930233121.png]]

11题选A。用户程序通过访管请求输入输出。

![[Pasted image 20230930233129.png]]

14题选A。

15题选B。中断响应过程由中断隐指令自动完成，是一个硬件过程。

![[Pasted image 20230930233141.png]]

17题选D。注意，中断屏蔽标志的作用是改变**中断处理次序**，而不是改变**中断响应次序**，后者是由硬件排队电路干预决定的。中断处理次序直接决定CPU先处理哪个中断，也和哪个中断服务程序先执行完有直接关联。

![[Pasted image 20230930233152.png]]

19题选B、D。DMA方式中，CPU和外设、传送和主程序都是并行工作的。

![[Pasted image 20230930233203.png]]

21题选C。DMA确实需要中断，但不是为了传输数据，而是为了取得总线控制权。

![[Pasted image 20230930233242.png]]

23题选A。

24题选A。C项，DMA请求高于非屏蔽外中断。

![[Pasted image 20230930233250.png]]

26题选C。其他三个选项都是由CPU程序控制的，但DMA是由DMA控制器控制的。

![[Pasted image 20230930233419.png]]

29题选B。

## 选择题整理-真题

![[Pasted image 20230930212755.png]]

9题选D。数据缓冲寄存器、命令/状态寄存器的内容均通过数据线传递，地址线传递数据交换的端口地址，控制线传输读写控制信号。

![[Pasted image 20230930212803.png]]

12题选A。磁盘驱动器是磁盘本身，并不是I/O接口。

![[Pasted image 20230930233434.png]]

31题选A。题目说中断服务程序内的执行顺序，因此是从保护现场开始，到中断返回结束。

![[Pasted image 20230930233447.png]]
![[Pasted image 20230930233458.png]]

36题选B。每个发送中断请求的时间间隔（400ns）内，CPU至少耗费100ns、至多耗费150ns处理中断请求。因此I/O时间占整个CPU时间的百分比为25%-37.5%，至少是25%，选B项。

37题选B。程序中断I/O方式中，CPU和打印机直接交换，打印字符直接传输到打印机的I/O端口，不会涉及主存地址。

![[Pasted image 20230930233512.png]]
![[Pasted image 20230930233525.png]]

44题选C。周期挪用方式下，DMA应当在每次准备好数据时发送一次总线请求，数据块传送过程中，DMA不在传送的间隙内，CPU可以访问内存。

45题选A。核心态下也能响应中断。B项说法是正确的，不是每个指令周期的末尾都会有中断响应。

## 大题整理

### 2009：

![[Pasted image 20231001104014.png]]

第一问，每次数据传输会传送4B数据，耗费20条指令的执行时间，即100个时钟周期。每秒传送0.5MB，即每秒传送131072次。因此每秒在I/O传输上耗费了13107200个时钟周期，占比约2.62%。（标准答案是采用1MB=1048576B，计算出2.5%，略有争议）

第二问，一秒内DMA会启动1000次数据传输，每次耗费500个时钟周期，总共耗时1ms。占比0.1%。

### 2012：

![[Pasted image 20231001104101.png]]

第一问：
- MIPS数是20。
- 每秒Cache缺失`3e5`次。
- 主存带宽需要达到4.8MB/s。

第二问：
- 每秒产生约1.5次缺页异常。
- 平均每秒发送1536次DMA请求。

**第三问**，DMA控制器的优先级更高，因为如果不及时响应DMA请求，则I/O传输数据可能丢失。

**第四问**，最大带宽为4\*4B/50ns=320MB/s。

### 2016：

![[Pasted image 20231001104115.png]]

**第一问**：
- 每传送一个字符需要传送10位。注意起始位是隐含的。
- 每秒最多送入2000个字符。

**第二问**：
- 一个字符的传送时间包括：设备D将字符送I/O端口的时间（0.5ms，即25000个时钟周期），中断响应时间（10个时钟周期），中断服务程序前15条指令的执行时间（60个时钟周期）。传送一个字符需要25070个时钟周期，传送1000个字符需要25070000个时钟周期。
- 由于中断响应和中断服务程序总共是10+20\*4=90个周期，所以CPU用于完成这一任务的时间大约是90000个周期。
- 中断响应阶段，CPU执行中断隐指令（关中断，保存断点和程序状态，识别中断源并进入中断服务程序）。

### 2018：

![[Pasted image 20231001104130.png]]
![[Pasted image 20231001104142.png]]

**第一问**：
- 2μs。
- 响应每次输入输出80ns，耗时占比4%。

第二问，不能采用中断I/O方式。如果使用中断I/O方式，则每秒需要响应10M次中断，每次中断耗时800ns，这远远超过了CPU处理数据的能力，会造成I/O设备数据的丢失。

第三问，4%。

### 2022：

![[Pasted image 20231001104159.png]]

第一问：
- 磁道号（柱面号），盘面号（磁头号），扇区号。
- 磁道号至少占15位，盘面号至少占2位，扇区号至少占9位。

**第二问**，扇区的平均访问时间包括三部分：
- 平均寻道时间：5ms。
- 旋转延迟时间的期望：约4.167ms。（120r/s，推算出半圈时间）
- 访问时间：约0.004167ms。（推算出转1/500圈的时间）
总计约9.17ms。

第三问：
- 64次。
- DMA控制器可以优先取得总线控制权，因为一旦磁盘开始读写，就需要按时完成数据传送，否则数据缓冲区内的数据会发生丢失。

## 后记

我希望这是我最后一次当做题家

——231001