
## 框架

- CPU的功能和基本结构
	- CPU的功能
	- CPU的基本结构
- 指令执行过程
	- 指令周期
	- 指令周期的数据流
	- 指令执行方案
- 数据通路的功能和基本结构
	- 功能
	- 基本结构
- 控制器的原理和工作原理
	- 控制器的结构和功能
	- 硬布线控制器
	- 微程序控制器
- 异常和中断机制
	- 基本概念
	- 分类
	- 响应过程
- 指令流水线
	- 基本概念
	- 基本实现
	- 冒险与处理
	- 性能指标
	- 高级流水线技术
- 多处理器的基本概念

## 指令周期、机器周期、时钟周期

指令周期>机器周期>时钟周期。

**指令周期**：CPU从主存取出并执行一条指令的时间。包含若干个机器周期。

**机器周期**：执行一个指令阶段的时间。包含若干个时钟周期。

**时钟周期**：计算机内部主时钟的频率的倒数，是最小的时间单位。

## 指令周期的数据流

### 取指周期

**任务**：根据PC中的内容从主存中取出指令代码并存放在IR中。

**数据流向**：
- 传址入存（1-3）：PC->MAR->地址总线->主存。
- 读取命令（4-5）：CU读命令->控制总线->主存。
- 指令写回（6-8）：主存->数据总线->MDR->IR。
- 计数前移（9）：CU控制信号->PC前移。

![[Pasted image 20230929112034.png]]

### 间址周期

**任务**：取操作数的有效地址。

**数据流向**：
- 间址入存（1-3）：Ad(IR)或MDR->MAR->地址总线->主存。
- 读取命令（4-5）：CU读命令->控制总线->主存。
- 实址写回（6-7）：主存->数据总线->MDR。

![[Pasted image 20230929112052.png]]

### 执行周期

**任务**：根据地址取操作数，并根据指令的操作码通过ALU操作产生执行结果。

不同指令的执行周期的数据流向差异可能很大。

### 中断周期

**任务**：处理中断请求。

**数据流向**：
- PC写入栈顶（1-8）：
	- CU控制将SP减1，SP->MAR->地址总线->主存。
	- CU写命令->控制总线->主存。
	- PC->MDR->数据总线->主存。
- CU将中断服务程序的入口地址写入PC，进入中断。

![[Pasted image 20230929112120.png]]

## 数据通路的基本结构

- CPU内部单总线方式：结构简单，冲突较多。
- CPU内部多总线方式：冲突较少，效率较高，但指令执行效率较低。
- 专用数据通路方式：效率高，硬件量较大。

## 硬布线控制器

@alias 组合逻辑控制器

**控制器输入信号来源**：
- 译码器译码产生的指令信息。
- 时序系统产生的机器周期信号和节拍信号。
- 来自执行单元的反馈信息，即标志。

**CPU的控制方式**：
- 同步控制方式
- 异步控制方式
- 联合控制方式

### 时序系统和微操作

**取指周期**：
```
(PC)->MAR                   //传址入存
1->R                        //读取命令
M(MAR)->MDR
(MDR)->IR                   //指令写回
OP(IR)->CU
(PC)+1->PC                  //计数前移
```

**间址周期**：
```
Ad(IR)->MAR                 //间址入存
1->R                        //读取命令
M(MAR)->MDR                 //实址写回
```

**执行周期**：
- `ADD X`：
	- Ad(IR)->MAR,1->R
	- M(MAR)->MDR
	- (ACC)+(MDR)->ACC
- `STA X`：
	- Ad(IR)->MAR,1->W
	- (ACC)->MDR
	- (MDR)->M(MAR)
- `LDA X`：
	- Ad(IR)->MAR,1->R
	- M(MAR)->MDR
	- (MDR)->ACC

## 微程序控制器

### 基本术语

- 微操作：计算机中最基本的、不可再分解的操作。
- 微命令：控制器发出的各类控制命令，是控制序列的最小构成单位。与微操作一一对应。
- 微指令：微程序中的指令单元，包括数个微命令。
	- 操作控制字段：用于产生某一步操作所需的各种操作控制信号。
	- 顺序控制字段：用于控制产生下一条要执行的微指令地址。
- 微周期：执行一条微指令所需的时间。
- 控制存储器（CM）：微程序存储器，在CPU内部，由ROM实现。
	- 微地址寄存器（CMAR）
	- 微指令寄存器（CMDR或μIR）

### 组成、工作过程

**基本组成**：
- 控制存储器
- 微指令寄存器
- 微地址寄存器
- 微地址形成部件

**工作过程**：
- 执行取微指令公共操作。
- 由机器指令操作码字段通过微地址形成部件产生该机器指令所对应的微程序的入口地址，并送入CMAR。
- 从CM中逐条取出对应的微指令并执行。
- 执行完微程序后，回到取指位程序的入口地址，继续第一步。

**微指令的地址形成方式**：
- 直接由微指令的下地址字段指出。
- 根据机器指令的操作码形成。

### 微指令的编码方式

**直接编码方式**：不译码，每个控制信号位表示一条微命令。

**字段直接编码方式**：将互斥性微命令组合编码，相容性微命令组合在不同字段中，每个字段独立编码。
- 分段原则：每个字段限制信息位数，字段一般保留全0状态（无微命令）。

**字段间接编码方式**：又称隐式编码，某些微命令需要另一个字段中的某些微命令解释。

上面三种方式都属于水平型微指令。

### 微指令的格式

**水平型微指令**：定义并执行数种并行的基本操作。
- 优点：程序短，执行速度快。
- 缺点：微指令长，编写麻烦。

![[Pasted image 20230929145940.png]]

**垂直型微指令**：设置微操作码字段，采用编译法，由微操作码规定微指令的功能。
- 优点：伪指令段，编写简单。
- 缺点：程序长，执行速度慢，工作效率低。

![[Pasted image 20230929145954.png]]

### 硬布线控制器和微程序控制器的比较

![[Pasted image 20230929150040.png]]

## 中断响应过程

**中断**：
- 内部异常
	- 软件中断：
		- 故障：引起故障的指令启动后、执行结束前检测到的异常事件
		- 自陷：人为安排的一种异常
	- 硬件中断：
		- 终止：使计算机无法继续执行的硬件故障
- 外部中断：INTR、NMI。

**响应过程**：
- 关中断
- 保存断电和程序状态
- 识别异常和中断、转到相应的处理程序

## 指令流水线技术

### 定义

**指令阶段**：
- 取指（IF）：读入指令，修改PC
- 译码、读寄存器（ID）：生成控制信号
- 执行、计算地址（EX）：功能由具体的指令确定
- 访存（MEM）：功能由具体的指令确定
- 写回（WB）：功能由具体指令确定

**流水线的表示方法**：横轴时间、纵轴空间、底部载入、顶部发射。
![[Pasted image 20230929152244.png]]

### 流水线的冒险情形和处理

**结构冒险**（资源冲突）：
- 成因：多条指令在同一时刻争用同一资源
- 解决方法：
	- 前一指令访存时，后一指令暂停一周期
	- 单独设置数据和指令存储器

**数据冒险**（数据冲突）：
- 成因：下一条指令使用当前指令计算出的结果
- **分类**：
	- 写后读（RAW）相关
	- 读后写（WAR）相关
	- 写后写（WAW）相关
- 解决方法：
	- 将相关指令暂停数个周期
	- 设置相关专用通路
	- 指令编译优化，调整顺序

**控制冒险**（控制冲突）：
- 成因：前一条指令进行了地址转移，导致断流
- 解决方法：
	- 对转移指令分支预测，尽早生成转移目标地址
	- 预取转移成功和不成功两个控制流方向上的目标指令
	- 加快和提前形成条件码
	- 提高转移方向的猜准率

### 性能指标

#### 吞吐率

单位时间内流水线完成的任务数量。设任务数为$n$，完成时间为$T_k$，机器周期为$\Delta t$，则吞吐率：
$$
TP=\dfrac{n}{T_k}=\dfrac{n}{(n+k-1)\Delta t}
$$
#### 加速比

完成同样一批任务，不使用流水线和使用流水线的时间之比。设非流水线下完成$n$个任务的时间为$T_0$，则：
$$
S=\dfrac{T_0}{T_k}=\dfrac{kn\Delta t}{(n+k-1)\Delta t}=\dfrac{kn}{n+k-1}
$$

### 高级流水线技术

- 超标量流水线技术（动态多发射技术）
- 超长指令字技术
- 超流水线技术

## 选择题整理-非真题

### 5.1-CPU结构

![[Pasted image 20230928163820.png]]

9题选C，只有无条件转移指令执行后的PC值一定会变为转移指令的目标地址。

![[Pasted image 20230928163912.png]]

11题选A，易误选C。注意程序计数器存储的是指令地址，所以取决于存储器容量；由指令字长决定的是指令寄存器（IR）的位数。

![[Pasted image 20230928164540.png]]

19题选C。地址译码器是主存储器的结构。

20题选A。

![[Pasted image 20230928165350.png]]

21题选B。间址周期的作用是取操作数的有效地址，因此周期结束时MDR内存储的是操作数地址。

### 5.2-指令执行过程

![[Pasted image 20230929155926.png]]
![[Pasted image 20230929155939.png]]

10题选D。D项，只有处理器检测到有中断请求存在，才会进入中断响应周期。

![[Pasted image 20230929155952.png]]

16题选A。
- 第一、二、三个说法，指令字长一般取存储字长的整数倍，而和机器字长无关，在指令字长等于存储字长的前提下，取指周期等于机器周期。第一个说法错误，第二、三个说法正确。
- 第四个说法错误，不一定和存储字长一样大，有可能是数倍。

### 5.3-数据通路

![[Pasted image 20230929161045.png]]

1题选C。部件内总线一般在各部件而非CPU内部。

2题选D。ALU必须保证运算全程两个操作数内容不变，而单总线CPU只有一条总线，所以ALU的两个输入端和输出端中，只有一个能直接连接总线，且不能是输出端（输出结果不能影响输入），所以只能连接到输入端。至于另一个输入端和输出端，则通过暂存器和总线相连。

### 5.4-控制器

![[Pasted image 20230929185259.png]]

8题选B。硬布线控制器需要结合各个微操作的节拍安排，需要综合分析并写出逻辑表达式，再设计成逻辑电路图，因此时序系统比较复杂。

![[Pasted image 20230929191042.png]]

15题选A。一条微指令包含一组实现一定操作功能的微命令。一条指令对应一个含有若干微指令的微程序，耗时一个指令周期。

![[Pasted image 20230929191052.png]]

16题选B。状态条件寄存器通常属于运算器部件。

17题选B。执行部件是和控制部件相对的，控制器显然属于控制部件之列。

### 5.5-异常和中断

![[Pasted image 20230929193029.png]]

3题选C。主存故障属于硬件中断，与软件中断和外中断相对。

### 5.6-指令流水线

![[Pasted image 20230929194043.png]]

2题选D。超标量流水线在一个时钟周期内可以执行一条以上的指令，但并不具备将运算操作并行化的能力。

（本题前一题说明了指令分3个阶段）
![[Pasted image 20230929194408.png]]

6题选C。度为4的超标量流水线处理机可以一次执行4条指令，其周期数：
$$
3+(20-4)/4=7
$$

![[Pasted image 20230929194418.png]]

9题选B。A项的”增加硬件资源“说法过于笼统，C项的分支预测技术是控制相关的解决方法。旁路技术的原理是另开数据通路，以此解决数据的使用次序问题。

10题选C。C项的旁路技术是解决数据相关的方法。

11题选B。B项，超长指令字技术对Cache的容量要求也会更大，因为需要执行的指令长度也许会很长。

## 选择题整理-真题

![[Pasted image 20230928173943.png]]

23题选B。注意PC的位数可以取30或32位，但题目强调是**最少**，所以选30，答案选B。

![[Pasted image 20230929195536.png]]

17题选A。数据通路指数据在功能部件之间传送的路径，是由控制部件控制的，而ALU、GPRs等是其流过的部件。可见控制部件不是数据通路的一部分。

## 大题整理

### 2009：控制信号综合题

![[Pasted image 20230929161756.png]]
![[Pasted image 20230929161817.png]]

执行阶段有数个步骤：
- 取R0的值。
- 取R1值指定存储单元的值。
- 运算。
- 将结果存储到R1。

答案一：先取R1值指定存储单元的值，将其与R0相加，结果写入R1。
![[Pasted image 20230929164638.png]]

答案二：在主存将((R1))送回的同时，将(R0)送入ALU，可以节省一个周期。
![[Pasted image 20230929164647.png]]

### 2015：控制信号综合题

![[Pasted image 20230929161842.png]]
![[Pasted image 20230929161853.png]]

第一问：
- PC和R0-R3都是对程序员可见的。
- 设置暂存器T的目的是使数据通路正常工作。如果两个输入端均直连数据总线，则输入端会获得相同的数据，从而无法正常工作。

第二问：
- ALU共有7种操作，需要至少3位控制信号。
- SR有3种操作，需要至少2位控制信号。

**第三问**：
SRout所控制的是一个三态门，用于控制移位器和总线之间数据通路的连接或断开。

第四问，端口1、2、3、5、8需连接到控制部件输出端。

第五问，6->9，7->4，其余端口和控制器连接。

### 2022：控制信号综合题

![[Pasted image 20230929161906.png]]

第一问：
- $SF=F_{15}$。
- A加B时，$OF=\overline{A_{15}B_{15}}F_{15}+A_{15}B_{15}\overline{F_{15}}$；A减B时，$OF=\overline{A_{15}}B_{15}F_{15}+A_{15}\overline{B_{15}F_{15}}$。

第二问，为了保证ALU正常工作，否则两个输入端会接收到相同的数据，输出端的输出也可能影响输入端。

第三问：
- 最多16个通用寄存器。
- rs和rd来自指令寄存器IR。
- rd应当连接译码器。多路选择器是一种编码设施。

**第四问**：
- 控制信号序列：
	- 传址入存：PCout，MARin
	- 读取命令：Read
	- 指令写回：MDRout，IRin
- 整个阶段需要1+5+1=7个时钟周期。

**第五问**，图中的控制信号由控制部件（CU）产生。寄存器IR和FR的输出信号会输入控制部件（CU）。注意FR容易漏掉。

### 2012：指令的机器表示、流水线冒险

![[Pasted image 20230929200755.png]]
![[Pasted image 20230929200816.png]]

第一问，FEFFH。

第二问，8个周期。

第三问：
- I3的ID阶段被阻塞的原因是，ID阶段需要用到R2的值，而R2的值必须要等到I2的WB阶段完成才能使用。
- I4的IF阶段被阻塞的原因是，IF段被I3占据。

第四问：
一种可行的指令序列：
```
LOAD R1,[x]
LOAD R2,[a]
SHL R1
ADD R1,R2
STORE R2,[x]
```

指令在流水线中的执行过程：
![[Pasted image 20230929203756.png]]
一共两处冒险：第一处是I3和I1的数据相关，第二处是I5和I4的数据相关。

### 2014：存储系统和指令系统综合题

（2014年43题）
![[Pasted image 20230929200840.png]]
![[Pasted image 20230929200850.png]]

（2014年44题）
![[Pasted image 20230929200909.png]]

43题：

第一问，存储器编址单位是字节。

**第二问**，注意这一问要结合源程序和汇编程序，源程序的`A[i]`被翻译为地址`0(R4)`，而`R4`又是`i*4`，说明每个数组元素占据4B。

第三问：
- OFFSET的值为-6。
- 地址计算公式：`NPC=PC+4+(OFFSET<<2)`。

第四问：
- I2、I3、I4、I6会由于数据相关而发生阻塞。
- I6的执行会发生控制冒险。
- I5执行时I6阻塞，I6执行时I5已经执行完毕，不会由于和I1的数据相关而引发阻塞。

44题：

第一问，(R2)=1000。

第二问：
- 数据区的容量是512B，这道题不考虑其他因素。
- 指令Cache的命中率是`5999/6000=99.8%`。

第三问：
- 第4条指令可能发生溢出异常。
- 第3条指令可能发生缺页异常。
- 读磁盘至少一次，读TLB至少1001次（第一次发现缺页）。