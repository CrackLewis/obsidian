
## 框架

- I/O管理基础
	- I/O设备：设备分类、I/O接口、I/O端口
	- I/O控制方式：程序直接控制方式、中断驱动方式、DMA方式、通道控制方式
	- I/O软件层次结构（从高到低）：用户层I/O软件、设备独立性软件、设备驱动程序、中断处理程序
	- 应用程序I/O接口：字符设备接口、块设备接口、网络设备接口、阻塞和非阻塞I/O
- 设备独立性软件
	- 与设备无关的软件
	- 高速缓存和缓冲区
	- 设备分配和回收
	- SPOOLing技术（假脱机技术）
- 磁盘和固态硬盘
	- 磁盘
	- 磁盘管理：初始化、分区、引导块、坏块
	- 磁盘调度算法：FCFS、SSTF、SCAN、C-SCAN
	- 固态硬盘

## I/O设备和接口

**按信息交换单位分类**：块设备、字符设备。

**按传输速率分类**：低速、中速、高速设备。

**I/O接口（设备控制器）**：CPU和设备的通信媒介，由与CPU的接口、与设备的接口和I/O逻辑组成。

**I/O端口**：设备控制器中可被CPU直接访问的寄存器，分数据寄存器、状态寄存器、控制寄存器三种。与CPU通信有独立编址和统一编址（内存映射）两种方法。

## I/O控制方式

**分类**：
- 程序直接控制方式：计算机从外部设备逐字读取。
- 中断驱动方式：CPU向外设发读命令，外设在准备完毕数据后，打断CPU运行。
- DMA方式：借助DMA机制。
- 通道控制方式：比DMA的自主能力更高。

**DMA方式**：
- 基本思想：在I/O设备和主存之间开辟直接的数据交换通路。
- 特点：以数据块为基本单位，数据不经过CPU，CPU的干预时机在一个或数个数据块传输完毕之后。
- 工作流程：
	- CPU收到DMA请求，向DMA控制器发命令，启动DMA，继续其他工作。
	- DMA接管数据总线和主存，向主存连续传输一个或数个数据块，每次传输一个字。
	- DMA发中断信号，CPU干预并恢复工作。

## 高速缓存和缓冲区

### 磁盘高速缓存

**两种形式**：
- 开辟一个单独的空间作为磁盘高速缓存。
- 把未利用的内存空间作为一个缓冲池。

### 缓冲区

**引入缓冲区的目的**：缓和CPU和I/O速度不匹配的矛盾、减少中断频率、解决数据粒度的不匹配问题、提高CPU和I/O的并行性。

**实现方法**：硬件缓冲器、主存缓冲区。

**根据缓冲器个数分类**：单缓冲、双缓冲、循环缓冲、缓冲池。

**循环缓冲**：包含多个大小相等的缓冲区。

**缓冲池**：由多个系统公用的缓冲区组成。
- 按使用状况分为三个队列：空缓冲队列、输入队列、输出队列。
- 四类缓冲区：收容输入hin、提取输入sin、收容输出hout、提取输出sout。

![[Pasted image 20230919120319.png]]

### 缓冲区的时间分析

**缓冲的三个工作阶段**：
- 输入（T）：外设将数据输入缓冲区。
- 传送（M）：缓冲区将数据传送至用户进程的工作区。
- 处理（C）：用户进程处理传送进来的数据。

**单缓冲的时间分析**：
传送过程不能并行，外设输入和CPU处理可并行。
![[Pasted image 20230919115505.png]]

处理一块数据的耗时：
$$
T_1=\max\{C,T\}+M
$$

**双缓冲的时间分析**：
双缓冲配置两个缓冲区，使得传送过程中外设仍可继续输入。
![[Pasted image 20230919115740.png]]

处理一块数据的耗时：
$$
T_2=\max\{C+M,T\}
$$
若C+M>T，则CPU不必等待输入；若C+M<T，则外设可以连续输入。

### 高速缓存和缓冲区的对比

![[Pasted image 20230919120332.png]]

## 设备分配和回收

**设备的使用方式**：
- 独占式使用
- 分时式共享使用
- SPOOLing方式使用

### 设备分配的数据结构

**层次从高到低**：
- 系统设备表（SDT）：整个系统一张，记录已连接设备的情况，每个设备一个条目。
- 通道控制表（CHCT）：每条通道一张，记录通道的标识符、忙闲状态、关联的控制器等信息。一个CHCT通常对应多个COCT。
- 控制器控制表（COCT）：每个设备控制器一张，记录设备的标识符、忙闲状态、关联的通道等信息。
- 设备控制表（DCT）：每个设备一张，记录设备的详细信息。

**逻辑设备名到物理设备名的映射**：
逻辑设备表（LUT）：
- 用途：将逻辑设备名映射到物理设备名。
- 表项：逻辑设备名、物理设备名、设备驱动程序入口地址。
- 设置方式：全系统或者每个用户一张LUT。

### 策略和安全性

**设备分配策略**：
- 原则：发挥效率，避免死锁，分离用户进程和硬件设备。
- 方式：静态分配（独占式设备）、动态分配。
- 分配算法：FCFS、优先级算法等。

**设备分配的安全性**：
- 安全分配方式：进程I/O请求后阻塞，直到操作完成后被唤醒。
- 不安全分配方式：进程不断I/O请求，直到请求的设备被占才阻塞。容易造成死锁。

## SPOOLing技术

@alias 脱机输入输出技术

**目的**：将独占设备改造为共享设备。

**设施**：
- 输入井和输出井：两个磁盘存储区域，分别模拟脱机输入和输出的硬盘，保存进程的输入和输出内容。
- 输入缓冲区和输出缓冲区：两个内存缓冲区，缓存输入设备和输出设备的内容。
- 输入进程和输出进程：模拟外围控制机，协调CPU和外设的工作。

![[Pasted image 20230919153435.png]]

**特点**：提高I/O速度、将独占设备改造为共享设备、实现虚拟设备的功能。

**设备独立性**：
- 概念：实际设备与用户编程时使用的设备无关。
- 优点：方便用户编程、使程序运行不受机器限制、便于程序移植。

## 磁盘及其操作

### 磁盘结构

![[Pasted image 20230919161116.png]]

**级别从高到低**：
- 柱面：整个磁盘从中心到外划分为若干环，每一环称为一个柱面。一个柱面包括所有盘片上该环范围内的一圈。
- 盘面：磁盘一般有数个盘片。每个盘片称为一个盘面，每个盘面对应一个磁头。
- 扇区：以中心为圆心，每隔一定角度划分为一个扇区。柱面、盘面、扇区可以唯一确定一个磁盘存储单元（磁盘块）。

### 磁盘操作

**初始化**：从空白盘转换为可使用的设备磁盘。
- 物理格式化（低级格式化）：划分扇区。
- 划分分区。
- 逻辑格式化（高级格式化）：确定磁盘内管理数据的具体结构。

**引导块**

**坏块**

### 磁盘读写时间分析

- 寻道时间：$T_S=mn+s$，m为磁盘驱动器的有关常数，s为磁臂启动时间，n为跨过的磁道数。
- 旋转延迟时间：$T_r=\dfrac{1}{2r}$，r为磁盘的旋转速度。
- 传输时间：$T_t=\dfrac{b}{rN}$，b为传输字节数，r为磁盘旋转速度，N为一个磁道上的字节数。

寻道时间与调度算法相关，旋转延迟时间和传输时间则和磁盘性能相关。

### 磁盘调度算法

#### FCFS

先来先服务。

#### SSTF（最短寻找时间优先）

最短寻找时间优先（Shortest Seek Time First）选择调度处理的磁道是与当前磁头所在磁道距离最近的磁道。

如果大量请求堆积在当前磁道附近，则可能导致饿死现象。

#### SCAN（电梯调度）

电梯调度算法在当前磁头移动方向上选择与所在磁道最近的请求作为下一次服务的对象，到尽头后折返。

对最近扫描过的区域不公平，局部性不佳。

#### C-SCAN（循环扫描）

服务方向不变，折返时不提供任何服务。

**改进**：不必走到尽头，走到最内或最外盘块后立刻折返。改进的SCAN算法称为LOOK算法，改进的C-SCAN算法称为C-LOOK算法。

#### 比较

设磁道初始位置为100，请求顺序为55、58、39、18、90、160、150、38、184，则：

**FCFS**：
![[Pasted image 20230919163358.png]]
移动磁道数为498。

**SSTF**：
![[Pasted image 20230919163433.png]]
移动磁道数为248。

**SCAN**：
![[Pasted image 20230919163457.png]]
移动磁道数为282（LOOK为250）。

**C-SCAN**：
![[Pasted image 20230919163533.png]]
移动磁道数为390（C-LOOK为322）。

**优点和缺点**：
![[Pasted image 20230919163602.png]]

## 设备独立性软件-选择题

该部分错题率较高，将所有非真题的错题整理如下。

![[Pasted image 20230919154024.png]]
![[Pasted image 20230919154036.png]]
![[Pasted image 20230919154045.png]]

3题选A。B、C、D都是对单个进程的专用缓冲技术，缓冲池是系统共用资源，可被多个进程共享。

6题选D。双缓冲解决了T2的并行问题，因此单个块的实际耗时是`max(T1+T2,T3)`，由于T2远小于T1，所以选D。

![[Pasted image 20230919154058.png]]

9题选D。第一个说法正确的原因是，鼠标操作不能因为高优先级中断的出现就被忽略，因此鼠标也必须设置对应的缓冲区。

![[Pasted image 20230919154109.png]]

12题选C。在被SPOOLing技术改造之前，打印机和磁带机都不是共享设备，都不能被多个进程同时访问。磁盘则是支持多个进程同时访问。

13题选D。最关键的资源是处理机，SPOOLing是高效利用外设的技术，交换技术是解决主存矛盾的技术，只有多道程序设计才是高效利用处理机的技术。

14题选C。通过SPOOLing技术改造后的设备通常称为虚拟设备。

![[Pasted image 20230919154126.png]]

本题选D。SPOOLing技术提到的外围控制机是一个虚的概念，实际上由主机输入输出进程负责，所以不需要外围计算机。

![[Pasted image 20230919154146.png]]
![[Pasted image 20230919154157.png]]
![[Pasted image 20230919154213.png]]

20题选D。A项不对，不需要外围机器；B项不全面，还需要SPOOLing软件；C项不对，用户程序和外设是并行关系。D项的说法是正确的。

21题选A。实际设备仍是独占设备，共享设备是虚拟的。B项，通过独占设备的改造，使得单一进程不能独占设备，确实加快了作业执行速度。

22题选A。以空间（输入井和输出井）换时间（节省进程独占下的空转时间）是SPOOLing技术的重要特点。

23题选C。在假脱机技术中代替打印机的是虚拟设备。

## 真题选择错题

![[Pasted image 20230919113709.png]]

21题选B。按键时键盘产生中断，CPU通过对应的中断处理程序响应，最先得到键盘输入信息的是该中断处理程序。

22题选B，对应I/O软件的四个层次。

![[Pasted image 20230919113944.png]]

本题选B。容易错选C。注意DMA控制器发中断的时机是DMA结束之时，请求CPU干预。

![[Pasted image 20230919154237.png]]

本题选A。用户程序对I/O设备的请求采用逻辑设备名，程序实际执行时采用物理设备名。

![[Pasted image 20230919154340.png]]

28题选C。单缓冲的传输时间不能并行，因此时间组成：100+5+100（与第一个块的处理时间并行）+5+90=300。

29题选A。当时选了D，实现设备无关性并不是设置缓冲区的目的。

![[Pasted image 20230919163653.png]]

本题选A。其他三项或多或少会受请求序列影响，但FCFS算法虽然性能上略逊，但会平等地响应每个请求。

## 真题大题

### 2010：C-SCAN算法、随机存储器调度

![[Pasted image 20230919164954.png]]

第一问，每个比特表示一个磁盘块的忙闲状态，例如0为空闲，1为忙。

第二问，根据转速为6000r/s，计算得读取一个随机扇区的旋转延迟期望是5ms。由于一个磁道上有100个扇区，则读取延迟为0.1ms。

**注意本题的C-SCAN默认为C-LOOK**。因此寻道顺序为100-120-30-50-90，寻道时间总计为170ms，由于读取四个扇区，所以读取延迟是0.4ms，旋转延迟期望为20ms，总计为190.4ms。

第三问，FCFS更高效，因为随机访问不需要考虑寻道时间和旋转延迟。

### 2019：SSTF算法、根据簇号计算磁盘地址

![[Pasted image 20230919165043.png]]
![[Pasted image 20230919165051.png]]

第一问，磁盘共计有`6*10^5`个扇区，每个扇区为`512B`，总计为`300000KB`，或约`292.97MB`。

第二问，分别计算得这三个簇分别在100、60、101、110号柱面上，因此根据SSTF算法计算得知次序为100260、101660、110560、60005。

第三问，柱面号为100，磁道号为5，扇区号为60。簇号转换为磁盘物理地址的过程由磁盘驱动程序完成。

### 2021：操作系统启动过程、硬盘操作

![[Pasted image 20230919165109.png]]

第一问，先执行ROM中的引导程序，再执行磁盘引导程序，随后执行分区引导程序，最后执行操作系统的初始化程序。

第二问，首先要物理格式化，其次是磁盘分区，再次是逻辑格式化，最后是操作系统的安装。

第三问，磁盘扇区的划分在物理格式化步骤中完成，文件系统根目录建立在逻辑格式化操作中。