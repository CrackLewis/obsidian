
## 框架

- 网络层的功能
	- 异构网络互连
	- 路由和转发
	- SDN基本概念
	- 拥塞控制
- 路由算法
	- 静态路由与动态路由
	- 距离-向量路由算法
	- 链路状态路由算法
	- 层次路由
- IPv4
	- IPv4分组
	- IPv4地址与NAT
	- 子网划分与子网掩码
	- CIDR
	- 路由聚合
	- ARP
	- DHCP与ICMP
- IPv6
	- IPv6的主要特点
	- IPv6地址
- 路由协议
	- 自治系统
	- 域内路由与域间路由
	- RIP路由协议
	- OSPF路由协议
	- BGP路由协议
- IP组播
	- 组播的概念
	- IP组播地址
- 移动IP
	- 移动IP的概念
	- 移动IP的通信过程
- 网络层设备
	- 路由器的组成和功能
	- 路由表与路由转发

## 网络层的功能

- 异构网络互连
- 路由选择、分组转发
- 拥塞控制：开环控制（避免）、闭环控制（监测+解决）

### SDN（软件定义网络）

**结构**：
- 控制平面：集中式，远程控制器
- 数据平面：分布式，各路由器维护路由表，执行分组转发

**接口**：
- 北向接口：面向应用开发者的编程接口
- 南向接口：面向转发设备的会话接口

**特点**：灵活、成本低，但安全风险较大，易受网络规模制约。

## 路由算法

- 静态路由算法：人工配置
- 动态路由算法：自动配置（路由表项交换）

### 距离-向量路由算法

**原理**：
- 交换对象：临近路由器。
- 交换内容：自己的整个路由选择表。
	- 表项：每条路径目的地、路径距离。
- 路由更新情形：新路由、旧但更优的路由。

**实质**：通过迭代计算得到最小代价通路。

### 链路状态路由算法

**原理**：
- 交换对象：所有其他路由器。
- 交换内容：自己的链路状态。
	- 内容：相邻路由器信息，和对应链路的度量。
- 交换时机：每隔一段时间。
- 特征：洪泛法；只有链路状态变化才发送。

**特点**：非迭代性（不依赖中间结点）、一步汇聚、报文不变、伸展性好。

### 层次路由算法

**路由选择协议**：
- 内部网关协议（IGP）：AS内路由选择
- 外部网关协议（EGP）：AS间路由选择

**层次**：自治系统（AS）>区域>局域网

## IPv4

### IPv4分组

![[Pasted image 20231003152638.png]]

**长度相关**：
- 总长度：16位，以1B为单位，理论范围是20-65536B，实际受MAC帧长限制（以太网MAC帧最大为1480B）。
- 首部长度：4位，以4B为单位，范围是5-15，即20-60B。
- 片偏移：13位，以8B为单位，范围是0-8191，即0-65528B。

**分片相关**：
- 标志：中间位DF，最低位MF
- 片偏移
- 标识：一组分片后的IP数据报具有相同的标识。

![[Pasted image 20230701145619.png]]

### IPv4地址与NAT

![[Pasted image 20231003155833.png]]

**特殊IP地址**：
![[Pasted image 20231003160246.png]]
- IP全0：本主机。
- IP全1：当前网络广播地址。
- 主机号全0：本网络本身。
- 主机号全1：本网络的广播地址。

**NAT表**：`<WAN端IP,端口>----<LAN端IP,端口>`。

注意：NAT端口号可以动态分配，但一般不动态分配IP。

### 子网划分与子网掩码、CIDR

**子网划分**：对主机号段进一步划分，变为网络、子网、主机三级地址结构。

**子网掩码**：是IP地址的附带信息。如果采用CIDR则可用一个数字代替。

**CIDR（无分类编址）**：
- 斜线记法：`IP/前缀`，例如`192.168.1.1/24`。
- CIDR地址块：一组网络前缀相同、主机号连续的IP地址。

### 网络层转发分组的过程

**路由表**：
- 表项：`<目的网络,下一跳地址>`。
- 规则：转发基于网络（而非主机）、最长前缀匹配。
- 两种特殊路由：
	- 主机路由：控制或测试用途，`a.b.c.d/32`。
	- 默认路由：`0.0.0.0/0`。

**路由器的分组转发算法**：
- 从IP分组提取目的主机IP地址
- 尝试查找并匹配主机路由
- 从长前缀到短前缀依次尝试进行匹配
- 匹配默认路由或报错

### ARP、DHCP、ICMP

#### ARP（地址解析协议）

**背景**：MAC地址不能直接跨网络，但实现双方收发又必须知道MAC地址并使用MAC帧。

**目的**：完成IP地址到MAC地址的映射。

**工作原理**：
- 发送方查ARP表（IP到MAC映射表）中有无接收方IP。
- 如有：查对方MAC并组帧。
- 如无：用`ffff-ff-ff-ff-ff`的MAC地址广播ARP请求分组，接收方用自己的MAC地址响应。发送方记录对方MAC地址到ARP表。

**四种情形**：
- 双方同网：网内ARP。
- 双方不同网：发方对路由器ARP，路由器完成剩下的部分。
- 一方为路由器，另一方为邻网主机：路由器ARP。
- 一方为路由器，另一方为非邻网主机：路由器对其他路由器ARP，其他路由器完成剩下的部分。

![[Pasted image 20230701210654.png]]

#### DHCP（动态主机配置协议）

**目的**：提供动态分配网内IP、即插即用的联网机制。

**交换过程**：A=服务器，B=入网客户机
- 发现：B广播Discover（0.0.0.0->255.255.255.255）。
- 提供：A收到Discover，广播Offer（服务器IP->255.255.255.255），包括一个给B的IP地址。
- 请求：B收到Offer，广播Request（0.0.0.0->255.255.255.255），请A提供给自己。注意收到多个Offer只会回复一个。
- 确认：A收到Request，广播ACK（服务器IP->255.255.255.255），分配IP给B。

**租用期**：IP并不是无限提供，有时间限制。

#### ICMP（网际控制报文协议）

**五种差错报文**：
- 终点不可达：无法交付
- 源点抑制：拥塞丢数据
- 时间超过：TTL=0
- 参数问题：首部字段有误
- 改变路由：提示源主机有更好的路由

**四种询问报文**：
- 回送请求和回答报文。
- 时间戳请求和回答报文。
- 地址掩码请求和回答报文。
- 路由器询问和通告报文。

**不发送报文的情形**：
- 递归：对ICMP报文不发送差错报文。
- 分片：一个分片出错，后续分片不会发送。
- 组播：组播数据报不发送。
- 特殊地址：特殊地址的数据报不发送。

## IPv6

**特点**：
- 地址扩充
- 不允许IPv4式分片
- 资源预分配、自动配置、协议扩展性
- 选项改进、首部精简灵活
- 安全性强

**IPv6地址**：
- 类型：单播、多播、任播
- 表示法：8组4位十六进制，如`4bf5:0:0:0:ba5f:39a:a:2176`。
- 等级：顶级、场点级、单个主机。

**IPv4到IPv6过渡**：
- 思想：逐步演进，向后兼容。
- 策略：双协议栈，隧道技术（数据报嵌套）。

## 路由协议

**自治系统**：单一技术管理下的一组路由器。

### RIP（路由信息协议）

**类别**：应用层协议、距离-向量算法。

**规定**：
- 距离向量：`<目的网络,跳数,下一跳地址>`
	- 跳数：直连为1，每经一个路由器+1
- 策略：跳数越少越好
- 跳数上限：15
- 广播路由：相邻路由器每30s一次

**距离向量算法**

**特点**：简单、低开销、收敛快；网络规模受限、不支持CIDR、**慢收敛现象**。

### OSPF（开放最短路径优先）

**类别**：网络层协议、链路状态算法。

**特点**：
- 估价灵活
- 负载平衡
- 分组鉴别
- 支持可变长度的子网划分和CIDR

**基本工作原理**：
- 构造路由表
- 链路状态更新
- 数据库同步

详见[[CN04-网络层#开放最短路径优先（OSPF）协议]]。

### BGP（边界网关协议）

**背景**：AS之间的路由选择难，寻找最佳路由更难。

**目的**：选取一条尽可能好的域间路由。

**BGP发言人**：
![[Pasted image 20230702123804.png]]

### 比较

![[Pasted image 20230702125430.png]]

## IP组播

![[Pasted image 20230702133431.png]]

### 组播地址

**IP组播地址**：D类地址。

**以太网组播地址**：01-00-5E-00-00-00至01-00-5E-7F-FF-FF。

**地址映射**：
- IP首4位：不映射。
- IP次5位：每32个地址映射为一个MAC地址。
- IP后23位：映射到以太网组播地址的后23位。

如`224.127.114.114`和`239.255.114.114`的映射结果均为`01-00-5E-7F-72-72`。

## 移动IP

详见[[CN04-网络层#移动IP]]。什么玩意，乱七八糟的。

## 网络层设备

### 冲突域、广播域

**冲突域**：连接到同一物理介质上所有结点的集合。存在介质争用现象。
- 交换机隔离冲突域

**广播域**：接受同样广播消息的结点集合。
- 路由器隔离广播域，交换机一般不隔离广播域
- 局域网是一种广播域

### 路由器

**功能**：多网互联、分组转发、路由计算

**工作流程**：
- 拿到数据报，先查路由表
- 网内传输：直接交付
- 网际传输：转发给下一个路由器

**结构**：
- 路由选择部分（控制部分）
- 分组转发部分：交换结构、输入端口、输出端口

**路由表和路由转发**：
- 路由表项目：`<目的网络IP,子网掩码,下一跳IP,接口>`
- 转发表项目：`<目的网络IP,下一跳IP>`。

## 选择题整理-非真题

### 4.1-网络层的功能

![[Pasted image 20231003194823.png]]

4题选C。路由器的职能之一是网络互联，因此应当可以连接采用不同网络层协议的局域网。

### 4.2-路由算法

![[Pasted image 20231003195241.png]]

5题选D。**慢收敛现象**是距离-向量路由协议独有的一种现象，具体表现是“好消息传得快，坏消息传得慢”，也是导致路由回路现象产生的原因。

### 4.3-IPv4

![[Pasted image 20231003201900.png]]

13题选A。B项的主机号为全1，是广播地址；C项的主机号为全1，是广播地址；D项是组播地址。

![[Pasted image 20231003201911.png]]

19题选A。注意**网络号最多30位**，否则主机号空间没有可分配的主机。

![[Pasted image 20231003201922.png]]

21题选A。CIDR是一种归并网络的技术，作用是将小的网络汇集成大的超网。

![[Pasted image 20231003201934.png]]

24题选D。IPv6是根本上解决的方案，CIDR等更多是缓兵之计。

25题选B。注意，分片的位置在发送主机的网络层，则组装会发生在接收主机的网络层，路由器一般不分片。

![[Pasted image 20231003202501.png]]

31题选A。在经过路由器时（不考虑NAT），源IP地址和目的IP地址不会变更，但由于硬件地址只有本地意义，所以会经常变更。

![[Pasted image 20231003202508.png]]

33题选C。注意，**NAT表的表项需要管理员添加**，这样才能控制内网到外网的网络连接。

![[Pasted image 20231003202528.png]]

35题选C、A。由于不知道目标设备的具体位置，ARP请求只能是广播，但ARP响应应当是单播。

### 4.4-IPv6

![[Pasted image 20231004002751.png]]

2题选D。IPv6没有提供校验和字段。

![[Pasted image 20231004002801.png]]

4题选D。IPv6没有首部校验和。

5题选A。IPv6不分片，遇到过大的数据报只会丢弃。

### 4.5-路由协议

![[Pasted image 20231004100731.png]]

1题选B。

![[Pasted image 20231004101203.png]]

10题选A。

![[Pasted image 20231004101212.png]]

12题选A。BGP交换的信息是路径-向量，即到达某个网络的完整路径。

![[Pasted image 20231004102707.png]]
![[Pasted image 20231004102716.png]]

13题选D。BGP协议是路径-向量协议。

### 4.6-组播

WIP

### 4.7-移动IP

WIP

### 4.8-网络层设备

![[Pasted image 20231004105111.png]]

4题选C。B项，路由器更常用传输距离而非延迟衡量线路。C项，多网互联是路由器的一种职能，路由器应支持多种网络层协议以及它们之间的分组转发。

5题选B。第一、四个说法是正确的。第二个说法，直接交付必须在同一网段内进行。第三个说法，间接交付中，最后一个路由器到目标主机是直接交付手段。

## 选择题整理-真题

![[Pasted image 20231003202602.png]]

42题选C。拥塞丢弃分组情形对应的ICMP报文类型是源点抑制。

![[Pasted image 20231003202612.png]]

44题选D。

![[Pasted image 20231003202626.png]]
![[Pasted image 20231003202635.png]]

48题选C：
- A项，H1、H2在同一网段，可以正常通信。不受网关配置的影响。
- B项，H2配置的默认网关不是实际存在的地址，无法上网；H4配置的默认网关是路由器端口，可以正常上网。
- C项，H1、H3不在同一网段，不能正常IP通信。
- D项，H3、H4在同一网段，可以正常通信。

![[Pasted image 20231003202649.png]]

49题选D。由于R2使用NAT协议，源地址被修改为L0端口的值。L0和`201.1.3.9`同属`201.1.3.x/30`网段，网段内只有一个地址`201.1.3.10`可供L0使用。目的地址不变，为S服务器的地址。

![[Pasted image 20231003202704.png]]

54题选B。一种可产生最小子网的划分方案为：`11+10+9+8+8`。最小的子网有8位主机编号，可以分配254个IP地址。

![[Pasted image 20231003202713.png]]

**56题选B。** 容易误选C。注意分片长度**只能取8B的整数倍**，因为片偏移字段不支持非8B的倍数填入，所以单个片数据部分的最大长度不是800-20=780B，而是776B。因此原始数据报需要分为3片，分别为776B、776B和8B。第二片的长度为796B，MF标志位为1。

![[Pasted image 20231003202721.png]]

58题选D。

![[Pasted image 20231004102854.png]]

16题选B。易错选C。本题考查RIP协议的**慢收敛现象**。虽然R3发给R2的新路由表中，网络的距离被记为16，但R1的路由表在发给R2时并未及时更新，导致R1记录的到该网络的距离仍是2，因此R2更新后到该网络的距离仍是3。（下一次更新时，R2才会记录正确的距离16）

![[Pasted image 20231004110427.png]]

15题选D。R1需要在只增加一个路由表项的情况下，正确访问R2所连两个子网，此时需要使用**子网聚合技术**，将`192.168.2.0/25`和`192.168.2.128/25`合并成`192.168.2.0/24`。添加的路由的下一跳地址为R2的`192.168.1.2`端口。

## 大题整理

### 2009：路由表、子网划分、路由聚合

![[Pasted image 20231004111602.png]]

第一问，划分为`202.118.1.0/25`和`202.118.1.128/25`。每个局域网的IP地址数不少于122个，说明每个局域网的主机号至少有7位。符合这种要求的只有这一种划分方案，分配方案则有两种。

**第二问**，R1可达5个网络，分别是局域网1、2、R1和R2之间的局域网、域名服务器所在的局域网和互联网。根据题意：
- 局域网1、2是常规路由，按网络IP登记。由于其直接连接R1，所以下一跳IP地址可以不填，或登记为直连。
- 域名服务器的主机路由需要填R2的L0端，出口为L0口。
- 互联网的路由为默认路由（注意不是`130.11.120.0/24`），出口为L0口。

| 目的网络IP | 子网掩码 | 下一跳IP地址 | 接口 |
| --- | --- | --- | --- |
| 202.118.1.0 | 255.255.255.128 | Direct | E1/E2 |
| 202.118.1.128 | 255.255.255.128 | Direct | E2/E1 |
| 202.118.3.2 | 255.255.255.0 | 202.118.2.2 | L0 |
| 0.0.0.0 | 0.0.0.0 | 202.118.2.2 | L0 |

第三问，由于采用了路由聚合技术，互联网1、2的路由可登记为一条，下一跳为R1的L0端口，出口为L0口：

| 目的网络IP | 子网掩码 | 下一跳IP地址 | 接口 |
| --- | --- | --- | --- |
| 202.118.1.0 | 255.255.255.0 | 202.118.2.1 | L0 |

### 2015：DHCP、ARP、默认网关

![[Pasted image 20231004111618.png]]
![[Pasted image 20231004111630.png]]

第一问：
- 分配IP的最大范围为`111.123.15.5~111.123.15.254`，共250个IP地址。
- 源IP是`0.0.0.0`，目的IP是`255.255.255.255`。

第二问：
- 发出的第一个ARP请求是广播请求，因此目的MAC地址是`ff-ff-ff-ff-ff-ff`。
- 目的MAC地址是`00-a1-a1-a1-a1-a1`。

**第三问**：
- 能访问WWW服务器。网关配置错不会影响访问同一网段内的主机。
- 不能访问Internet。

### 2018：子网划分、分片

![[Pasted image 20231004111650.png]]

第一问：
- `192.168.1.127`。
- `192.168.1.128`。
- 技术部子网还可以连接45台主机。

第二问：
- 一个最大IP分片封装数据的字节数是776B。
- 最少需要分为2个分片，第一个分片的偏移量是0，第二个分片的偏移量是97（776B）。

### 2020：HTTP、NAT

![[Pasted image 20231004111707.png]]
![[Pasted image 20231004111719.png]]

**第一问**，在R2的NAT表中将Web服务器的内网地址映射为外网地址：`(192.168.1.2:80)=>(203.10.2.2:80)`。注意端口是80端口。

第二问：
- H2发送的P的源IP是`192.168.1.2`，目的IP是`203.10.2.2`。
- R3转发的P的源IP是`203.10.2.6`，目的IP是`203.10.2.2`。
- R2转发的P的源IP是`203.10.2.6`，目的IP是`192.168.1.2`。

### 2022：100BaseT以太网、DHCP、IEEE 802.11地址

![[Pasted image 20231004111736.png]]
![[Pasted image 20231004111750.png]]

第一问，设备1选择100BaseT以太网交换机，设备2选择100BaseT集线器。

**第二问**，图中使用的设备是100BaseT以太网设备，说明网络速率是100Mbps，因此可以推算争用期为`64B*8/100(Mb/s)=5.12μs`。争用期是往返时延，而通过设备2有`1.51μs`的时延，因此信道上的单向传播时延为`1.05μs`。因此H2、H3的最大距离是`(1.05*10^(-6)*2*10^8)/2=210m`。

第三问：
- M是DHCP发现报文。
- E0可以收到封装M的以太网帧。
- S向DHCP服务器转发的封装M的以太网帧的目的MAC地址是`ff-ff-ff-ff-ff-ff`。

**第四问**，地址1是实际接收者`00-11-11-11-11-e1`，地址2是直接发送者`00-11-11-11-11-c1`，地址3是实际发送者`00-11-11-11-11-d1`。

### 2013：路由表、路由聚合、自治系统、BGP

![[Pasted image 20231004111830.png]]
![[Pasted image 20231004111844.png]]

**第一问**：注意，通过借助最长前缀匹配机制，对同一个IP记录两个前缀不同、下一跳和接口不同的路由表项是允许的，因为该IP总是会匹配那个更长匹配前缀的路由项。更短匹配前缀的路由项可以用于子网聚合。

下面是一个非最佳的路由表，4个表项。

| 目的网络 | 下一跳 | 接口 |
| --- | --- | --- |
| 153.14.5.0/24 | 153.14.3.2 | S0 |
| 194.17.20.0/25 | Direct | E0 |
| 194.17.20.128/25 | 194.17.24.2 | S1 |
| 194.17.21.0/24 | 194.17.24.2 | S1 |

下面是标准答案，3个表项，将`194.17.20.0/24`和`194.17.21.0/24`聚合了，通过一个`194.17.20.128/25`表项单独标识该IP段。

| 目的网络 | 下一跳 | 接口 |
| --- | --- | --- |
| 153.14.5.0/24 | 153.14.3.2 | S0 |
| 194.17.20.0/23 | Direct | E0 |
| 194.17.20.128/25 | 194.17.24.2 | S1 |

第二问，会通过E0接口转发。

第三问，R1、R2会通过BGP（或BGP4）协议交换路由信息。BGP报文会被封装进TCP报文段进行传输。

### 2014：路由聚合、OSPF

![[Pasted image 20231004111907.png]]

第一问：

| 目的网络 | 下一跳 | 接口 |
| --- | --- | --- |
| 192.1.1.0/24 | Direct | E0 |
| 192.1.6.0/23 | 10.1.1.2 | L0 |
| 192.1.5.0/24 | 10.1.1.10 | L1 |

第二问，R1通过L0转发分组，目的主机收到的IP分组的TTL为64-3=61。

**第三问**，需要增加一条特殊的直连网络，前缀为`0.0.0.0/0`，Metric值为10。

### 2019：

![[Pasted image 20231004111934.png]]
![[Pasted image 20231004111945.png]]

第一问，设备1选择路由器，设备2、3选择以太网交换机。

第二问，设备1的接口需要配置IP地址。IF1接口配置为`192.168.1.254/30`，IF2接口配置为`192.168.1.1/26`，IF3接口配置为`192.168.1.65/26`。

第三问，R需要提供NAT服务。

第四问，只有H4会收到这个数据报。