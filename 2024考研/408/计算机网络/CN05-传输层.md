
## 要点

- 传输层提供的服务：
	- 传输层的功能
	- 传输层寻址与端口
	- 无连接服务和面向连接服务
- UDP：UDP数据报、UDP校验
- TCP
	- TCP段
	- TCP连接管理
	- TCP可靠传输
	- TCP流量控制与拥塞控制

## 传输层提供的服务

### 传输层的功能

定位：面向通信部分的最高层，用户功能的最低层。

**传输层的功能**：
- 提供两个应用进程之间的逻辑通信（端到端的通信）。
- 复用和分用：
	- 复用：发送方不同的应用进程可使用同一个传输层协议传送数据。
	- 分用：接收方的传输层在剥去报文的首部后，能够将这些数据正确交付到目的应用进程。
- 差错检测：对收到的报文进行差错检测（首部和数据部分）。
	- 相比之下，网络层只检测首部。
- 提供两种不同的传输协议：TCP、UDP。

作用：向高层用户屏蔽了低层网络的核心细节，仅在传输层协议不同时体现出差别。
- TCP：全双工信道。
- UDP：不可靠信道。

### 传输层的寻址和端口

**端口（Port）的作用**：
- 作用：让应用进程将其数据通过端口向下交付给传输层，让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。
- 服务访问点（SAP）：
	- 传输层：端口。
	- 网络层：IP地址。
	- 数据链路层：MAC地址。

**端口号**：
- 作用：标识一个唯一的端口，长16bit，有65536个。
- 意义：只用于区分本计算机下的不同应用进程。
- 分类：
	- 服务器端端口号：
		- 熟知端口号：0-1023。
		- 登记端口号：1024-49151。
	- 客户端端口号：49152-65535。

**套接字**（Socket）：IP地址加端口号，在网络中识别各个端点。

### 无连接服务和面向连接服务

**传输控制协议**（Transmission Control Protocol，TCP）：
- 提供**面向连接服务**：通信双方通信前必须建立连接，通信过程中实时监控和管理连接，通信结束后释放连接。
- 不提供广播或组播服务。
- 适用情形：可靠性更重要的场合：FTP、HTTP、TELNET等。

**用户数据报协议**（User Datagram Protocol，UDP）：
- 只提供两个附加服务：多路复用、错误检查。
- 适用情形：实时性和速度更重要的场合：DNS、TFTP、SNMP、RTP等。

## UDP协议

### UDP数据报

**UDP优点**：
- 无需建立连接，不会引入连接时延。
- 无连接状态。
- 分组首部开销小。
- 应用层能更好地控制要发送的数据和发送时间。
- 支持一对一、一对多、多对一和多对多交互通信。

**UDP特点**：
- 常用于一次性传输数据较少的网络应用，如DNS、SNMP等。
- 不保证可靠交付，可靠性维护在应用层。
- 面向报文。

**UDP数据报结构**：
- 首部：8字节64位。
	- 源端口号：16位。需要对方回信时用。
	- 目的端口号：16位。必填。
	- UDP长度：16位。最小值是8，最大值是64K-1。
	- UDP校验和：16位。
- 数据：可有可无。

![[Pasted image 20230708102110.png]]

### UDP校验

UDP校验机制：校验前在数据报前临时添加一个伪首部，计算该临时数据报（而非原始数据报）的校验和。

**UDP伪首部**：12B的内容。
- 源IP地址：4B。
- 目的IP地址：4B。
- 全0填充：1B。
- 17：1B。
- UDP长度：2B。

**UDP校验流程**：
- 发送方先将全零放入校验和字段，添加伪首部，如果临时数据报为奇数个字节，则在末尾补一个空字节。
- 按二进制反码，从数据报头部开始计算各个16bit的数据和，将此和二进制反码写入校验和字段，并发送（不发送伪首部部分）。
- 接收方把收到的UDP数据报加上伪首部，补齐为偶数个字节，按二进制反码求各16bit的和。计算结果全1则无差错，否则有差错。

![[Pasted image 20230708110716.png]]

![[Pasted image 20230708110738.png]]

**UDP校验的特点**：
- 如果发现校验错误，可以丢弃，也可以附上错误报告交给上层。
- 可以同时检查IP数据报的地址部分。
- 校验错误能力不强，但是简单快速。

## TCP协议

### TCP协议的特点

**TCP主要特点**：
- 是面向连接的传输层协议，TCP连接是一条逻辑连接。
- 每一条TCP连接只能有两个端点，只能是点到点的。
- 提供可靠交付的服务：TCP保证传送的数据无差错、不丢失、不重复且有序。
- 提供全双工通信，设有收发缓存。
	- 发送缓存：
		- 发送应用程序传送给发送方TCP准备发送的数据。
		- TCP已发送但未确认的数据。
	- 接收缓存：
		- 按序到达但尚未被接受应用程序读取的数据。
		- 不按序到达的数据。
- TCP是面向字节流的，尽管TCP交互是基于数据块的。

### TCP报文段

**TCP报文段**：TCP传送的数据单元。
- 功能：运载数据、建立连接、应答、释放连接。
- 结构：首部、数据。
- 位置：IP数据报的数据部分。

**TCP首部**：20B固定首部，另加可变首部。
- 源端口：2B。
- 目的端口：2B。
- 序号：4B。首个数据字节在TCP字节流中的序号。
- 确认号：4B。表示期望收到对方下一个报文段的第一个数据字节的序号。只有ACK=1时有效。
- 数据偏移：4bit，表示首部长度，单位是4B。该字段限定了首部最长为60B。
- 保留：6bit，置零。
- 状态位：6bit。
	- 紧急位（URG）：后面的紧急指针字段有效。
	- 确认位（ACK）：前面的确认号字段有效。
	- 推送位（PSH）：指示接收方尽快交付给接收应用，而不再等到缓存填满再交付。
	- 复位位（RST）：表明TCP连接出现严重差错，必须重新连接。
	- 同步位（SYN）：表明这是连接请求或接受报文。
	- 终止位（FIN）：发送方数据发送完毕，要求释放连接。
- 窗口：2B，指明现在允许对方发送的数据量。
- 校验和：2B，计算方法和UDP相同，需要添加伪首部（注意伪首部内的17应改为6，即TCP协议号）。详见[[#UDP校验]]。
- 紧急指针：2B，指明本报文段中从头算起，有多少字节的紧急数据。只有URG=1时有效。
- 可变首部：
	- 选项：长度可变，但只规定了一种选项，即最大报文段长度（MSS），指TCP报文段中数据字段的最大长度。
	- 填充：如首部长度不是4B的整数倍，则用零填充补齐。

### TCP连接管理

**TCP连接的三个阶段**：连接建立、数据传送、连接释放。

**TCP连接的相关概念、问题**：
- 连接建立过程解决的问题：
	- 要使每一方能够确知对方的存在。
	- 要允许双方协商一些参数（最大窗口值、是否使用窗口扩大、时间戳选项及服务质量等）。
	- 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配。
- 客户（Client）：主动发起连接建立的应用进程。
- 服务器（Server）：被动等待连接建立的应用进程。

**本部分是重中之重，尤请注意。**

#### TCP连接的建立（三次握手）

- 连接建立前：客户机CLOSED，服务器LISTEN。
- 第一次握手：客户机CLOSED→SYN-SENT，发送连接请求报文段（SYN=1，seq=x，不携带数据）。
- 第二次握手：服务器收到连接请求报文，如同意连接，则LISTEN→SYN-RCVD，并发送确认报文段（SYN=1，ACK=1，seq=y，ack=x+1，不携带数据），为该TCP连接分配缓存和变量。
- 第三次握手：客户机收到确认报文，则SYN-SENT→ESTABLISHED，并再发一次确认（ACK=1，seq=x+1，ack=y+1），为该TCP连接分配缓存和变量。该确认报文可携带可不携带数据，如不携带则不消耗序号。
- 服务器收到确认报文，则SYN-RCVD→ESTABLISHED。

![[Pasted image 20230712164508.png]]

特点：
- 服务器在完成第二次握手时分配资源，客户端在完成第三次握手时分配资源。
- 只有客户端发出的确认报文可以携带数据，其余报文不能。

#### TCP连接的释放（四次握手）

- 连接释放前：服务器和客户机均为ESTABLISHED。
- 第一次握手：客户机ESTABLISHED→FIN-WAIT-1，发送连接释放报文段（FIN=1，seq=x）。
- 第二次握手：服务器收到连接释放报文段后，ESTABLISHED→CLOSE-WAIT，并发出确认报文（ACK=1，seq=v，ack=u+1）。
- 第三次握手：客户机收到请求报文后，FIN-WAIT-1→FIN-WAIT-2。如果服务器仍有数据则传输数据，否则CLOSE-WAIT→LAST-ACK，发出连接释放报文段（FIN=1，ACK=1，seq=w，ack=u+1）。
- 第四次握手：客户机收到连接释放报文段后，FIN-WAIT-2→TIME-WAIT，并发确认报文（ACK=1，seq=u+1，ack=w+1），并等待两个最长报文段寿命。等待完毕后，连接被彻底释放，TIME-WAIT→CLOSED。
- 服务器收到确认报文，LAST-ACK→CLOSED。

![[Pasted image 20230712171624.png]]

### TCP可靠传输

### TCP流量控制

### TCP拥塞控制

