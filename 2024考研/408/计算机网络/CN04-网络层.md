
## 主要内容

- 网络层的功能
	- 异构网络互连
	- 路由和转发
	- SDN基本概念
	- 拥塞控制
- 路由算法
	- 静态路由与动态路由
	- 距离-向量路由算法
	- 链路状态路由算法
	- 层次路由
- IPv4
	- IPv4分组
	- IPv4地址与NAT
	- 子网划分与子网掩码
	- CIDR
	- 路由聚合
	- ARP
	- DHCP与ICMP
- IPv6
	- IPv6的主要特点
	- IPv6地址
- 路由协议
	- 自治系统
	- 域内路由与域间路由
	- RIP路由协议
	- OSPF路由协议
	- BGP路由协议
- IP组播
	- 组播的概念
	- IP组播地址
- 移动IP
	- 移动IP的概念
	- 移动IP的通信过程
- 网络层设备
	- 路由器的组成和功能
	- 路由表与路由转发

## 网络层的功能

网络层的设计思路：向上提供简单灵活、无连接、尽最大努力交付的数据报服务。

设计思路的好处：降低网络造价，运行方式灵活，能够适应多种应用。

### 异构网络互连

网络互连：将两个以上的计算机网络，通过一定方法，用一些中间设备（**中继系统**）连接起来，以构成更大的网络系统。

中继系统分类：
- 网络扩大系统：
	- 物理层中继系统：转发器，集线器。
	- 数据链路层中继系统：网桥或交换机。
- 网络互连系统：
	- 网络层中继系统：路由器。
	- 网络层以上的中继系统：网关。

**虚拟互连网络**（逻辑互连网络）：互连起来的各种物理网路的异构性客观存在，但通过网络层协议可以使这些性能各异的网络看起来是一个统一的网络。
- **IP网络**：在网络层使用IP协议的虚拟互连网络。
- 好处：屏蔽了各网络的异构细节，简化通信流程。

### 路由与转发

路由器的两个主要功能：
- 路由选择：按照复杂的分布式算法，根据从各相邻路由器得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
- 分组转发：根据转发表将IP数据报从合适的端口转发出去。

### SDN的基本概念

**软件定义网络**（Software Definition Network，SDN）：
- 结构：两个由控制-数据接口连接的分离平面
	- 控制平面：集中式，远程控制器通过软件和接口对数据平面的路由器集中控制
	- 数据平面：分布式，各路由器根据远程控制器维护的路由表进行分组转发
- 接口：
	- 北向接口：SDN对上层应用开发者提供的编程接口。
	- 南向接口：SDN控制器通过南向接口协议（如Openflow）与转发设备建立双向会话的接口。
- 优点：
	- 全局集中式控制和分布式高速转发：利于控制平面的全局优化，也利于高性能的网络转发。
	- 灵活可编程与性能的平衡：控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置。
	- 降低成本：控制与数据平面分离后，可以实现网络设备制造和功能软件开发的分离，降低成本。
- 问题：
	- 安全风险：集中管理易受攻击，如果崩溃将影响整个网络。
	- 瓶颈问题：随着网络规模扩大，控制器可能成为网络性能的瓶颈。

![[Pasted image 20230701103443.png]]

### 拥塞控制

拥塞：在通信子网中，因出现过量分组而引起网络性能下降的现象。

判断网络拥塞的方法：观察网络的吞吐量和负载的关系。
- 吞吐量偏低：轻度拥塞
- 吞吐量低：拥塞
- 吞吐量为零：死锁

**拥塞控制**：
- 解决的问题：如何获取网络中发生拥塞的信息，并利用信息进行控制，以避免由于拥塞造成分组的丢失，以及严重拥塞引发的网络死锁现象。
- 与流量控制的区别：流量控制的核心思想是抑制点对点通信中的发送端，拥塞控制则确保网络内所有终端间的通信能力。
- 方法：
	- **开环控制**：静态方法，设计网络时事先考虑拥塞因素，而非考虑当前网络的状态，包括：确定何时可接收新流量、何时丢弃分组、丢弃哪些分组。
	- **闭环控制**：动态方法，事先不考虑拥塞因素，而是用监测网络系统检测拥塞，将拥塞信息传到合适的地方，以便调整网络的运行，并解决出现的问题。

## 路由算法

### 静态路由和动态路由

**静态路由算法**（**非自适应路由算法**）：网络管理员手工配置路由信息，当网络结构变更时需要手动调整。不能及时适应网络状态的变化。

**动态路由算法**（**自适应路由算法**）：路由器上的路由表项是通过相邻路由器间彼此交换信息，并按照一定算法优化出来的，会在一定时间内不断更新，以适应不断变化的网络。

比较：
- 静态路由算法：开销小，简便，适用于拓扑变化不大的小型网络。
- 动态路由算法：改善网络性能并有助于流量控制，但算法复杂，会增加网络负担。

两种常见的动态路由算法：距离-向量路由算法、链路状态路由算法。

### 距离-向量路由算法

原理：
- 所有结点都定期将它们的整个路由选择表发送给所有与之相邻的结点。路由选择表包含：每条路径的目的地（下一结点）、路径的代价（距离）。
- 所有结点都参与距离向量的交换，以保证路由的有效性和一致性。
- 所有结点监听路由选择更新信息，并在下列情形下更新路由表：
	- 添加本结点路由表中不存在的新路由。
	- 路由信息中有一条到达某目的结点距离更短的路由，则更新本表中的对应路由。

实质：迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短（最小代价）通路。

典型：RIP算法。

### 链路状态路由算法

原理：每个参与该算法的结点都有完全的网络拓扑信息，执行下列两项任务：
- 主动测试所有邻接结点的状态。
- 定期将链路状态广播给所有其他结点。

特征：
- **洪泛法**：路由器A通过所有端口向所有相邻的路由器x发送信息，每个相邻路由器x又将此信息发往其所有相邻路由器y（路由器A除外）。
- 链路状态：某个路由器所掌握的，相邻路由器信息以及对应链路的度量（费用、距离、时延、带宽等）。
- 只有链路变化时，路由器才会发送链路状态信息。

优点：
- 非迭代性：每个路由结点使用同样的原始状态数据独立计算路径，而非依赖中间结点的计算。
- 链路状态报文不加改变地传播，易于排障。
- 当一个结点从其他所有结点收到报文时，可以在本地立即计算正确的通路，保证一步汇聚。
- 由于链路状态报文只运载来自单个结点关于直接链路的信息，其大小与网络路由结点数无关，因此伸展性更好。

**与距离-向量路由算法比较**：
- 距离-向量路由算法：路由只与邻居交谈，但无所不谈（提供网络内其余所有结点的路由）。可能遇到环路情形。
- 链路状态路由算法：路由通过广播和网络内的其他路由交谈，但只谈自己邻居。

典型：OSPF算法。

### 层次路由

背景：网络扩大会导致路由表成比例增大，消耗路由器的资源，也会因为传输路由信息消耗网络带宽。

**路由选择协议**：
- 分类：
	- 内部网关协议（IGP）：域内路由选择，自治系统内使用的协议，如RIP或OSPF等。
	- 外部网关协议（EGP）：域间路由选择，两个自治系统间交换路由信息使用的协议，如BGP等。

## IPv4

IPv4：第四版IP协议。

大致内容：IP分组及其格式、分组相关规则。

### IPv4分组

#### IPv4分组的格式

结构：
- 首部：
	- 固定部分：必备，20B。
	- 可变部分：长度可变，0-40B。
- 数据部分

部分重要字段含义：
- 版本：4。
- 首部长度：4位，以32位为单位，最大为60B，最常用为20B（无可变部分）。
- 总长度：16位，包括首部和数据部分长度，理论最大为65535B，实际受数据链路层的最大传送单元（MTU）限制（如以太网帧的MTU为1500B）。
- 标识：16位，一种用于在分割过大的数据报后，记录数据报片所属原数据报编号的字段，方便接收端重组为IP数据报。
- 标志：3位，中间位DF（Don't Fragment）指示是否禁止分片，最低位MF（More Fragments）指示后续是否有分片。
- 片偏移：13位，指出较长的分组在分片后，某片在原分组中的相对位置，单位为8B。除了最后一个分片外，每个分片长度必是8的倍数。
- 生存时间（TTL）：8位，数据报可在网络中通过的路由器数的最大值。
- 协议：8位，此分组携带的数据使用何种协议，应上交给哪个协议处理。详见[IP协议号列表](https://zh.wikipedia.org/wiki/IP%E5%8D%8F%E8%AE%AE%E5%8F%B7%E5%88%97%E8%A1%A8)，常用：TCP=6，UDP=17。
- 首部校验和：16位，只校验首部。
- 源地址字段：4B，标识发送方IP地址。
- 目的地址字段：4B，标识接收方IP地址。

![[Pasted image 20230701142229.png]]

#### IP数据报分片

背景：数据链路层一般都会对帧的最大数据量进行限制，这个限制称为最大传送单元（Maximum Transmission Unit，MTU）。各段链路上采用的数据链路层协议不尽相同，因此MTU也不尽相同。这些MTU都对IP数据报的长度有限制。

流程：
- 当IP数据报的大小超过链路MTU时，需要将IP数据报中的数据分装在多个较小的IP数据报（称作**片**）中。
- 片在目的地的网络层被重新组装。组装使用IP首部的标识、标志和片偏移字段完成。
	- 标识字段：同一标识的所有数据报属于一个原始数据报。
	- 标志字段：
		- 如果DF=1，则说明该数据报不是片。
		- 如果DF=0，MF=1，则说明该数据报有后继数据报片。
		- 如果DF=0，MF=0，则说明该数据报是最后一个片。
	- 片偏移字段：指示数据报在原始数据报的哪个位置。

![[Pasted image 20230701145619.png]]

### IPv4地址与NAT

#### IPv4地址

IPv4地址：为每台连接到因特网上的主机（或路由器）分配一个32比特的全球唯一标识符。

**IP地址结构**：
- 网络号：标志主机连接到哪个网络。
- 主机号：标志某个具体的主机或路由器。

**五类IP地址**：

| 类别 | 范围 | 网络号位数 | 主机号位数 | 最大网络数 | 每个网络的最大主机数 |
| --- | --- | --- | --- | --- | --- |
| A | 1.0.0.0-126.255.255.255 | 8 | 24 | $2^7-2$ | $2^{24}-2$ |
| B | 128.0.0.0-191.255.255.255 | 16 | 16 | $2^{14}$ | $2^{16}-2$ |
| C | 192.0.0.0-223.255.255.255 | 24 | 8 | $2^{21}$ | $2^{8}-2$ |
| D | 224.0.0.0-239.255.255.255 | 不适用 | 不适用 | 不适用 | 不适用 |
| E | 240.0.0.0-255.255.255.255 | 不适用 | 不适用 | 不适用 | 不适用 |

D为轮播地址，E为保留地址。

**特殊含义的IP地址**：
- 表示本网络本身：主机号全为0。
- 表示本网络的广播地址：主机号全为1。
- 环回自检地址：127.x.x.x，表示主机自身，不会出现在任何网络上。
- 表示本网络上的本主机：0.0.0.0。
- 表示整个TCP/IP网络的广播地址：255.255.255.255。

**IP地址的重要特点**：
- 分等级：分为网络号和主机号。
	- IP地址管理机构只分配网络号，网络的对应单位分配主机号，方便IP地址的管理。
	- 路由器仅根据目的主机所连接的网络号转发分组，减小路由表占有的存储空间。
- 与主机和链路绑定：是标志一台主机（或路由器）和一条链路的端口。主机如果连接到多个网络，则对每个网络都需要一个该网络下的IP地址。
- 所有分配到网络号的网络都是平等的。
- 同一个局域网上的主机或路由器的IP地址中的网络号必须一致。
	- 用转发器或桥接器（网桥）连接的若干LAN属于同一个网络（同一个广播域），网络下所有IP的网络号相同，主机号不同。

#### 网络地址转换（NAT）

**网络地址转换**（NAT）：通过将专有地址转化为公共地址，从而对外隐藏内部管理IP地址的技术手段。

**私有IP地址**：只能用于局域网，不能在广域网上使用的IP地址。
- 特点：允许重用，又称可重用地址。
- 网段：
	- A类：10.0.0.0-10.255.255.255
	- B类：172.16.0.0-172.31.255.255
	- C类：192.168.0.0-192.168.255.255

**NAT原理**：
- 连接因特网的路由器内安装NAT软件，NAT软件维护一张从`[本地IP:端口]`到`[全球IP:端口]`的**NAT转换表**，初始时表为空。
- 用户主机请求访问Web服务器。
- NAT路由器收到IP分组后，为该IP分组生成一个新端口号，并将IP分组的源地址改为NAT服务器的全球地址，端口号改为新端口号。NAT转换表中新建一项，本地IP、端口填用户主机IP、端口，全球IP、端口填路由器全球IP、端口。
- Web服务器并不清楚NAT路由器的转发细节，认为该路由器是一个主机，并将响应分组发给NAT路由器。
- 响应分组到达NAT路由器后，通过NAT转换表填入对应的本地IP和端口，返回给用户主机。

特点：
- 节省IP地址的消耗。
- 隐藏了局域网的内部结构，降低了内部网络被攻击的风险。

![[Pasted image 20230701162642.png]]

### 子网划分与子网掩码、CIDR

#### 子网划分

背景：两级IP地址本身的缺陷。
- IP地址空间的利用率低。
- 给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏。
- 两级IP地址不够灵活。

**子网划分**：
- 本质：添加子网号字段，使两级IP地址变为三级IP地址。
- 基本思路：
	- 子网划分是网络单位内部的动作，对外部屏蔽细节。
	- 从主机号借用若干比特作为子网号，主机号减少相应的比特数。
	- IP数据报在到达本网络路由器之前，与不划分子网网络的IP数据报无异，在进入网络后，才会根据子网号找到子网。
- 特点：
	- 保守起见，子网划分应遵循传统IP地址规则的限制：子网号不应全0或全1，剩余的主机号也不应全0或全1。CIDR或许会容许违反该规则，但一般仍需注意。

#### 子网掩码

**子网掩码**：
- 与IP地址对应的、长32bit的二进制串，用于表达对原网络中主机号的借位。
- 由一串1和一串0组成，1表示网络号对应的位域，0表示主机号对应的位域。
- 与原网络内IP地址逐位与运算的结果即是网络号。
- 在无CIDR技术的情形下，必须伴随IP地址。

A、B、C类IP地址的子网掩码：
- A类：255.0.0.0
- B类：255.255.0.0
- C类：255.255.255.0

#### 无分类编址CIDR

**无分类域间路由选择**（Classless Inter-Domain Routing，CIDR）：
- 目的：基于变长子网掩码，消除网络类别的差异，实现超网构造。
- 网络前缀：位数可以不固定，表示IP地址的前多少位为网络号。
- 斜线记法：IP地址/网络前缀比特数，如192.168.1.1/24。
- 掩码：不再使用子网划分的概念，而是用掩码划分CIDR地址块。

CIDR地址块：一组网络前缀相同、主机号连续的IP地址。
- 路由聚合（构成超网）：一个CIDR地址块可以表示很多地址。
- 作用：增强路由表的功能，降低路由器负载和信息交换频率，提高网络性能。
- 地址数：2的若干次幂。

CIDR查找路由表的方法：将CIDR的路由表存放在一种层次式数据结构中，最常用二叉线索树。

CIDR优点：网络前缀长度灵活，降低路由负担。

#### 网络层转发分组的过程

路由器的转发表中的每一项必有两条信息：`[目的网络, 下一跳地址]`。

规则：
- 基于网络：分组转发基于目的主机的所在网络，因为网络数远小于主机数，可以极大压缩转发表的大小。
- 最长前缀匹配：使用CIDR时，会匹配公共前缀最长的目的网络地址。

两种特殊路由：
- 主机路由：对特定主机的IP地址专门指明一个路由`a.b.c.d/32`，用作控制或测试网络的用途。
- 默认路由：特殊前缀`0.0.0.0/0`表示默认路由，必定会和任何地址匹配，因此如果某个目的网络不在转发表中，则会落到该路由。

**路由器的分组转发算法**：
- 从收到的IP分组的首部提取目的主机的IP地址`D`（目的地址）。
- 若查找到特定主机路由（目的地址为`D`），则按照这条路由的下一跳转发分组，否则从转发表的下一条（即按前缀长度的顺序）开始检查。
- 将这一行的子网掩码和目标地址`D`进行按位与运算。如果和本行的前缀匹配，则查找结束，按照“下一跳”指出的进行处理（或者直接交付本网络的目标主机，或通过指定接口发送到下一跳路由器）。否则，如果转发表还有下一行，则检查下一行，重新执行本步骤。
- 如果转发表中有一个默认路由，则把分组传送给默认路由，否则报告出错。

### ARP、DHCP、ICMP

#### IP地址与硬件地址

IP与MAC地址：
- IP地址：网络层使用的地址，分层次等级。
- 硬件地址（MAC地址）：数据链路层使用的地址，平面式。

网络内的IP分组与MAC帧：
- IP层抽象的互联网上只能看到IP数据报。
- 虽然在IP数据报首部中有源IP地址，但路由器只根据目的IP地址进行转发。
- 在局域网的链路层，只能看见MAC帧。IP数据报被封装在MAC帧中，在不同网络间被路由器解封装和重新封装，其中MAC帧首部中的源地址和目标地址会不断改变。这也决定了无法使用MAC地址跨网络通信。
- IP层抽象的互联网屏蔽了下层网络硬件体系的复杂细节。只要在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机与主机或路由器之间的通信。

#### 地址解析协议（ARP）

**地址解析协议**（Address Resolution Protocol，ARP）：提供一种IP地址到MAC地址的映射方法，具体通过每台主机存储在ARP高速缓存的ARP表实现。

ARP表：存放本局域网内各主机、路由器的IP地址到MAC地址的映射表。

ARP工作原理：
- 在主机A发送IP数据报给主机B之前，先查ARP表中有无主机B的IP地址。
- 如果有：查出B的MAC地址，写入MAC帧。
- 如果无：通过使用`ffff-ff-ff-ff-ff`的MAC地址封装并广播ARP请求分组。B收到后给A发ARP响应分组（包括B的IP和MAC映射关系），A收到后记录在ARP表，并按照查询到的硬件地址发MAC帧。

ARP的四种情形：
- 发送方是主机（`H1`），接收方是同一网内的主机（`H2`）。`H1`在网内ARP，找到`H2`的MAC地址。
- 发送方是主机（`H1`），接收方是另一个网络中的主机（`H3`）。`H1`在网内ARP找到路由器`R1`的MAC地址，`R1`完成剩下的工作。
- 发送方是路由器（`R1`），接收方是相邻网络内的主机（`H3`）。`R1`需要用ARP找到`H3`的MAC地址。
- 发送方是路由器（`R1`），接收方是非相邻网络的主机（`H4`）。`R1`需要用ARP找到路由器`R2`的MAC地址，`R2`完成剩下的工作。

![[Pasted image 20230701210654.png]]

#### 动态主机配置协议（DHCP）

DHCP：一种给主机动态分配IP地址的、基于UDP的**应用层协议**。

DHCP工作原理：客户/服务器模式。

DHCP服务器/客户端交换过程：发现、提供、请求、确认。
- 客户广播发现报文：DHCP客户机首先广播**DHCP发现**（0.0.0.0→255.255.255.255）消息，试图找到网络中的DHCP服务器，以便从其获取一个IP地址。
- 服务器广播提供报文：DHCP服务器收到DHCP发现消息，广播**DHCP提供**（服务器IP→255.255.255.255）消息，其中包括给客户端的IP地址。
- 客户机接受并发送请求报文：DHCP客户机收到DHCP提供消息，如果接受提供的IP地址，则广播**DHCP请求**（0.0.0.0→255.255.255.255）消息，向DHCP服务器请求提供该IP地址。
- 服务器广播确认报文：DHCP服务器广播**DHCP确认**（服务器IP→255.255.255.255）消息，将IP地址分配给DHCP客户机。

交换过程的细节：
- 客户机在收到多个DHCP提供时，只会挑选其中一个（一般是最先到达的）回复。
- **租用期**：服务器分配的IP地址是临时的，只能供客户机在有限时间内使用。
	- 长度由服务器决定，但客户机也可以提要求。
- 交换过程采用UDP和广播模式的原因：客户端暂时没有IP地址，不可能建立连接或直接通信。

#### 网际控制报文协议（ICMP）

ICMP目的：让主机或路由器报告差错和异常情形，提高IP数据报成功交付的机会。是网络层协议。

ICMP报文种类：差错报告报文、询问报文。

**ICMP差错报告报文**：目标主机到目标主机路径上的路由器向源主机报告差错和异常情况。
- 五种常用类型：
	- 终点不可达：不能交付数据报。
	- 源点抑制：由于拥塞丢弃数据报，提示源主机应限制发报速率。
	- 时间超过：路由器收到生存时间（TTL）为零的数据报，或终点没有收到一个数据报的所有数据报片。
	- 参数问题：数据报首部字段有误。
	- 改变路由（重定向）：提示源主机有更好的路由。
- 不应发送的几种情形：
	- 递归情形：对差错报告报文不发送差错报告报文。
	- 分片情形：对涉事数据报片的所有后续分片不发送差错报告报文。
	- 组播情形：对具有组播地址的数据报都不发送差错报告报文。
	- 特殊地址情形：对具有特殊地址的数据报不发送差错报告报文。

**ICMP询问报文**：
- 类型：前两类最常用。
	- 回送请求和回答报文。
	- 时间戳请求和回答报文。
	- 地址掩码请求和回答报文。
	- 路由器询问和通告报文。
- 两个常见应用：
	- 分组网间探测PING：测试两台主机之间的连通性。
	- Traceroute：跟踪分组经过的路由。

## IPv6

### IPv6主要特点

背景：IP地址耗尽问题。

IP地址耗尽问题的解决措施：
- CIDR：合理化IP地址分配。
- NAT：节省IP地址。
- IPv6：扩大地址空间，根本解决地址耗尽的问题。

**IPv6的主要特点**：
- 更大的地址空间：128位地址。
- 扩展的地址层次结构。
- 灵活的首部模式。
- 改进的选项。
- 允许协议继续扩充。
- 支持即插即用（自动配置）。
- 支持资源的预分配。
- 不允许一般意义上的（即IPv4采用的）分片。
- 首部长度必须是8B的整数倍。
- 安全性更强，有身份验证和保密功能。

IPv6相较IPv4的优点：
- 地址空间远大于IPv4。
- 简化了IP分组头，只包含8个域（IPv4是12个）。
- 更好地支持选项。

### IPv6地址

IPv6数据报的目的地址：三种基本类型地址。
- 单播：点对点。
- 多播：一对多。
- 任播：目的站是一组计算机，但交付时只交付其中一台计算机（通常是距离最近的一台）。

**IPv6地址表示法**：8组4位十六进制，全零组可缩写，组内可省略前缀零。

**IPv6地址等级**：
- 第一级（顶级）：全球都知道的公共拓扑。
- 第二级（场点级）：指明单个场点。
- 第三级：指明单个网络接口。

IPv4到IPv6的过渡思想：逐步演进，向后兼容。

IPv4到IPv6的过渡策略：
- 双协议栈：一台设备同时配备IPv4和IPv6协议栈。
- 隧道技术：IPv6数据报封装在IPv4数据报中。

## 路由协议

### 自治系统

**自治系统**（Autonomous System，AS）：单一技术管理下的一组路由器。自治系统内的所有网络必须隶属于同一个行政单位，
- AS内部的路由选择协议：确定分组在该AS的路由。
- AS之间的路由选择协议：确定分组在不同AS之间的路由。

### 域内路由和域间路由

域内路由选择：自治系统内部的路由选择。

**内部网关协议**（Interior Gateway Protocol，IGP）：一个AS内部使用的路由选择协议，它与互联网中其他AS选择什么路由选择协议无关。如RIP、OSPF等。

**外部网关协议**（External Gateway Protocol，EGP）：若源站和目的站在不同的AS中，且数据报传到其中一个AS的边界时，需要一种路由协议将路由选择信息传递到另一个AS中。如BGP等，目前最常用BGP-4。

![[Pasted image 20230702090150.png]]

### 路由信息协议（RIP）

**路由信息协议**（Routing Information Protocol，RIP）：最先得到广泛应用的内部网关协议。是基于UDP的**应用层协议**。

**RIP规定**：
- 距离向量：网络内每个路由器维护从其自身到其他每个目的网络的距离记录，这一组距离信息称作一个距离向量。
- 跳数：一个路由器到直接连接网络的跳数为1，每经过一个路由器，跳数加1。
- 策略：优先选择跳数少的路径。
- 跳数上限：允许一条路径最多包含15个路由器（15跳），当距离大于15时认为网络不可达。可以防止环路情形，但也限制了RIP可应用的网络规模。
- 广播路由：任意两个使用RIP的路由器之间每隔30秒广播一次RIP路由更新信息，以便自动建立并动态维护路由表。
- 子网掩码：RIP不支持子网掩码的RIP广播，因此RIP中每个网络必须有相同的子网掩码。但RIP2支持子网掩码和CIDR。

**RIP特点**：
- 仅和相邻路由器交换信息。
- 路由器交换自己知道的所有路由信息，即路由表。
- 按固定的时间间隔（如30秒）交换路由信息。

**距离向量算法**：
- 路由表项目：`[目的网络N, 距离d, 下一跳路由器地址X]`。
- 步骤：
	- 对地址为X的相邻路由器发来的RIP报文，把所有的下一跳修改为X，把所有的距离加1。
	- 对修改后的RIP报文中的每个项目`[N, d, X]`，执行如下步骤：
		- 如果原路由表无目的网络N，把该项目添加到路由表中。
		- 如果原路由表有目的网络N，且下一跳地址是X，则直接替换原路由项目。
		- 如果原路由表有目的网络N，且下一跳地址不是X，如果本项目的距离d更小，则替换原路由表的对应项目；否则什么也不做。
	- 如果180秒还没有收到相邻路由器的更新路由表，则将此路由器设为不可达路由器，距离标记为16。
	- 返回。

**RIP的优点**：实现简单、开销小、收敛过程较快。

**RIP的缺点**：
- RIP限制了网络规模，整个网络的直径不能超过15。
- 路由器之间交换整个路由表，因此开销会随网络扩大而增大。
- 网络出现故障时，会出现**慢收敛现象**：需要数轮RIP才能将故障信息传到所有路由器，俗称坏消息传得慢。

### 开放最短路径优先（OSPF）协议

**开放最短路径优先**（Open Shortest-Path First，OSPF）：使用分布式链路状态路由算法的典型代表，也是内部网关协议的一种。是**网络层协议**。

OSPF与RIP的四点主要区别：
- 发送对象：OSPF向AS内的所有路由器发送信息（洪泛法），而RIP仅向自己相邻的几个路由器发送信息。
- 发送内容：OSPF只发送相邻所有路由器的链路状态，RIP发送路由器掌握的所有信息（整个路由表）。
- 发送时机：OSPF只有在链路状态变化时才会发送信息，并且更新过程收敛快；RIP中无论网络拓扑是否变化都会定时发送信息。
- 工作层次：OSPF是网络层协议，不使用UDP或TCP；RIP是应用层协议，使用UDP。

**OSPF特点**：
- 灵活的估价功能：OSPF对不同的链路可根据IP分组的不同服务类型（TOS）而设置成不同的代价。因此，OSPF对不同类型业务可计算出不同的路由，十分灵活。
- 多路径间的负载平衡：如果到同一目的网络有多条相同代价的路径，则可以将通信量分配给这几条路径。
- 分组鉴别机制：所有在OSPF路由器之间交换的分组都具有鉴别功能，因而保证了仅在可信赖的路由器之间交换链路状态信息。
- 支持可变长度的子网划分和CIDR。
- 每个链路状态都带上一个32位的序号，序号越大，状态越新。

**OSPF的基本工作原理**：
- 链路状态数据库同步：各路由器间的频繁数据交换使得所有路由器都能建立一个链路状态数据库。该数据库的实质是全网的拓扑结构图，在各路由器间一致。
- 构造路由表：路由器根据网络拓扑结构图，通过Dijkstra算法计算各目的网络的最优路径，并根据这些最优路径构造路由表。
- 链路状态更新：链路状态发生变化时，重新计算最优路径和路由表。
- **OSPF区域**：为应用于规模大的网络，OSPF会将AS继续划分为若干区域。
	- 好处：洪泛法可以只应用于一个区域，而非整个AS，减少通信量。
	- 主干区域：处在上层的区域，负责连通下层区域和其他AS。

**OSPF的五种分组类型**：
- 问候分组：发现和维持邻站的可达性。
- 数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
- 链路状态请求分组：向对方请求发送某些链路状态项目的详细信息。
- 链路状态更新分组：用洪泛法对全网更新链路状态。
- 链路状态确认分组：对链路更新分组的确认。

![[Pasted image 20230702111447.png]]

**OSPF分组的使用时机**：
- 每隔10秒：邻站交换一次问候分组。
- 路由器开始工作时：数据库描述分组（交换链路状态信息）、链路状态请求（询问自己缺少的链路状态信息）。
- 链路状态变化时：
	- 涉事路由器：发送链路状态更新分组。
	- 其他路由器：接收更新分组，发确认分组。
- 每隔30分钟：发送一次链路状态请求分组，更新自身链路状态。

### 边界网关协议（BGP）

**边界网关协议**（Border Gateway Protocol，BGP）：不同AS之间交换路由信息的协议。是一种外部网关协议。

背景：
- 因特网的规模太大，自治系统之间路由选择非常困难。
- 对于自治系统之间的路由选择，寻找最佳路由很不现实。
- 自治系统之间的路由选择必须考虑有关策略。

BGP的目的：力求选取一条能到达的、比较好的路由，而非追求最佳路由。

**BGP的工作原理**：
- BGP发言人：每个AS中指定至少一个路由器，负责和其他AS中的BGP发言人通信。
- BGP发言人与其他AS的BGP发言人交换路由信息之前，先建立TCP连接，再在此连接上交换BGP报文以建立BGP会话，再利用BGP会话交换路由信息。
- 当所有BGP发言人都相互交换网络可达性的信息后，各BGP发言人就可以找出到达各个AS的较好路由。
- BGP发言人需要同时运行BGP和AS使用的内部网关协议。

![[Pasted image 20230702123804.png]]

**BGP特点**：
- BGP交换路由信息的结点数量是AS的数量级，远少于AS的网络数。
- 每个AS中BGP发言人的数目很少，简化AS间的路由选择问题。
- BGP支持CIDR，其路由表应包括目的网络前缀、下一跳路由器、到达该网络所需经过的各个AS序列。
- BGP刚运行时，BGP的邻站交换整个BGP路由表，但以后只在变化时更新有变化的部分。

**BGP-4报文**：
- 打开（Open）报文：和另一个相邻的BGP发言人建立联系。
- 更新（Update）报文：发送某一路由的信息，列出要撤销的多条路由。
- 保活（Keepalive）报文：确认打开报文并周期性证实邻站关系。
- 通知（Notification）报文：发送检测到的差错。

**RIP、OSPF、BGP的比较**：
![[Pasted image 20230702125430.png]]

## IP组播

### 组播的概念

背景：
- 为了支持视频点播或视频会议等多媒体应用，网络必须实施某种有效的组播机制。
- 多个单播仿真组播会造成大量处理开销和交通量。
- 需要一种让源计算机一次发送的单个分组可以抵达用一个组地址标识的若干目标主机，并被它们正确接收的机制。

使用组播的原因：有的应用程序需要一对多发送分组。让源主机一次性投放到组播地址，让网络分发给组播组内的每一个主机，明显比一一发给目标主机效率更高。

组播组：
- 组播地址：每个组有一个特别分配的地址，要给该组发送的主机使用这个地址作为分组的目标地址。对IPv4而言，一般使用D类地址。
- 组播协议：通知本地网络的路由器关于要接收发送给某个组播组的分组的愿望，通过路由选择和转发实现因特网组播，如IGMP。

![[Pasted image 20230702133431.png]]

### IP组播地址

使用D类地址。

**组播数据报**：使用D类地址作为目的地址，协议字段值为2（IGMP）。
- 尽最大努力交付，不提供可靠交付。
- 组播地址只用于目的地址，不用于源地址。
- 对组播数据报不产生ICMP差错报文，因此组播地址不会响应PING命令。
- 并非所有D类地址都是组播地址。

IP组播分两类：
- 本局域网内硬件组播。
- 因特网内组播：末端仍需在局域网内用硬件组播的方式交付给组播组。

IP组播地址和以太网组播地址的关系：
- 范围：
	- 以太网组播地址：01-00-5E-00-00-00至01-00-5E-7F-FF-FF。（后23位自由）
	- IP组播地址：224.0.0.0-239.255.255.255。（后28位自由）
- 映射：
	- IP地址的首4位：不映射，因为是固定的。
	- IP地址的次5位：每32个地址映射为一个MAC地址。
	- IP地址的后23位：映射到以太网组播地址的后23位。

![[Pasted image 20230702143517.png]]

### IGMP与组播路由算法

**因特网组管理协议**（Internet Group Management Protocol，IGMP）：
- 作用：让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组。
- 两个工作阶段：
	- 第一阶段：某台主机加入新的组播组时，向组播组的组播地址发送一个IGMP报文，声明要成为该组的成员。组播路由器收到IGMP报文后，将组成员关系转发给因特网上的其他组播路由器。
	- 第二阶段：本地组播路由器周期性探询本地局域网上的主机，询问这些主机是否继续是组的成员。对某个组而言，只要有至少一台主机响应，则认为该组仍活跃；如果数次探询仍无主机响应，则不再转发该组的成员关系。

组播路由选择本质：找出以源主机为根的组播转发树。

三种组播路由算法：
- 基于链路状态的路由选择
- 基于距离-向量的路由选择
- 协议无关的组播（PIM）

## 移动IP

### 移动IP概念

**移动IP技术**：
- 功能：移动站以固定的IP地址实现跨越不同网段的漫游功能，并保证基于网络IP的网络权限在漫游过程中不发生任何改变。
- 功能实体：
	- 移动节点：具有永久IP地址的移动站。
	- 本地代理：通常就是连接在归属网络上的路由器。
	- 外地代理：通常就是连接在被访网络上的路由器。

注意：DHCP不是移动IP，因为IP可能发生变化。

### 移动IP通信过程

有关概念：
- 永久地址（归属地址）：
- 归属网络：移动站原始连接的网络。
- 归属代理：连接到归属网络上的路由器。
- 被访网络：移动站移动后，接入的外地网络。
- 外地代理：移动站在被访网络中使用的代理，通常是被访网络中的路由器。
	- 功能：为移动站创建临时地址（转交地址）、及时把移动站的转交地址告诉归属代理。

**移动IP技术的基本通信流程**：
- 移动站在归属网络时，按传统的TCP/IP方式进行通信。
- 移动站漫游到外地网络时，向外地代理进行登记，以获得一个临时的转交地址。外地代理要向移动站的归属代理登记移动站的转交地址。
- 归属代理知道移动站的转交地址后，会构建一条通向转交地址的隧道，将截获的发送给移动站的IP分组进行再封装，并通过隧道发送给被访网络的外地代理。
- 外地代理把收到的封装的数据报进行拆封，恢复成原始的IP分组，然后发送给移动站， 这样移动站在被访网络就能收到这些发送给它的IP分组。
- 移动站在被访网络对外发送数据报时，仍然使用自己的永久地址作为数据报的源地址，此时显然无须通过A的归属代理来转发，而是直接通过被访网络的外部代理。
- 移动站移动到另一外地网络时，在新外地代理登记后，然后新外地代理将移动站的新转交地址告诉其归属代理。无论如何移动，移动站收到的数据报都是由归属代理转发的。
- 移动站回到归属网络时，移动站向归属代理注销转交地址。

**注意**：转交地址是供移动站、归属代理及外地代理使用的，各种应用程序都不会使用。 外地代理要向连接在被访网络上的移动站发送数据报时，直接使用移动站的MAC地址。

## 网络层设备

### 冲突域和广播域

**冲突域**：连接到同一物理介质上所有结点的集合，这些结点间存在介质争用的现象。
- 是一个物理层概念：由物理层设施（转发器、集线器等）连接的设备属于同一个冲突域，由高层设施连接的设备属于不同冲突域。

**广播域**：接受同样广播消息的结点集合。在该集合中任何一个结点发送一个广播帧，其他能收到这个帧的结点都被认为是该广播域的一部分。
- 是一个数据链路层概念：由物理层和数据链路层设施（交换机等）连接的设备属于同一个广播域，由高层设施连接的设备属于不同广播域。
- 局域网是一种广播域。

### 路由器的组成和功能

**路由器**：一种具有多个输入/输出端口的专用计算机。
- 任务：连接不同的网络并完成路由转发，是多网互连的必需设备。
- 工作流程：
	- 当源主机要向目标主机发数据报时，路由器先检查主机与目标主机是否连接在同一个网络上。
	- **直接交付**：如果源主机和目标主机在同一个网络上，那么直接交付而无须通过路由器。
	- **间接交付**：如果源主机和目标主机不在同一个网络上，那么路由器按照转发表（路由表）指出的路由将数据报转发给下一 个路由器。
- 结构：
	- 路由选择部分（控制部分）：路由选择处理机，根据选定的路由选择协议构造和定期维护路由表。
	- 分组转发部分：交换结构、一组输入端口、一组输出端口。
		- 交换结构：路由器的关键部件，根据转发表处理分组，将输入的分组从某个端口输出。**交换方式**分通过存储器、总线和互联网络进行交换三种。
		- 输入端口：从输入端口的比特流中提取出帧，从帧中提取出IP数据报。
		- 输出端口：将IP数据报逐级封装为比特流并输出。
- 功能：
	- 分组转发：处理通过路由器的数据流，包括转发表查询、转发及相关的队列管理和任务调度等。
	- 路由计算：通过和其他路由器进行基于路由的交互，完成路由表的计算。
- 和网桥的区别：网桥和高层协议无关，但路由器面向协议。

![[Pasted image 20230702161727.png]]

### 路由表和路由转发

考研题中的路由表一般有四个项目：
- 目的网络IP地址
- 子网掩码
- 下一跳IP地址：Direct表示直连对应网络
- 接口

![[Pasted image 20230702161836.png]]

转发表是根据路由表推导的，每个转发表项对应一个路由表项。但简化了相当多的内容，只剩目的站和下一跳信息。

**转发和路由选择的区别**：
- 转发：路由器根据转发表把收到的IP数据报从合适的端口转发出去，只涉及一个路由器。
- 路由选择：涉及诸多路由器，路由表是诸多路由器共同工作的结果。

Fin.