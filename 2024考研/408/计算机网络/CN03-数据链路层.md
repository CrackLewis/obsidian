
## 主要内容

- 数据链路层的功能
- 组帧
- 差错控制
	- 检错编码，纠错编码
- 流量控制与可靠传输机制
	- 流量控制、可靠传输、滑动窗口机制、停止-等待协议
	- 后退N帧协议（GBN）、选择重传协议（SR）
- 介质访问控制
	- 信道划分：频分多路复用、时分多路复用、波分多路复用、码分多路复用
	- 随机访问：ALOHA协议、CSMA协议、CSMA/CD协议、CSMA/CA协议
	- 令牌传递协议
- 局域网
	- 局域网基本概念和体系结构；以太网和IEEE 802.3
	- IEEE 802.11无线局域网；VLAN基本概念与基本原理
- 广域网
	- 广域网的基本概念
	- PPP协议
- 数据链路层设备
	- 局域网交换机及其工作原理

## 数据链路层的功能

角色：在物理层提供的服务的基础上，向网络层提供服务。

主要作用：
- 加强物理层传输比特流的功能
- 将物理层提供的可能出错的物理连接改造成逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路

功能：
- 为网络层提供服务：
	- 无确认的无连接服务：无链路连接，无确认，适用于以太网等实时连接和低误码率的网络。
	- 有确认的无连接服务：无链路连接，有确认，适用于无线通信等高误码率网络。
	- 有确认的面向连接服务：有链路连接（建立链路-传输帧-释放链路），适用于通信要求较高的场合。
- 链路管理：在面向连接的网络中，管理连接的建立、维持和释放过程。
- 帧定界、帧同步与透明传输：
	- 帧：数据链路层的传输单元，由比特流的前后添加头部和尾部构成
	- 帧定界：由帧首部和尾部中的控制信息划定帧的边界
	- 帧同步：接收方从二进制比特流中划分出帧的起始和终止点
	- 透明传输：通过有效措施，使链路上可以传输任意的比特组合
- 流量控制：
	- 背景：如果发送方发送过快，会造成帧的丢失
	- 目的：限制发送方的数据流量，使其发送速率不超过接收方的接收能力
	- 控制对象：*相邻两个结点之间的*数据链路流量
	- 反馈机制：使发送方得知接收方能否跟得上自己，什么时候可以发下一帧，什么时候必须暂停
- 差错控制：
	- 背景：由于信道噪声等原因，帧在传输过程中可能出错
	- 目的：使发送方确定接收方是否正确收到数据
	- 错误类型：
		- 位错：帧中某些位出现差错，用循环冗余校验（CRC）发现，通过自动重传请求（ARQ）方式重传出错的帧。
			- ARQ方法：每个帧传输时附带CRC码，接收方检验CRC出错则该帧被丢弃，发送方超时重传。
		- 帧错：帧的丢失、重复或失序。引入定时器和编号机制保证非重复性和顺序。

## 组帧

目的：在出错时，只重传出错的帧，而非整个比特流，提升效率。

### 字符计数法

原理：在帧的头部用一个计数字段标明帧内字符数。通过该计数字段推算帧的结束位置。

![[Pasted image 20230623085947.png]]

缺陷：如果计数字段出错，则失去帧边界划分的依据，收发双方失去同步，造成灾难性后果。

### 字符填充的首尾定界符法

原理：
- 用特定字符定界一帧的开始（SOH）和结束（EOT）。
- 为了使信息位中出现的特殊字符不被误判为首尾定界符，在这些字符前加转义字符（ESC）加以区分。

![[Pasted image 20230623090227.png]]

### 零比特填充的首尾标志法

原理：
- 使用一个特殊的比特模式“01111110”表示一帧的开始和结束
- 发送方将信息位中的每5个连续1的后面追加一个0
- 接收方识别01111110序列作为开始和结束控制序列，自动拿掉每5个连续1后面的0

特点：性能优于字符填充法，易于用硬件实现。

![[Pasted image 20230623095531.png]]

### 违规编码法

原理：利用物理层编码阶段中的违规编码（如曼彻斯特编码的1-1编码，与表示1的1-0编码和表示0的0-1编码相对）实现控制功能。

特点：
- 不需要任何填充技术
- 但也只适用于采用冗余编码的特殊编码环境

## 差错控制

背景：实际通信链路都是不理想的，任何比特在传输过程中均可能出错。

比特差错：外界或链路因素导致比特与预期值反转，1变成0，0变成1。

分类：
- 自动重传请求（ARQ）：检错
- 前向纠错（FEC）：纠错

### 检错编码

核心思想：
- 在有效数据发送前，根据某种关系附加一定的冗余位，构成一个符合某一规则的码字再发送。
- 一旦出现比特差错，它将破坏先前计算冗余位时使用的规则，便于接收端发现并通知重传。

#### 奇偶校验码

组成：
- 信息元：$n-1$位，包含信息。
- 校验元：一位，使整个校验码中1的个数为奇数（奇校验码）或偶数（偶校验码）。

原理：接收方对奇偶校验码计算异或和，检查是否为1（奇校验码）或0（偶校验码）。

特点：
- 只能检测奇数位的出错情况
- 无法定位出错位

#### 循环冗余码（CRC，多项式码）

**本知识点是重点。**

背景：任何一个$k$位二进制都可与一个以$0,1$为系数的$k-1$次多项式一一对应。

原理：
- 收发双方约定一个$0,1$系数的多项式$G(x)$。
- 发送方对每个$m$比特的帧或报文，根据$G(x)$生成一个$r$比特的帧检验序列（FCS），整个帧的最终长度是$m+r$比特。
- 接收方根据$G(x)$对整个帧进行检验。

步骤：设待发送的帧为$M(x)$，约定的多项式$G(x)$。
- 加0：若$G(x)=O(x^{r-1})$，则令$M'(x)=x^{r-1}M(x)$。
- 模2除：令$M'(x)$为被除数，$G(x)$为除数，利用模2除法计算出余数多项式$R(x)$，该多项式对应的$r$位二进制序列作为FCS。

举例：$M(x)=101001$，$G(x)=1101$。
- $G(x)$为3阶，$R_6(x)=M'(x)=101001000$作为被除数。
- 首位为1：$R_5(x)=R_6(x)\oplus x^6G(x)=11101000$。
- 首位为1：$R_4(x)=R_5(x)\oplus x^5G(x)=0111000$。
- 首位为0：$R_3(x)=R_4(x)=111000$。
- 首位为1：$R_2(x)=R_3(x)\oplus x^3G(x)=01100$。
- 首位为0：$R_1(x)=R_2(x)=1100$。
- 首位为1：$R_0(x)=R_1(x)\oplus xG(x)=001$，作为余数。
- 将余数$001$追加到$M(x)$后：$P(x)=r^3M(x)+R_0(x)=101001001$即为待发送序列。

![[Pasted image 20230623104317.png]]

### 纠错编码（海明码）

**本知识点是重点。计组部分的海明码删除，但这里仍然要考。**

纠错原理：冗余信息足够，使接收方能够推算出信息元中的哪一位出了错。

**注意：纠错编码并不特指海明码，而是以海明码为代表。**

海明码背景知识：
- 码字的海明距离（码距）：两个合法编码的对应比特取值不同的比特数。
- 编码集的海明距离（码距）：编码集中任意两个合法编码的海明距离的最小值。
- 码距与纠错能力的关系：
	- 码距为1：无法检测错误。
	- 码距为2：可以检测一位错，但无法纠错。
	- 码距为$k$：可以检测$k-1$位错，纠正$\dfrac{k-1}{2}$位错。

海明码核心思想：
- 在有效信息位中加入几个校验位形成海明码，把每个二进制位分配到几个奇偶校验组。
- 当某一位出错后，就会引起数个校验位数值的变化，这些位的变化可以指出错位的具体位置。

海明码编码过程：
- 确定海明码的位数
- 确定校验位的分布
- 分组以形成校验关系
- 校验位取值

**确定海明码的位数**：
设$n$为有效信息的位数，$k$为校验位的位数，对于只检测一位错的海明码，则$n$和$k$满足：
$$
n+k\le 2^k-1
$$
对于检测两位错的海明码，需要一位额外的校验码，对应地有：$n+k+1\le 2^k-1$。

这些要求的

例如：$n=4$，需要检测一位错，则校验位的最低位数$k=3$。如果需要检测两位错，则3位校验码不能符合要求，相应地需要$k=4$。

**确定校验码的分布**：
以$n=4$和$k=3$的7位海明码为例，各位从后往前排列和定义如下：

| 位置 | $H_7$ | $H_6$ | $H_5$ | $H_4$ | $H_3$ | $H_2$ | $H_1$ |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 内容 | $D_4$ | $D_3$ | $D_2$ | $P_3$ | $D_1$ | $P_2$ | $P_1$ |
| 功能 | 信息位 | 信息位 | 信息位 | 校验位 | 信息位 | 校验位 | 校验位 |

统一规定：
- $P_i(i=1,2,\cdots,k)$为校验位，分布在从前开始数第$1,2,\cdots,2^{k-1}$位上。
- $D_i(i=1,2,\cdots,n)$为数据位，依次分布在未被校验位占据的各个位置。
- 如果选用检测两位错的海明码，则$P_{k+1}$追加到整个序列的末尾。

**分组以形成校验关系**：
每个数据位用多个校验位进行校验，但满足条件：被校验数据位的海明位号（$H_i$）等于校验该数据位的各校验位海明位号之和。

以$n=4$和$k=3$的7位海明码为例：数据位$D_4$在$H_7$的位置上，由$H_1,H_2,H_4$对应的校验位$P_1,P_2,P_3$共同校验。对应地有：
- $D_1\rightarrow P_1,P_2$。
- $D_2\rightarrow P_1,P_3$。
- $D_3\rightarrow P_2,P_3$。
- $D_4\rightarrow P_1,P_2,P_3$。

分组：列出每个校验位校验的所有数据位，$P_i$校验的所有数据位为第$i$组。
- 第1组：$D_1,D_2,D_4$。
- 第2组：$D_1,D_3,D_4$。
- 第3组：$D_2,D_3,D_4$。

**校验位取值**：
$P_i$的值为第$i$组的所有数据位取异或的结果。

对数据值$1010$计算校验码（通常而言，取后面为前）：
- $P_1=D_1\oplus D_2\oplus D_4=0\oplus 1\oplus 1=0$。
- $P_2=D_1\oplus D_3\oplus D_4=0\oplus 0\oplus 1=1$。
- $P_3=D_2\oplus D_3\oplus D_4=1\oplus 0\oplus 1=0$。

因此，$D_4D_3D_2D_1=1010$对应的海明码为$\overline{H_7H_6H_5H_4H_3H_2H_1}=1010010$。

**海明码的校验原理**：
接收方收到海明码后，对每个校验组分别利用校验位和参与形成该校验位的信息位进行奇偶校验检查，构成$k$个校验方程：
- $S_1=P_1\oplus D_1\oplus D_2\oplus D_4$。
- $S_2=P_2\oplus D_1\oplus D_3\oplus D_4$。
- $S_3=P_3\oplus D_2\oplus D_3\oplus D_4$。

检查$S_3S_2S_1$的数值：若为零则海明码无误，否则为出错位的编号：若$S_3S_2S_1=4$，则说明$H_4$出现了比特错，需要反转过来。

## 流量控制和可靠传输机制

### 流量控制、可靠传输、滑动窗口机制

流量控制的基本方法：
- 停止-等待协议
- 滑动窗口协议

**停止-等待流量控制基本原理**：
- 发送方每发一帧，都需要等待接收方应答，之后才能发下一帧。
- 接收方每收一帧，都需要反馈一个应答信号，表示可以接收下一帧。
	- 如果无应答，则发送方必须一直等待。
- 每次只允许发送一帧，然后陷入等待接收方确认信息的过程中，传输效率很低。

**滑动窗口流量控制基本原理**：

收发双方各维持一个窗口：
- **发送窗口**：发送方维持一组连续的允许发送的帧序号。
	- 功能：对发送方进行流量控制。
	- 窗口大小（$W_T$）：在未被对方确认时，最多能继续发多少帧。
- **接收窗口**：接收方维持一组连续的允许接收帧的序号。
	- 功能：控制接收方接收和拒绝哪些帧。
	- 窗口大小（$W_R$）：当前哪些帧仍没收到，且可被接收。

发送窗口滑动：
![[Pasted image 20230623154209.png]]

接收窗口滑动：
![[Pasted image 20230623154218.png]]

窗口操作：
- 发送端每收到一个确认帧，发送窗口就向前滑动一个帧的位置。
- 发送端总是尝试发送窗口内所有可发送的帧。
- 接收端收到数据帧后，如果该帧在窗口内，则将接收窗口前移一个位置；如果该帧落在窗口外，则将该帧丢弃掉。

滑动窗口的重要特性：
- 只有接收窗口向前滑动（同时向发送端发ACK）时，发送窗口才可能向前滑动。
- 后面的停-等协议、后退N帧协议和选择重传协议只在发送窗口大小上有差别。
	- 停-等协议：$W_T=1,W_R=1$。
	- 后退N帧协议：$W_T>1,W_R=1$。
	- 选择重传协议：$W_T>1,W_R>1$。
- 接收窗口的大小为1时，能保证帧的有序接收。
- 数据链路层的滑动窗口协议中，窗口大小在传输全程是恒定的，这一点与传输层的滑动窗口协议不同。

**可靠传输机制**：
- 确认：可以是一个无数据的控制帧，也可以被回复帧捎带（捎带确认）。
- 超时重传：发送数据帧后一定时间内未得到ACK，则重新发送。

自动重传机制（ARQ）：接收方主动请求发送方重传出错数据帧的机制。
- 传统ARQ：停止-等待ARQ、后退N帧ARQ、选择重传ARQ。
- 连续ARQ

### 单帧滑动窗口和停止-等待协议

停止-等待协议相当于$W_T=W_R=1$的滑动窗口协议。

可能的差错：
- 数据帧丢失：发送方超时重传。
- 到达目的站的帧遭到破坏：接收方丢弃，发送方超时重传。
- 数据帧正确而确认帧遭到破坏：发送方超时重传，接收方丢弃并重传ACK。

特点：
- 数据帧用0、1编号，对应确认帧用ACK0、ACK1表示
- 收发双方各有一个帧缓冲区：发送方存储数据帧副本便于重传，接收方存储前一帧的副本便于判重。
- 通信信道利用率过低。

![[Pasted image 20230623154237.png]]

### 多帧滑动窗口和后退N帧协议（GBN）

原理：
- 滑动窗口：若帧编号为$n$比特，则满足$1\le W_T\le 2^n-1,W_R=1$。
	- 若$W_T>2^n-1$，则接收方可能无法辨别新旧帧
- 非阻塞：发送方无需收到上一帧的ACK就可发送下一帧
- 接收方只允许**按序接收**：
	- 接收方检测到失序帧，则要求发送方重传最后一个正序帧后的所有未被确认的帧
	- 发送方发现某一帧超时，则必须重传该帧及其后的所有帧
- **累积确认**：接收端不必对每个帧单独确认，而是可以通过确认最后一个正确收到的数据帧连带确认之前的所有数据帧。

特点：
- 连续发送数据帧可以提高信道利用率
- 但重传时连带重传正确发送的数据帧，又降低了传输效率

以下图为例，选取两个事件解释：
- 2号帧出错，发送方发现超时，于是重传2-8号帧，先前发送的3-7号帧由于2号帧未确认而被悉数丢弃。
- 在2号帧出错后，接收方长时间不发ACK2，直到重传2号帧被收到时才收到ACK2。
![[Pasted image 20230623163052.png]]

### 多帧滑动窗口和选择重传协议（SR）

原理：
- 滑动窗口：$1\le W_T\le 2^{n-1},1\le W_R\le 2^{n-1}$。
	- 如果大于上限，则收发双方无法确认重传的帧是新帧还是旧帧。
- 每个发送缓冲区对应一个计时器，超时则会重传该帧。
- ACK帧：接收方会对每个成功接收的帧回复ACK给发送方。
- NAK帧：如果接收方怀疑帧$t$出错，则会发送NAKt给发送方，要求发送方重传。
- **选择重传**：一旦出错，只会重传出错的帧，不会重传其他帧。

特点：
- 可以避免重复传送那些正确到达的数据帧
- 但接收端需要设置相当容量的缓冲区来暂存未按序收到的帧

![[Pasted image 20230623172858.png]]

### 信道效率和信道吞吐率

**信道效率**（信道利用率）：对发送方而言，在一个发送周期内有效发送数据所需时间占整个发送周期的比率。
- **发送周期**：发送方从开始发送数据到收到该数据的ACK帧经历的时间。
- 计算：设发送周期$T$，传输量$L$，传输速率$C$，则信道效率$\eta=(L/C)/T$。

**信道吞吐率**：信道利用率和发送方发送速率的乘积。

## 介质访问控制（MAC）

- 主要任务：为使用介质的每一个结点隔离来自同一信道上其他结点所传送的信号。
- **介质访问控制子层**：决定广播信道中信道分配的协议子层。

### 信道划分介质访问控制

功能：将使用介质的每个设备与来自同一通信信道上其他设备的通信隔离开，把时域和频域资源合理分配给网络上的设备。

**多路复用技术**：
- 背景：传输介质的带宽超过单个信号的带宽，介质只传输一路信号浪费资源。
- 思路：一条介质上携带多个传输信号，提高传输系统的利用率。
- 实质：通过分时、分频、分码等方法把原来的一条广播信道，逻辑上分为几条用于两个结点之间通信的互不干扰的子信道，实际上是把广播信道转化为点对点信道。
- 分类：频分多路复用、时分多路复用、波分多路复用、码分多路复用。

#### 频分多路复用（FDM）

原理：将多路基带信号调制到不同频率载波上，再叠加形成一个复合信号的多路复用技术。

特点：
- 每个子信道的带宽可不相同，但总和不能超过信道总带宽
- 相邻子信道之间需要保护带
- 充分利用了传输介质的带宽，系统效率较高；技术成熟，实现较容易

![[Pasted image 20230623191925.png]]

#### 时分多路复用（TDM）

原理：将一条物理信道按时间划分为若干时间片，轮流分配给多个信号使用，每个时间片都由复用的一个信号占用。

特点：
- 时效性：就某时刻而言，TDM信道上传送的仅是某一对设备间的信号；就某段时间而言，传送的是按时间分割的多路复用信号。
- **统计时分多路复用**（STDM）：TDM的一种改进，并不固定分配时隙，而是动态按需分配，当终端有数据要传送时，才会分配到时间片。

![[Pasted image 20230623191936.png]]

#### 波分多路复用（WDM）

特指光的频分多路复用。

原理：在一根光纤上传输多种不同波长（频率）的光信号。由于波长不同，各路光信号不互相干扰，最后用波长分解复用器将各路波长分解出来。

![[Pasted image 20230624091354.png]]

#### 码分多路复用（CDM）

原理：采用不同编码区分各路原始信号。与FDM和TDM相比，它既共享频率，又共享时间。

![[Pasted image 20230624091414.png]]

**码分多址**（CDMA）

特点：
- 时间划分：每个比特时间划分为$m$个短的时间槽，称为**码片**。现实生活通常$m=64$或$m=128$，做题时$m$往往较小。
- 站点码片序列：每个站点拥有唯一的$m$位码片序列，各站点的码片序列相互正交。
- 站点发送序列：站点发1时，发送它的码片序列；发0时，发送它码片序列的反码。
- 信道特征：各站点发送的序列在信道内线性相加。

原理：
在CDMA码片中，比特1记作$+1$，比特0记作$-1$。码片序列为00011011的站点码片记作$(-1,-1,-1,+1,+1,-1,+1,+1)$。

任意两个站点的码片序列$S,T$正交：它们的内积为零。
$$
S\cdot T=0
$$
站点码片的规格化内积为1：
$$
S\cdot S=\dfrac{1}{8}\sum_{i=1}^8 S_i^2=\dfrac{1}{8}\cdot 8=1
$$
设$S=(-1,-1,-1,+1,+1,-1,+1,+1)$和$T=(-1,-1,+1,-1,+1,+1,+1,-1)$，若$S$所在的站点发送比特1，同时$T$所在站点发送比特0，则公共链路上的码元：
$$
X=S+T=(0,0,-2,2,0,-2,0,-2)
$$

若第三个站点想获取$S$所在站点的信息，则它应当将链路上的码元与$S$作规格化内积：$X\cdot S=(S+T)\cdot S$，该内积的值的意义：
- 1：$S$所在的站点发送了比特1
- -1：$S$所在的站点发送了比特0
- 0：$S$所在的站点当前静默

### 随机访问介质访问控制

**随机访问**：不采用集中控制的方式解决发送信息的次序问题，用户可根据自己意愿随机发送信息，占用信道全部速率。

常用协议：ALOHA、CSMA、CSMA/CD、CSMA/CA。

协议的核心思想：
- 胜利者通过争用获得信道，从而获得信息的发送权（争用型协议）。
- 各结点之间的通信可以既不共享时间，也不共享空间。
- **本质**是将广播信道转化为点到点信道。

![[Pasted image 20230624091429.png]]

#### ALOHA协议

**纯ALOHA协议**：
基本思想：当网络上任何一个站点需要发送数据时，可以不进行任何检测直接发送。如果一段时间未收到确认，则认为传输冲突，站点等待一段时间后重传，直到收到确认为止。

特点：
- 互斥：如果两个站点发送数据的时间冲突，则均需要进行重传。
- 随机等待：一旦发生冲突，站点将等待随机的时间，这是为了防止冲突双方等待相同时间后再次冲突。

分析：
假设网络负载为$G$，则纯ALOHA网络的吞吐量为$S=Ge^{-2G}$。$S$在$G=0.5$时取得最大值$\dfrac{1}{2e}=0.184$，可见该网络的吞吐量很低。

![[Pasted image 20230624091447.png]]

**时隙ALOHA协议**：
基本思想：在ALOHA协议的基础上，规定各站点在时间上必须同步，将时间划分为等长间隙，规定只能在某个时隙开始时发帧。

特点：
- 与纯ALOHA相比，降低了冲突的可能性，提高了信道的利用率。

分析：
吞吐量$S$与网络负载$G$满足关系：$S=Ge^{-G}$，吞吐量最大值在$G=1$时取得：$S(1)=\dfrac{1}{e}=0.368$，比纯ALOHA高一倍。

#### CSMA协议

背景：ALOHA协议的低效源于各站点发帧都是随心所欲发送。如果各站点在发帧前监听一下信道，确保信道空闲再发送，则会进一步降低冲突可能，提高信道利用率。

**载波监听多路访问（Carrier Sense Multiple Access，CSMA）协议**是基于这一背景的协议，与ALOHA的区别即在各个站点内配置了一个载波监听装置。

分类：
- 1-坚持CSMA
- 非坚持CSMA
- p-坚持CSMA

**1-坚持CSMA**：

基本思想：
- 在站点想要发帧时，进入监听。
- 监听到信道空闲时，立刻发送数据。
- 如果信道繁忙，继续坚持监听信道。

特点：
- 受传播延迟影响较大。
- 多结点同时等待，会引起持续的信道冲突。

**非坚持CSMA**：

基本思想：
- 在站点想要发帧时，进入监听。
- 监听到信道空闲时，立刻发送数据。
- 如果信道繁忙，则暂时放弃监听，等待一段随机时间后恢复监听。

特点：
- 降低了多个结点等待信道空闲后同时发送数据导致冲突的概率。
- 但也会增加数据在网络中的平均延迟。

**p-坚持CSMA**：

是一种用于时分信道的CSMA协议。

基本思想：
- 在站点想要发帧时，进入监听。
- 如果信道忙，则持续监听（推迟到下一个时隙监听），直到信道空闲。
- 如果信道空闲，则有$p$的概率发送数据，有$1-p$的概率推迟到下一个时隙。

特点：
- 通过坚持监听，克服非坚持CSMA中由于随机等待造成的较大延迟时间
- 通过概率坚持，降低1-坚持CSMA中多结点同时发帧的冲突概率
- 是1-坚持CSMA和非坚持CSMA的折中方案

**对比**：
![[Pasted image 20230624093826.png]]

#### CSMA/CD协议

**载波监听多路访问/碰撞检测**（CSMA with Collision Detection，CSMA/CD）是适用于总线型网络或半双工网络环境的CSMA改进方案。

名词解释：
- 载波监听：每个站点在发送前和发送时都不停检测信道。
	- 在发送前检测：获取发送权。
	- 在发送时检测：及时发现是否发生了碰撞。
- 碰撞检测：边发送边监听，如果发生碰撞则立刻停止发送，并等待随机时间后重发。

工作流程：设AB之间的传输时延为$\tau$，$0<\delta<\tau$。
- 先听后发：$t=0$，站点A监听信道空闲，立刻发帧。$t=\tau -\delta$，站点B监听信道空闲，立刻发帧。$t=\tau-\delta/2$时，两帧发生碰撞。
- 边听边发：AB均在发帧的$2\tau$时间内（**争用期**，这个时间段内可能发生和探测到冲突）持续监听信道，准备应对冲突。
- 冲突停发：B在$t=\tau$时发现碰撞，停止发送；A在$t=2\tau-\delta$时发现碰撞，但此时已经传输完成，不能停传。
- 随机重发：[[#^3c2266|截断二进制指数退避算法]]。

![[Pasted image 20230624123448.png]]

机制：
- 冲突一定会在争用期内被通信各方得知。
- **最短帧长**：
	- 背景：如果帧长过短，无法在发送结束前得知是否发生了碰撞。
	- 概念：争用期内可发送的数据长度。
	- 原理：限制所有正常发送的数据帧必须大于某个长度。这样可以保证，所有小于这个长度的数据帧都是因检测到冲突而中断传输的无效帧。
	- 填充字段：如果确要发送低于最短帧长的帧，则需要补位凑齐最短帧长。
	- **计算公式**：最短帧长=总线传播时延\*数据传播速率\*2。
	- 以太网规定：争用期为51.2微秒，对于10Mbps的网络，最短帧长为64B。
- **截断二进制指数退避算法**：为避免无休止冲突，令双方各自退避随机时间，解决冲突。 ^3c2266
	- 原理：
		- 确定基本退避时间。一般取$2\tau$（即争用期）。
		- 定义参数$k=\min\{重传次数, 10\}$。重传次数超过10时，截断为10。
		- 从$[0,1,2,\cdots,2^k-2,2^k-1]$中随机取一个数$r$。本次重传所需的退避时间为$r$倍基本退避时间，即$2r\tau$。
		- 如果16次重传仍不能成功，则认为网络过于拥挤，抛弃该帧并向上层报错。
	- 作用：通过动态退避，降低了发生碰撞的概率，有利系统稳定。

**CSMA/CD协议归纳**：
- 准备发送：适配器从网络层获得一个分组，封装成帧，放入适配器的缓存。
- 检测信道：若检测到信道空闲，则开始发送这个帧；如果信道忙，则持续检测直到信道空闲，再开始发送这个帧。
- 发送过程中，继续检测：
	- 发送成功：争用期内未检测到冲突，说明这个帧抢占了信道，一定能发送成功。
	- 发送失败：争用期内检测到碰撞，则立即停止发送，适配器执行指数退避算法，等一段随机时间后重新检测信道、发送帧。如果连续16次失败，则停止重传并报错。

#### CSMA/CA协议

CSMA/CD不能用于无线局域网的原因：
- 接收信号的强度往往远小于发送信号的强度，在无线介质上信号强度的动态变化范围大，碰撞检测的成本过高。
- **隐蔽站问题**：并非所有站点都能够听见对方。

**载波监听多路访问/碰撞避免**（CSMA with Collision Avoidance，CSMA/CA）是适用于无线局域网的CSMA协议的改进协议。协议专注于尽量降低碰撞的可能性，而非完全规避碰撞。

链路层确认/重传方案（ARQ）方案：每个站点发无线局域网上的数据帧后，都必须得到确认才能发下一帧。

**帧间间隔**：
- IEEE 802.11规定：所有站点在发送完数据帧后，都必须等待一段很短的时间（继续监听），才能发送下一帧，该段时间称作帧间间隔。
- 间隔长度：取决于帧的类型。
- 类别：
	- **SIFS**（短IFS）：最短的IFS，用于分隔属于一次对话的各帧，使用的类型有ACK帧、CTS帧、分片后的数据帧、所有回答AP探询的帧等。
	- **PIFS**（点协调IFS）：中等长度IFS，在PCF操作中使用。
	- **DIFS**（分布式协调IFS）：最长的IFS，用于异步帧竞争访问的时延。

**退避算法**：与[[#^3c2266|截断二进制指数退避算法]]类似，有一些不同点。
- 争用窗口：信道从忙变为空闲时，任何站点要发数据帧，都要等待一个时间间隔，并进入争用窗口，计算随机退避时间以便再次接入信道。
- 不使用退避算法的情形：信道空闲，第一个数据帧
- 使用退避算法的情形：
	- 在发送第一个帧之前信道忙
	- 每次重传
	- 每次成功发送后发送下一帧

**CSMA/CA协议归纳**：
- 第一步（起步）：若站点最初有数据要发送（而不是发送不成功重传），且信道空闲，在等待DIFS后发送整个数据帧。
- 第二步（退避）：否则，站点执行CSMA/CA退避算法，选取随机回退值。一旦信道忙，退避计时器就保持不变；只要信道空闲，计时器就进行倒计时。
- 第三步（发送）：当退避计时器减到0时（此时信道一定空闲），站点发送整个帧并等待确认
- 第四步（继续）：发送站若收到确认，则知道发送帧已被正确接收；如果要发送第二帧，则从第二步开始执行CSMA/CA算法随机退避。

#### 隐蔽站问题及其处理：RTS/CTS

背景（**隐蔽站问题**）：
A和B站点都在AP的覆盖范围内，但A和B由于距离较远，听不见对方。当A和B检测到信道空闲，都向AP发送数据帧时，则会在AP处发生碰撞。

解决方案：通过控制帧对信道进行预约。
- RTS（Request To Send）帧：源站要发送数据帧前，先发RTS帧请求发帧，包括源地址、目的地址和通信持续时间。
- CTS（Clear To Send）帧：目标站收到RTS帧且信道空闲，则广播CTS帧，包括被许可发送的源站、发送持续时间。
	- 目的：给源站明确的发送许可，指示其他站点在预约期内不要发送。

以下图为例：A向AP发RTS，AP向A、B发CTS，A收到CTS后发数据帧，B收到CTS后推迟访问。
![[Pasted image 20230624123500.png]]

特点：
- 会使网络的通信效率有所降低，但在数据帧足够长时可以弥补隐蔽站问题引入的额外通讯成本。
- 不是强制性规定，各站可以决定用或不用信道预约。

### 轮询访问：令牌传递协议

**轮询访问**：用户不能随机发送信息，而必须通过集中控制的监控站，以循环方式轮询每个结点，再决定信道的分配。当某结点使用信道时，其他结点都不能使用信道。典型的轮询访问介质访问控制协议是令牌传递协议。

**令牌传递协议**：
- 令牌：一个沿着环形总线在各结点间依次传递的MAC控制帧。
	- 令牌不包含信息，只控制信道的使用，确保同一时刻只有一个站点独占信道。
	- 环上的站点必须等令牌到达，才能启动发送数据帧，包括目的站点地址和数据。
	- 站点发送数据帧后释放令牌，供下一个站点使用。
- 令牌和数据的传递过程：
	- 空闲：网络空闲时，只有令牌帧在循环游荡。
	- 发射：令牌传递到有数据要发送的站点时，站点就修改令牌中的一个标志位，并将数据附加到令牌上，将令牌变为数据帧发出去。
	- 传播：数据帧沿环路传输，沿途各点查这个帧是否是发给自己的，如否则转发，如是则复制该帧以便进一步处理。
	- 检验：数据帧最终返回源点，源点检查传输是否出错，如是则重传。
	- 释放：源点重新产生并释放令牌，交出信道控制权。

特点：
- 网络不必为物理上的环网，但逻辑上必须是环网。
- 适合负载很高（多个结点在同一时刻发送数据概率很大）的广播信道。
- 既不共享时间，也不共享空间，实质上是限制了各结点的发送权力。

## 局域网

### 基本概念和体系结构

**局域网**（Local Area Network，LAN）：在一个较小地理范围内，将各种计算机、外部设备和数据库系统等通过双绞线、同轴电缆等连接介质互相连接起来，组成资源和信息共享的计算机互连网络。

局域网主要特点：
- 为一个单位所拥有，地理范围和站点数目均有限。
- 所有站点共享较高的总带宽。
- 较低的时延和误码率。
- 各站为平等关系而非主从关系。
- 能进行广播和组播。

局域网特性三要素：
- **拓扑结构**：星形结构、总线形结构、环形结构、复合型结构（星形和总线形结合）。
- **传输介质**：双绞线、铜缆和光纤等。
- **介质访问控制方式**：CSMA/CD、令牌总线和令牌环等。

最常见的局域网拓扑实现：
- 以太网：逻辑拓扑是总线形结构，物理拓扑是星形或拓展星形结构。
- 令牌环（IEEE 802.5）：逻辑拓扑是环形结构，物理拓扑是星形结构。
- FDDI（光纤分布数字接口，IEEE 802.8）：逻辑拓扑是环形结构，物理拓扑是双环结构。

IEEE 802标准的局域网参考模型与OSI参考模型的对应关系：
- 物理层
- 介质访问控制子层（MAC）：向上屏蔽对物理层访问的各种差异：组帧、比特差错检测、透明传输等。
- 逻辑链路控制子层（LLC）：提供无确认无连接、面向连接、带确认无连接、高速传送四种连接服务。

### 以太网和IEEE 802.3

以太网：未加说明通常指符合IEEE 802.3标准的局域网，但严格讲也可以指符合DIX Ethernet V2标准的局域网。

**IEEE 802.3标准**：一种基带的总线形的局域网标准，描述物理层和数据链路层的MAC子层的实现方法。

特点：
- 逻辑结构：总线形。
- 方便性和可靠性：CSMA/CD方式。
- 通信简化措施：
	- 无连接的工作方式：不编号数据帧，不要求确认，尽最大努力交付数据，提供不可靠服务，由高层纠正差错。
	- 曼彻斯特编码：自带位同步。

**以太网的传输介质和网卡**：

根据传输介质和拓扑区分的各类**速率为10Mbps的**以太网：
- 总线形物理拓扑网络：
	- 10BASE5：基带同轴电缆（粗缆）、500m最大段长、最多100个结点。
	- 10BASE2：基带同轴电缆（细缆）、185m最大段长、最多30个结点。
- 星形物理拓扑网络：
	- 10BASE-T：非屏蔽双绞线、100m最大段长、2个结点。
- 点对点物理拓扑网络：
	- 10BASE-FL：850nm光纤对、2000m最大段长、2个结点。

**注意：这些必须背下来，作为做题常识。**

![[Pasted image 20230624142427.png]]

网络接口板（网络适配器，Adapter；或网络接口卡，NIC）：
- 角色：负责计算机与外界局域网连接的设备，是数据链路层设施。
- 功能：数据的串行-并行转换：
	- 与局域网通信：通过电缆或双绞线，串行方式。
	- 与计算机通信：通过主板I/O总线，并行方式。
- 功能细节：与局域网传输介质的物理连接和电信号匹配、帧的收发、封装、拆封、介质访问控制、数据的编码、解码、缓存等。
- **MAC地址**（物理地址）：全球唯一的设备地址，长6字节。
	- 高3字节：厂商代码。
	- 低3字节：厂商自行分配的网卡序列号。

**以太网的MAC帧**：
DIX Ethernet V2标准：
- 前导码：使收发两端时钟同步的8字节
	- 前7字节：前同步码，实现MAC帧的比特同步。
	- 后1字节：帧开始定界符，表示MAC帧的信息在其后面。
- 地址：6字节目的MAC地址，6字节源点MAC地址。
- 类型：2字节，指明应处理数据的协议实体。
- 数据：46-1500字节，高层协议消息。如果数据少于46字节，则进行填充。
	- 46字节的下限源于前面提到的CSMA/CD协议的最短帧长问题，如果帧过短则可能无法得知碰撞：争用期为51.2微秒，在10Mbps以太网下，整个帧必须不少于64字节。
- 校验码：4字节的CRC校验码，校验除前导码外的其余部分。

IEEE 802.3标准：
与DIX Ethernet V2标准总体相同，但将2个类型字节用于存储帧长度。

![[Pasted image 20230624150737.png]]

**高速以太网**：达到或超过100Mbps的以太网。
- 100BASE-T：
	- 传输介质：双绞线
	- 速率：100Mbps
	- 物理拓扑：星形结构
	- 通信方式：全双工、半双工
	- MAC协议：CSMA/CD（仅限半双工）
	- 最大电缆长度：100m
	- 帧间时间间隔：0.96微秒
- 吉比特以太网：1Gbps，全/半双工。
- 10吉比特以太网：10Gbps，**仅全双工模式**，使用光纤，不使用CSMA/CD。

### IEEE 802.11无线局域网

**无线局域网的组成**：有固定基础设施的无线局域网、无固定基础设施的无线局域网。

**有固定基础设施的无线局域网**： ^7d23bf

IEEE 802.1a/b/g/n：
- Wi-Fi：使用该协议的无线局域网
- 物理拓扑：星型拓扑
	- 中心点：接入点（AP），使用CSMA/CA协议
- 最小构件：基本服务集（BSS）

**基本服务集（BSS）**：
- 基本服务区：BSS覆盖的地理范围。
- 组成：
	- 基站：一个接入点
		- 安装时，为该AP分配一个不超过32字节的服务集标识符（SSID，即使用该AP的无线局域网名）和一个信道。
	- 若干移动站
- **分配系统**：基本服务集可以孤立，也可以通过AP连接到一个分配系统（Distribution System，DS），然后再连接到另一个BSS，构成一个扩展服务集ESS。
	- 作用：使ESS对上层表现为BSS。
	- 门户（Portal）：提供到有线连接的以太网的接入，相当于网桥。

![[Pasted image 20230624182738.png]]

**无固定基础设施移动自组织网络**：
自组织网络没有AP，而是由一些平等状态的移动站相互通信组成的临时网络。各结点之间地位平等，中间结点都为转发结点，都具有路由器的功能。

构成途径：
- 一些可移动设备发现附近的设备，要求通信。
- 自组网络中每个移动站都要参与其他移动站路由的发现和维护。网络拓扑变化可能很快，因此传统路由算法不适用。

与移动IP的区别：移动IP技术使漫游主机以多种方式联网，核心网络功能仍然是基于固定网络的路由协议；自组网络把移动性扩展到无线领域的自治系统（AS），具有自己特定的路由选择协议，且可以不和因特网相连。

![[Pasted image 20230624182748.png]]

**802.11局域网的MAC帧**：
类型：数据帧、控制帧、管理帧。

数据帧组成：
- MAC首部：30字节，最复杂。
	- 帧控制位：2字节16位。
		- 协议版本：2位。
		- 类型：2位。
		- 子类型：4位。
		- 去往AP：1位。
		- 来自AP：1位。
		- 更多分片：1位。
		- 重试：1位。
		- 功率管理：1位。
		- 更多数据：1位。
		- WEP：1位。
		- 顺序：1位。
	- 持续期：2字节。
	- 地址1：6字节。
	- 地址2：6字节。
	- 地址3：6字节。
	- 序号控制：2字节。
	- 地址4：6字节。
- 帧主体：0-2312字节。
- 帧检验序列（FCS）：4字节CRC校验码。

![[Pasted image 20230624182806.png]]

四个地址：
- 地址的含义：
	- 地址1：直接接收数据帧的结点地址。
	- 地址2：实际发送数据帧的结点地址。
	- 地址3：冗余。
	- 地址4：只用于自组网络。
- 地址的取值：MAC帧按照与AP的关系可分为去往AP和来自AP。前三个地址的取值因这种关系而不尽相同。
	- 来自AP：地址1=目的地址，地址2=AP地址，地址3=源地址
	- 去往AP：地址1=AP地址，地址2=源地址，地址3=目标地址

### VLAN基本概念与基本原理

背景：以太网是一个广播域，当入网设备过多时，容易导致网络中出现大量的广播帧，影响通讯效率；一个单位的不同部门共享局域网，也会引入安全隐患。

虚拟局域网（Virtual LAN，VLAN）：
- 原理：将一个较大的局域网分割成一些较小的与地理位置无关的逻辑上的VLAN，而每个VLAN是一个较小的广播域。
- 支持VLAN的以太网帧：
	- 标准：IEEE 802.3ac。
	- 与传统以太网帧的区别：插入了4字节的VLAN标签。
		- 802.1Q标签类型：2字节（0x8100）；
		- 标签控制信息：2字节。
			- 预留4位。
			- VLAN标识符VID：12位。
- 本质：VLAN不是一种局域网，而是一种局域网服务。

## 广域网

### 广域网基本概念

- 概念：覆盖范围很广的长距离网络。
- 任务：因特网核心，长距离运送主机所发送的数据。
- 组成：
	- 结点交换机：分组存储和转发。
	- 交换机链路：光缆、卫星链路等光缆线路
- 层次：广域网协议大多位于网络层
- 重要问题：路由选择、分组转发。

![[Pasted image 20230624202118.png]]

### PPP协议

**点对点协议（PPP）**：
- 定义：使用串行线路通信的面向字节的协议。
- 设计目的：通过拨号或专线建立点对点连接发送数据，使其成为各种主机、网桥、路由器之间简单连接的一种共同的解决方案。
- 组成部分：
	- 链路控制协议（LCP）：建立、配置、测试、管理数据链路。
	- 网络控制协议（NCP）：为网络层协议建立和配置逻辑连接。
	- 一个将IP数据报封装到串行链路的方法。

PPP帧格式：
- 标志字段F、地址字段A、控制字段C：3字节
- 协议字段：说明信息部分运载什么种类的分组，2字节。
- 信息段：0-1500字节，带转义机制。
- FCS：2字节CRC冗余码。
- 标志字段F：1字节。

![[Pasted image 20230624202719.png]]

PPP协议特点：
- 提供差错检测但不提供纠错，只保证无差错接收。
- 仅支持点对点通信，不支持多点线路。
- 只支持全双工链路。
- 两端可以运行不同的网络层协议，但仍可以使用同一个PPP通信。
- 面向字节，当信息字段和标志字段F出现一致比特组合时，采用字符填充或比特填充进行规避。

### HDLC协议

23大纲不再考察。如果24恢复考察，看计网P119。

## 数据链路层设备

### 网桥

23大纲不再考察。如果24恢复考察，看计网P122。

### 局域网交换机（以太网交换机）

**以太网交换机**：
- 本质：多端口网桥
- 原理：
	- 检测从以太端口来的数据帧的源和目的地的MAC地址，然后与系统内部的动态查找表进行比较。
	- 如果MAC地址不在查找表，则将该地址加入查找表，并将数据帧发往目的端口。
- 作用：管理开销低廉，简化网络变化的操作，实现VLAN方便。

交换机的特点：
- 每个以太网交换机的端口都直接与某台主机相连，一般均为全双工。
- 能同时连通多对窗口，使每对相互通信的主机都能像独占通信媒体那样，无碰撞地传输数据。
- 是一种即插即用设备，内部的帧的转发表是通过自学习算法逐步建立的。
- 由于使用专用的交换结构芯片，交换速率较高。
- 独占传输媒体的带宽。

两种交换模式：
- 直通式交换机：只检查目的地址，快但安全性低。
- 存储转发式交换机：先缓存、检查、确认，再查表发出，可靠性高但延迟较大。

**交换机的自学习功能**：
- 基本操作：
	- 过滤：决定一帧应当转发到某个端口还是丢弃。
	- 转发：决定一个帧具体发送到哪个端口。
- 交换表：维护一组转发表项。
	- MAC地址。
	- 连通该MAC地址的交换机端口。
- 流程：
	- 如果交换机不认识发送方MAC地址，则会主动登记。
	- 如果交换机不认识接收方MAC地址，则会广播。