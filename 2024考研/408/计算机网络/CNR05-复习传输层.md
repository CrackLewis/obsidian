
## 框架

- 传输层服务：功能、寻址与端口、无连接和面向连接服务
- UDP：UDP数据报、UDP校验
- TCP
	- TCP段
	- TCP连接管理
	- TCP可靠传输
	- TCP流量控制和拥塞控制

## 传输层的功能

- 提供进程之间的逻辑通信
- 复用和分用
- 差错检测
- 两种传输协议：UDP、TCP

### 端口、套接字

**端口**：每台主机上的一系列传输层服务接入点（SAP）。

**端口号**：唯一标识一个主机应用进程，0-65536

**套接字**：`(IP地址,端口号)`。

## 常见的TCP、UDP端口号

[IANA的端口全表](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)

- 常考：
	- FTP（数据连接）：20
	- FTP（控制连接）：21
	- TELNET：23
	- SMTP：25
	- DNS：53
	- TFTP（简单文件传输协议）：69
	- HTTP：80
	- SNMP（简单网络管理协议）：161
- 非常考：
	- Echo：7
	- SSH：22
	- WHOIS：43
	- Gopher：70
	- NIC：101
	- POP3：110
	- SQL：118
	- BGP：179
	- IMAP：220
	- HTTPS：443
	- RPC：530

## UDP

**特点**：无连接、首部开销小、支持组播、面向报文、不保证可靠交付。

### UDP首部

![[Pasted image 20231005011831.png]]

### UDP校验

**特点**：既检验首部也检验数据，简单快速，处理方式灵活。

**发送流程**：
- 校验和字段置0，添加伪首部：
	- 12B伪首部：源IP、目的IP、1B全零填充、1B（17）、2B的UDP长度
- 如果临时数据报是奇数字节，则补一个空字节
- 按二进制反码，从头算各个16bit的数据和，将此和二进制反码写入校验和字段
- 去除伪首部，发送剩余部分

**校验流程**：
- 接收方将UDP数据报加上伪首部，补齐为偶数字节
- 按二进制反码求各16bit的和
- 计算结果全1则无差错，否则有差错

![[Pasted image 20230708110716.png]]

![[Pasted image 20230708110738.png]]

## TCP

**特点**：面向连接、只能是点到点、可靠交付、全双工通信。

### TCP报文段

![[Pasted image 20231005100525.png]]

**首部部分字段含义**：
- 序号：首个数据字节在TCP字节流中的序号，4B。
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号，4B。只有ACK=1时有效。
- 数据偏移：4bit，表示首部长度，单位是4B。
- 控制位：共6bit，细节见上图。
- 窗口：允许对方发送的数据量，2B。
- 校验和：2B。校验方法和UDP相同。
- 紧急指针：本报文段中从头算起，有多少字节的紧急数据，2B。只有URG=1时有效。

### TCP连接管理-三次握手

![[Pasted image 20231005101528.png]]

**阶段判断**：
- 不带数据，必须消耗一个序号：R1、R2。
- 可以带数据，如果不带则不消耗序号：R3。
- 客户端分配资源：R3。
- 服务端分配资源：R2。
- SYN=1：R1、R2。
- SYN=0：R3。
- ACK=1：R2、R3。
- ACK=0：R1。

**状态和含义**：
- CLOSED：S/C还未打开。
- LISTEN：S监听来自C的连接请求。
- SYN-SENT：C已经发送连接请求，但未收到S的确认。
- SYN-RCVD：S已经收到C的连接请求，但未收到C的二次确认。
- ESTABLISHED：S/C建立连接。

**采用三次握手的原因**：如果采用两次握手，则可能出现连接请求报文迟滞重传，造成服务器两次应答的情形，会造成服务器的资源浪费。

### TCP连接管理-四次挥手

![[Pasted image 20231005101600.png]]

**阶段判断**：
- FIN=1：R1、R3。
- FIN=0：R2、R4。
- ACK=1：R2、R3。
- ACK=0：R1、R4。
- 客户端释放资源：R2。
- 服务端释放资源：R4。

**状态和含义**：
- FIN-WAIT-1：C等待S确认自己的连接释放请求。
- FIN-WAIT-2：C接收S发送的剩余数据，并等待S释放连接。
- CLOSE-WAIT：S确认C的连接释放请求后，发送剩余数据。
- LAST-ACK：S释放连接，等待C最后确认。
- TIME-WAIT：C等待2MSL，确保S收到了自己的最后确认。
- CLOSED：连接结束。

**采用四次挥手和等待2MSL的原因**：
- 保证C最后一次确认能到达S。如果对方没要求重传，则说明最后一次确认被收到了；如果有重传要求，则必发生在2MSL之内。
- 防止出现“已失效的连接请求报文段”。TCP是全双工协议，一端主动断开后另一端可能仍有数据，所以两边需要分别设置断开的机制，总共是四次挥手。

### TCP可靠传输

**手段**：校验、序号、确认、重传。

**校验**：TCP校验。

**序号**：TCP连接对数据流的每个字节编号。

```
(seq=2,len=4),(seq=6,len=3),(seq=9,len=4),...
```

**确认**：累积确认。

**重传**：
- 超时：对每个报文设置计时器，超时则重传。
	- 往返时间（RTT）：报文段发出到收到确认的时间差。
	- 加权平均往返时间（RTTs）：由TCP自适应算法维护的一个RTT加权平均值。
	- 关系：RTT略大于RTTs。
- 冗余ACK：对每个失序报文段发一个冗余ACK，连收3个相同的冗余ACK则立即重传。

**滑动窗口算法**：GBN和选择重传的混合体。

**超时和冗余ACK哪个更严重**：
- 冗余ACK：虽然有失序数据报，但至少它们都到了，说明还好，只需要重传即可。
- 超时：有数据报丢了或者坏了，显然更严重，除了重传外，拥塞窗口还要重设为1。

### TCP流量控制

**目的**：抑制发送方的发送速率，匹配发送方的发送速率和接收方的接收速率。

**接收窗口**（rwnd）：接收方允许接收的数据大小，单位为B或MSS。

**拥塞窗口**（cwnd）：发送方根据对网络拥塞情况的估计确定的可发送数据量，单位为B或MSS。

![[Pasted image 20231005144353.png]]

**与链路层流量控制功能的区别**：传输层控制端到端的流量，链路层控制两个相邻节点间的流量。

### TCP拥塞控制

**与流量控制对比**：
- 相似点：都控制发送方的发送数据速率。
- 不同点：拥塞控制是网络畅通问题，流量控制是端点协调问题。

**发送窗口**：取rwnd和cwnd的最小值。

#### MSS（最大报文段长度）

有时可用作拥塞窗口、接收窗口和发送窗口的单位。

**MSS过大的影响**：无明显的负面影响，但注意整个IP数据报不要超过以太网MAC帧的MTT（1500B）。

**MSS过小的影响**：IP和TCP首部的占比过大，会降低网络的数据率。

#### 慢开始和拥塞避免（Tahoe）

**步骤**：
- 初始阶段：拥塞窗口`cwnd=1MSS`，慢开始门限`ssthresh=N`
- 慢开始阶段：
	- 发送cwnd个数据报
	- 若数据报全部ack，则置`cwnd=min(cwnd*2,ssthresh)`，否则进入拥塞阶段
		- 期间`cwnd`可能采用逐渐增大的模式，具体看题目要求
	- 若cwnd达到ssthresh，则进入拥塞避免阶段，否则重复该阶段
- 拥塞避免阶段：
	- 发送cwnd个数据报
	- 若数据报全部ack，则置`cwnd=cwnd+1`并重复该阶段，否则进入拥塞阶段
- 拥塞阶段：
	- 置`ssthresh=max(2,ssthresh/2)`，`cwnd=1MSS`。
	- 执行慢开始阶段。

![[Pasted image 20231005151724.png]]

#### 快重传和快恢复（Reno）

**快重传**：冗余ACK机制。

**快恢复**：跳过拥塞后的慢开始阶段，直接从`cwnd=ssthresh`开始。

![[Pasted image 20231005152607.png]]

## 选择题整理-非真题

### 5.1-传输层的功能

![[Pasted image 20231005152806.png]]

9题选D。FTP有两个常用端口：数据端口20，控制端口21。

### 5.2-UDP

![[Pasted image 20231005152957.png]]

4题选D。UDP数据报中的长度字段包括了首部和数据部分。

![[Pasted image 20231005153021.png]]

7题选A。UDP并不保证可靠传输，所以通常采取丢弃的方法。

![[Pasted image 20231005153052.png]]

10题选D。A、B项，C/S模式或RPC下的请求一般很短，没必要用TCP；C项，实时多媒体一般要求及时传送数据，可以容忍比例不大的错误，因此UDP仍是合适的，且UDP支持给多个客户端服务；D项，远程登录一般依赖可靠连接，不适用UDP。

### 5.3-TCP

![[Pasted image 20231005154329.png]]

6题选B。发送窗口表示发送端自行估计的发送能力，单位为B。

7题选C。确认号确认的是最后一个正确接收的字节编号。

![[Pasted image 20231005154538.png]]

9题选C。发送方的窗口大小一般不受发送方的发送能力制约，主要取决于接收窗口和拥塞窗口。

![[Pasted image 20231005154654.png]]
![[Pasted image 20231005154703.png]]

**13题选A**。B项，产生过多的ACK一般是**窗口值太小**的体现；C、D项，接收的数据多少一般不会影响主机的工作速度；A项，**窗口值太大**会使发送方不受限地发送数据，路由器会变得拥挤，主机可能丢失分组。

![[Pasted image 20231005155256.png]]

17题选C。seq字段的意思是该数据报的第一个字节编号，ack字段的意思是希望收到的下一个字节编号。

![[Pasted image 20231005155815.png]]

19题选C。

![[Pasted image 20231005155859.png]]

21题选C，易错选B。注意第13次传输已经第二次进入了拥塞避免阶段：1、2、4、8、9、10、11、12、1、2、4、6（进入拥塞避免阶段）、7。

![[Pasted image 20231005160520.png]]

25题选A。TCP连接建立后端口会被占用，建立连接的尝试会失败，但不会影响先建立的连接。

## 选择题整理-真题

![[Pasted image 20231005153606.png]]

12题选B。**传输层分用**的定义是，接收方的传输层剥去报文首部后，能把这些数据正确交付到目的进程。在目的主机传输层正确标识一个进程的字段有且仅有**目的端口号**，其他字段不符合题意。

![[Pasted image 20231005161439.png]]

35题选C。注意任何冗余的ACK连续出现三次则会立刻触发重传，无论是否超时。尽管t0时刻有一次ACK，但那次ACK不是冗余的。

![[Pasted image 20231005161942.png]]

39题选B。客户端在四次挥手中会依次经历FIN-WAIT-1、FIN-WAIT-2、TIME-WAIT三个阶段，其中在最后一次发送确认后，会在TIME-WAIT状态等待两个MSL。

![[Pasted image 20231005163044.png]]
（注意第二行MSL=80ms是印刷错误，实为800ms）

43题选D。最理想的情况是四次挥手中间，服务器不发送任何数据。此时C端需要等待RTT+2MSL=1650ms，S端需要等待1.5RTT=75ms。

## 大题整理

### 2012：IP分组、TCP报文段、以太网最短帧长、TCP连接管理

![[Pasted image 20231005163438.png]]
（IP分组头和TCP段头结构图略）

第一问：
- 第1、3、4个IP分组是H发送的。
- 第1、2、3个IP分组完成了TCP连接的建立过程。
- 低于46B的IP数据报必须通过填充补到46字节以上，才能在以太网上传输。通过观察IP数据报的总长度字段可知，第3、5个IP分组原始长度只有40B，进行了填充。

第二问，16B。

第三问，经过了15个路由器。

### 2016：TCP连接管理、TCP拥塞控制、平均传输速率

![[Pasted image 20231005165753.png]]

第一问，SYN=1，ACK=1，确认序号为101。

第二问：
- 接收窗口为12KB。
- **拥塞窗口为9KB**。MSS=1KB，因此是从1KB的拥塞窗口开始执行的。传输第8个MSS时，拥塞窗口为8KB，传输完毕后扩大至9KB。
- 发送窗口为9KB。

![[Pasted image 20231005172313.png]]

**第三问**：
- 下一个待发送的数据段序号是20581。
- 传输全部20KB耗费5个RTT，即数据传输速率是20KB/s=163.84Kb/s。

第四问，服务器S释放连接的最短时间是1.5RTT=300ms。