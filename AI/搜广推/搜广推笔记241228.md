
ref：
- [知乎-1](https://zhuanlan.zhihu.com/p/678664853)

## 推荐系统概要

推荐系统=给用户推荐实体或非实体物品的系统
- 根据用户和物品的特征，使用某种或某些[推荐算法](https://zhida.zhihu.com/search?content_id=238944409&content_type=Article&match_order=1&q=%E6%8E%A8%E8%8D%90%E7%AE%97%E6%B3%95&zhida_source=entity)预测任意用户对任意物品的兴趣得分，并按照预测的得分顺序，将排在前列的物品展示给用户

评测指标：
- 消费指标：点击率、点赞/收藏/转发率、完成阅读率
- 北极星指标：日活/月活、人均使用时间、人均发布量

实验流程：离线测试-小流量A/B测试-全流量上线

推荐系统链路：
- 目标：几十亿数据选几十个推给用户
- 链路：
	- 召回：用多条*召回通道*（协同过滤、双塔模型、关注列表）选出数千个物品
	- 粗排：小规模神经网络给物品打分，选出top数百的物品
	- 精排：大规模神经网络重新打分
	- 重排：多样性抽样从几百篇物品中挑选几十篇，依规则打散，并插入广告和运营物品，根据生态再调整排序

A/B测试：考察召回团队实现的召回通道对线上指标的影响，测试选择模型的最优参数。

*随机分桶*：A/B测试的一步，将$n$个用户根据其哈希值均分入$m$个桶
- 实验组：取若干个桶作为多个实验组采用不同的召回通道
- 对照组：另取一个其它桶作为对照组使用原策略
- 计算业务指标，如果某个实验组显著优于对照组，则说明策略有效

*分层实验*：
- 流量分为召回、粗排、精排、重排、UI、广告等若干层
- 同层互斥：某个召回实验只能使用一个桶子集，同层不同实验的桶子集互斥
- 不同层正交：每层都可以独立分桶，并使用所有桶进行实验

是否存在所有实验都正交，则可以同时做无数组实验的情况呢？答案是否定的：
1. 同类的策略（比如召回层的不同通道）天然互斥，对于同一用户只能使用其中一种；  
2. 同类的策略可能相互抵消或相互增强，互斥可以避免同类策略相互干扰；  
3. 不同类的策略（比如添加召回通道和优化粗排模型）会通常不会相互干扰，才可以做正交的两层。

Holdout机制：
- 取10%的用户作为Holdout桶，不参与推荐系统实验，一个考核周期后用于和实验组对比业务指标收益
- 考核周期结束后，实验推全到100%用户，重新划分Holdout桶

实验推全、反转实验：
- 实验推全：如果某个策略明显提升了效果，则关闭A/B测试，策略推全到90%用户（即实验组）。此时需要在召回层前建立推全层，该层与其他层正交
- 反转实验：在实验推全的新层中设立一个旧策略的桶，用于观测一些长期的实验指标
	- 注意：反转桶也包含在实验组，不是Holdout桶

![[Pasted image 20241228183256.png]]

## 第一个流程：召回

- 基于统计学
- 基于规则
- 基于神经网络

### 协同过滤ItemCF

基本思想：如果一个用户喜欢物品$x_1$，而$x_1,x_2$相似，则用户很有可能也喜欢$x_2$。

基本步骤：
- 基于转化流程中的动作，计算用户对物品的兴趣分数$L(u,x_i)$
- 离线计算物品相似度$S(x_i,x')$
- 线上预估用户对候选物品的兴趣$\sum_i (L(u,x_i)\times S(x_i,x'))$

*物品相似度*：设喜欢$x_1$的用户群体为集合$W_1$，喜欢$x_2$的用户群体为$W_2$，则$x_1,x_2$的相似度为：
$$
S(x_1,x_2)=\dfrac{|W_1\cap W_2|}{\sqrt{|W_1|\cdot |W_2|}}\in [0,1]
$$
考虑到喜欢程度的高低也有影响：
$$
S(x_1,x_2)=\dfrac{\sum_{v\in W_1\cap W_2} L(v,x_1)\cdot L(v,x_2)}{\sqrt{\sum_{w_1\in W_1} L^2(w_1,x_1) }\cdot \sqrt{\sum_{w_2\in W_2} L^2(w_2,x_2)}}\in[0,1]
$$

*ItemCF召回流程*：
- 事先离线计算：
	- 建立用户到物品的兴趣索引：$L(u,x_i)$
	- 建立物品间的相似度索引：$S(x_1,x_2)$。记录相似度最高的$k$个物品
- 基于索引的线上召回：
	- 计算用户近期感兴趣的物品列表$last_n$
	- 对于$\forall x \in last_n$，通过$S(x,\cdot)$找到前$k$个相似的物品
	- 对于所有被找到的物品（不超过$nk$个），用公式估计用户的兴趣分数
	- 返回被找到的物品中，得分最高的若干个物品，作为查询结果

*Swing召回通道*：
- 问题：如果同时喜欢$x_1,x_2$的群体是一个小团体，而$x_1,x_2$的受众几乎完全不同，则ItemCF会造成误判
- 设$u_1,u_2$喜欢的物品集合为$J_1,J_2$，喜欢物品$x_1,x_2$的用户集合为$W_1,W_2$，则：
	- 用户的重合度：$O(u_1,u_2)=|J_1\cap J_2|$。如果用户重合度高，则他们可能来自一个小团体，需要降低他们的权重
- 物品相似度的修正计算：$S(x_1,x_2)=\displaystyle\sum_{u_1,u_2\in W_1\cap W_2} \dfrac{1}{\alpha+O(u_1,u_2)}$，其中$\alpha$是小常量

### 基于用户的协同过滤UserCF

基本思想：相似的用户很可能喜欢相同的物品

步骤：计算用户对物品的兴趣分$L(u_i,x)$，离线计算目标用户与各用户的相似度$S(u_i,u')$，最后计算目标用户$u'$对物品的兴趣分：
$$
L(u',x)=\sum_j (L(u_i,x)\times S(u_i,u'))
$$

*用户相似度*：
$$
S(u_1,u_2)=\dfrac{\sum_{i\in I} \frac{1}{\log (1+n_i)}}{\sqrt{|J_1|\cdot|J_2|}}
$$
其中$i\in I$是任意物品，$n_i$为喜欢物品$i$的用户数。设置反对数项的目的在于削弱热门物品，以体现用户的独特兴趣。

*UserCF召回的全流程*：
- 先离线计算：用户到物品的兴趣分数索引、用户到用户的相似度索引
- 后线上召回：
	- 先计算与用户最相似的$k$个用户，再通过用户-物品索引找到用户可能感兴趣的$nk$个物品
	- 取分数最高的若干物品作为返回结果

### 矩阵补全、最近邻查找

离散特征处理：
- 先字典化：将特征映射为序号
- 向量化：将序号映射为向量，包括
	- One-Hot编码：高维稀疏向量
	- Embedding（嵌入）：低维稠密向量（更常用）

矩阵补全示例：（下图为物品embedding参数矩阵）

![](https://pic2.zhimg.com/v2-a1a0e185e7025272b75fdf8a403bfd4f_1440w.jpg)

*矩阵补全*：设用户数为$n$，物品数为$m$
- 用户embedding参数矩阵为$A_{m\times n}$，每列代表一个用户
- 物品embedding参数矩阵为$B_{n\times m}$，每列代表一个物品
- 用户映射向量$a_u$与物品映射向量$b_x$进行叉积，即表示$u$对$x$兴趣的近似值
- 训练目的：训练$A,B$使得兴趣估计值误差最小化：$\min_{A,B} \sum_{(u,x,y)\in \Omega} (y-a_u^T b_x)^2$
- 核心思想：只有曝光给用户的物品有分数。因此矩阵补全利用这些分数训练模型，再通过模型预估未知的兴趣分数

为什么矩阵补全不理想：
- 仅使用ID作embedding不理想
- 余弦相似度比内积更佳，交叉熵损失比MSE更佳

*最近邻查找*：设用户、物品embedding矩阵为$A,B$。
- 根据用户ID查到用户向量$a_u$
- 查找用户最可能感兴趣的$k$个物品，作为召回结果：
	- 设物品embedding为$b_i$
	- 返回$a_u^Tb_i$（或余弦相似度）最大的$k$个物品

为什么最近邻查找也不行：时间复杂度过高，正比于物品数量

### 双塔模型



### 自监督学习

### 其他召回通道

其他的简单召回通道：
- GeoHash召回
- 同城召回
- 作者召回
- 有交互的作者召回
- 相似作者召回

*缓存召回*：复用前$n$次推荐精排但没有曝光的结果，将它们缓存起来，作为一条召回通道。

*退场机制*：缓存的推荐结果并不能累积增加，需要在特定条件下被移除：
- 成功曝光，或被召回一定次数，或被保存若干天
- 缓存已满，且是最先进入缓存的结果

### 曝光过滤、Bloom Filter

曝光过滤的目的：过滤一些用户已经被推送的内容

*Bloom Filter*：通过哈希方法检测用户是否“可能访问”过某些物品
- 对每个用户维护一个$m$维二进制向量
- 对于访问过的物品$x$，用$k$个哈希函数计算出数个$[0,m)$内的哈希值，将向量的对应位置设为1
- 对于需要判断是否访问过的物品$x'$，若其$k$个哈希值对应的向量位置均为1，则认为它“可能被访问”过，因此被过滤掉
- 误伤概率：设物品数$n$，则概率$\delta\simeq (1-e^{-\frac{kn}{m}})^k$。

![](https://pic1.zhimg.com/v2-3ba2c11c2844ca59003dd61a93380352_1440w.jpg)

Bloom Filter缺点：
- 没有办法移除一个物品，只能全盘清空

### 召回-总结

WIP

## 排序