
## 总体设计

### 可行性分析（略）

### 需求分析

#### 功能需求

平台需作为显示终端程序的一部分或主体，并实现如下功能：
- 接收并解析主控程序发送的动态地图样式描述，包括动态地图的结构描述和所使用的字体、图像等文件。
- 接收并解析主控程序发送的动态地图线路数据，包括线路的名称、主题色、沿线各站中英文名、线路拓扑结构等信息。
- 根据解析完毕的动态地图样式描述和线路数据信息，实现线路动态地图的自动生成和在终端上的显示。
- 接收并解析主控程序发送的列车实时状态信息，包括日期时间、列车位置、到站状态、开门侧、车门状态、紧急广播等信息，并根据这些信息更新动态地图。
- 拉取动态地图需要拉取的视频流，并正确呈现在动态地图的对应位置。

为进行功能验证，需要编写能够与平台通信的主控系统模拟程序，主控系统模拟程序需完成如下功能：
- 发现程序主机所在广播域内的显示终端，并建立与这些终端的连接。
- 选取存储在本地的动态地图样式描述和样式数据，发送给显示终端。
- 通过操作程序界面修改列车的实时运行状态，并以定时自动发送和手动发送两种方式发送运行状态给显示终端。
- 向显示终端通知视频流地址，以便显示终端启动拉流；实现本地文件的推流功能，以便测试视频流功能。

本文所称主控程序，均指车载PIS主控系统模拟程序，不考虑轨道交通指挥中心PIS、多线路中心PIS、单线路中心PIS等高级PIS主控系统的影响。

本文所称地图平台、地图生成平台、动态地图平台、动态地图生成平台，均指地铁动态地图自动生成平台。

#### 技术需求

平台需运行于x86或ARM架构的通用计算机和嵌入式计算机下，主机应至少具备2个处理器核心和4GB内存，操作系统为Linux。主控程序需运行于x86架构的通用计算机下，主机应至少具备4个处理器核心和8GB内存，操作系统为Windows或Linux。

平台所在主机需要与主控程序处于同一广播域，以便与主控程序实现信息交换。平台和主控程序需要实现基于TCP套接字的网络连接，通过可靠连接传输动态地图的样式描述、线路数据等内容；需要实现广播或组播套接字，通过该套接字进行网络发现、定期点名和发送列车实时状态等操作。

考虑到平台可能需要在动态地图内播放视频，故平台需要根据主控程序的指令拉取网络视频流并逐帧转码为合适的图像格式，以便在地图界面上实时显示，与此同时主控程序需要通过网络指令实现视频流的播放控制。

### 总体设计方案

动态地图生成平台为Qt Quick程序，运行于显示终端，除连接到终端显示屏外，还通过TCP和UDP端口连接到网络上的主控程序。TCP端口负责传输样式描述、线路数据等高可靠性要求的数据；UDP端口负责通过主控程序指令建立和维护连接，同时传输列车运行状态等低可靠性要求的数据。

主控程序为Qt Widget程序，运行于车载通用计算机，该计算机应在本地存储地图生成所必需的样式描述文件和线路数据文件，并确保与各显示终端连接到同一局域网。主控程序维护一个存有与各显示终端连接的TCP连接池用于发送可靠数据，另维护一个UDP端口用于发送连接指令和列车状态数据。

动态地图生成平台设计为5个子模块：
- 样式描述解析模块：从TCP端口接收并解析样式描述文件，解析结果呈递地图生成模块。
- 线路数据解析模块：从TCP端口接收并解析线路数据，解析结果呈递地图生成模块。
- 列车状态解析模块：从UDP端口接收并解析列车的实时运行状态，根据运行状态更新动态地图中的对应内容。
- 视频流拉取模块：根据主控程序的命令创建或销毁拉流线程，拉流线程负责拉取指定网络地址的RTSP视频流，并将视频帧转码为RGB图像显示于动态地图的指定位置。
- 地图生成模块：根据解析模块的解析结果，运用动态地图生成算法生成动态地图，将地图全屏显示于显示终端。

主控程序设计为用户界面和4个子模块：
- 用户界面：为程序各项主要功能提供可操作图形化界面。
- 样式描述加载模块：从用户指定的本地目录加载样式描述文件，通过TCP端口发送。
- 线路数据加载模块：从用户指定的本地目录加载线路数据文件，通过TCP端口发送。
- 列车状态发送模块：以定时自动发送或手动发送方式之一，将当前的列车运行状态通过UDP端口组播发送。
- 视频流控制模块：通过UDP端口发送视频流创建和销毁命令；允许从指定的本地视频启动RTSP推流。

### 总体设计框图

根据前文的总体设计方案，绘制总体设计框图如下所示：

![[cumulative_design.png]]

## 详细设计

基于前面的总体设计部分，对各模块进行详细设计如下。

### 程序流程设计

主控程序和地图生成平台都通过有限状态机实现程序流程的控制。在任一时刻，程序必处于一个合法状态，而在指定的事件发生时，会迁移到另一个合法状态。

主控程序的UML状态图如下所示：

![[controller_fsm.png]]

主控程序共设6个主要状态，包括复位状态、4个准备状态和运行状态。

复位状态是程序的初始状态，也是为程序方便使用设计的一种特殊状态。在程序处于任意的其他状态时发出复位指令，均可使程序转换为复位指令。转换为复位状态时执行的操作包括但不限于：断开所有活动的TCP连接，恢复界面为初始状态，对所有变量赋予初始值。复位状态下可通过发现流程建立与显示终端的连接，从而转移到准备状态，发现流程的细节在网络接口设计部分阐述。

准备状态根据主控程序是否传送了样式描述和线路数据，分为4个子状态。完成样式描述文件和线路数据文件的传送会使程序最终转移到就绪状态，就绪状态时执行启动命令可转换为运行状态。

运行状态下，主控程序可向显示终端发送列车运行状态，可执行视频流的建立和销毁等命令。

动态地图生成平台的UML状态图如下所示：

![[display_fsm.png]]

与主控程序类似，动态地图生成平台也设6个主要状态：复位指令、运行状态和4个准备状态，准备状态也根据是否收到样式描述和线路数据区分。不同的是：复位状态需通过主控程序断开连接触发；在主控端执行启动指令后，地图平台不会立即开始运作，而是会推迟到首次接收到列车运行状态时生成并显示地图。

### 网络接口设计

主控程序维护3个网络设施：
- TCP监听套接字：建立在主机的固定端口上，监听来自显示终端的连接请求。用QTcpServer实现。
- TCP连接池：存储与每个显示终端的TCP连接。用从套接字地址到QTcpSocket指针的带锁哈希表实现。
- UDP套接字：加入组播组，向组内的显示终端发送连接命令和列车状态数据。用QUdpSocket实现。

地图生成平台维护两个网络设施：
- TCP套接字：与主控程序连接，接收样式描述和线路数据。用QTcpSocket实现。
- UDP套接字：加入组播组，接收主控程序发送的连接命令和列车状态数据。用QUdpSocket实现。

主控程序与地图生成平台通过“发现”方式建立连接，这种方式借鉴了动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）的思想：
- 主控程序每隔200ms，通过UDP套接字发送一个“发现”报文，报文内有识别校验字段和主控程序监听套接字的IP、端口号，总共发送10次。
- 地图生成平台在首次接收到“发现”报文时，通过该监听套接字请求建立TCP连接，主控程序验证后将连接加入TCP连接池。
- 发出发现指令3s后，停止发现流程，如连接到显示终端，则主控程序进入已连接状态，否则仍为复位状态。

在TCP套接字上传送大量数据可能遇到分片问题和粘包问题：在接收方处，数据可能不会按照发送方调用send函数的次序划分，而可能出现单次发送数据分多次被接收，或多次发送的数据一次接收完的情形。为解决这些问题，所有的TCP数据前附加8个字节：前4个字节标识TCP数据的类型（样式描述、线路数据或其他），后4个字节标识数据的长度。发送方在发送数据前先发送8字节前缀，而接收方会根据接收到的前8字节判断数据类型和长度，并持续读取直到读取完毕；如有冗余数据，则其会被截取并作为下一份TCP数据的开头。

UDP套接字的使用涉及IPv4组播技术。组播是一种由单主机发送数据给一组目标主机的传输方式，相较于单播而言可以节约网络带宽，与广播相比可以跨网段传输信息。主控程序通过组播技术传送指令和列车状态数据，可以有效降低网络负载。

### 样式描述模块设计

#### 样式描述结构

动态地图的样式描述是一组定义和描述地图结构和元素组成的文件。本项目支持的样式描述格式为单个文件目录，内包含如下成员：
- `qmldir`文件：QML模块目录文件，内包含本目录下欲使用的其他QML文件声明。
- `map.qml`文件：QML文件，描述地图的结构和元素组成。
- 其他QML文件、地图使用到的字体、图片资源等。

目前常见的描述界面结构的声明式语言主要有HTML、SVG、QML等。本项目选用QML作为描述界面所用的语言，鉴于其几项独特的优势：
- 可通过内联JavaScript描述界面的自定义行为。
- 可使用在C++程序内定义的一些Qt对象类型和单体类型。
- 有相对丰富的QtQuick模块支持，提供了常见的布局器、流程控制、窗口控制等功能。
- 使用了Qt的图像硬件加速技术，界面显示更加方便。相比之下，HTML界面只能在QtWebEngine模块支持的界面中显示。
- 模块复用方便，且支持动态加载外部QML。这也使得通过网络传输外部QML代码并加载成为现实。

以本项目在开发期间使用的一个样式描述为例：该样式目录有如下成员：

```
MetroMap
+- qmldir
+- map.qml
+- figures
|  +- shmetro.png
+- fonts
   +- simhei.ttf
   +- arial.ttf
```

其中`figures`存储了样式使用到的图片资源，`fonts`存储了样式使用到的字体资源，它们被目录下的`map.qml`索引并使用。

#### 样式描述传输格式

主控程序在加载样式描述目录后，需要将目录打包发送至各显示终端。目录的打包格式如下：

| 编号  | 字节长度 | 格式  | 项目                     |
| --- | ---- | --- | ---------------------- |
| 1   | 8    | INT | TCP数据标识字节              |
| 2   | 4    | INT | 目录下的一级成员数量，包括一级文件和一级目录 |
| 3   | 变量   | 不适用 | 依次排列各文件成员和目录成员         |

文件成员的格式如下：

| 编号  | 字节长度 | 格式   | 项目           |
| --- | ---- | ---- | ------------ |
| 1   | 4    | INT  | 定值0，表示该成员为文件 |
| 2   | 52   | CHAR | 成员的文件名       |
| 3   | 4    | INT  | 文件长度，以字节数计   |
| 4   | 4    | 不适用  | 保留成员         |
| 5   | 变量   | 不适用  | 文件内容         |

目录成员的格式如下：

| 编号  | 字节长度 | 格式   | 项目           |
| --- | ---- | ---- | ------------ |
| 1   | 4    | INT  | 定值1，表示该成员为目录 |
| 2   | 52   | CHAR | 成员的目录名       |
| 3   | 4    | INT  | 该目录下文件成员的数量  |
| 4   | 4    | 不适用  | 保留成员         |
| 5   | 变量   | 不适用  | 目录下的各文件成员    |

整个目录在通过上述方式打包后，会形成一个TCP字节流，该字节流发送到显示终端后，可由地图生成平台按上述格式进行解包，存储到显示终端的指定目录，以便随后进行地图生成与显示。

### 线路数据模块设计

#### 线路数据结构

本项目的设计允许用户从本地加载轨道交通系统的整个网络，并从整个网络的所有可行区间中挑选一个作为使用的地铁线路数据。

轨道交通系统网络在本地是一个包含数个JSON文件的目录：
- `root.json`：记录了网络内的所有线路名称和站点中英文名。
- `<线路名>.json`：每个合法线路对应一个线路文件，记录了线路的主题色、中英文名、编号、组成区间和端点等信息。

考虑到上海地铁系统比较复杂，这里仅截取部分文件片段说明。这是`root.json`的部分内容：

```json
{
	"lines": [ "1号线", "2号线", "10号线", ... ],
	"stations": [
		{ "name": "同济大学", "ename": "Tongji University" },
		{ "name": "五角场", "ename": "Wujiaochang" },
		...
	]
}
```

这是`10号线.json`的部分内容：

```json
{
    "color": 4290750719,
    "name": "10号线",
    "number": 10,
    "ends": [ "基隆路", "虹桥火车站", "航中路" ],
    "periods": [
        { "sta": "国权路", "stb": "同济大学" },
        { "sta": "同济大学", "stb": "四平路" },
        ...
    ]
}
```

#### 线路数据生成算法

主控平台在加载并检查轨道交通系统网络目录后，会引用深度优先搜索算法逐线路遍历，得到每条地铁线路的大致运行区间。

例如，上海地铁10号线的大致运行区间有6个：虹桥火车站到基隆路区间，虹桥火车站到航中路区间（实际不可行），基隆路到虹桥火车站区间，基隆路到航中路区间，航中路到虹桥火车站区间（实际不可行），航中路到基隆路区间。并非所有大致运行区间都是实际可行区间，实际选择时仍需人为甄别。

深度优先搜索算法遍历线路的流程如下：
1. **初始化上下文**：
    - `RouteTraverseContext`包含了当前遍历的状态，包括站点栈、转乘列表、已访问的站点、站点名称映射、站点邻接关系、线路信息、线路终点信息以及回调函数。
2. **遍历线路**（`traverse_line`函数）：
    - **获取当前站点**：从站点栈中获取当前处理的站点。
    - **确定邻接站点和转乘站点**：遍历当前站点的邻接站点，如果邻接站点属于当前线路，则加入邻接站集合；如果属于其他线路，则加入转乘集合。
    - **处理转乘信息**：将所有转乘线路的信息添加到转乘列表中，并更新当前站点的转乘列表。
    - **确定下一步动作**：
        - **找到邻接站点**：确定当前站点的未访问邻接站点，如果未访问的邻接站点数量为0，说明当前分支遍历完毕，需要进行结算。
        - **处理结算情况**：
            - 如果形成闭环，则添加起始站点作为结束站点，处理转乘信息，并生成完整的路线信息包，调用回调函数处理。
            - 处理完毕后，弹出转乘信息，回溯到上一个站点。
        - **处理搜索情况**：
            - 将当前站点标记为已访问。
            - 对于每一个未访问的邻接站点，递归调用`traverse_line`函数进行进一步的深度优先搜索。
            - 搜索完毕后，将当前站点从已访问集合中移除。
    - **回溯**：在搜索或结算之后，弹出转乘信息，回到上一个站点，继续处理其他可能的路径。
3. **生成路线信息包**：
    - 在找到完整的路径后，生成一个包含线路名称、线路颜色、站点数量、转乘数量、站点信息和转乘信息的线路信息包。
    - 调用预定义的回调函数，将生成的路线信息包传递出去进行进一步处理。

### 列车状态模块设计

