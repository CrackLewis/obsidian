
## 总体设计

### 可行性分析（略）

### 需求分析

#### 功能需求

平台需作为显示终端程序的一部分或主体，并实现如下功能：
- 接收并解析主控程序发送的动态地图样式描述，包括动态地图的结构描述和所使用的字体、图像等文件。
- 接收并解析主控程序发送的动态地图线路数据，包括线路的名称、主题色、沿线各站中英文名、线路拓扑结构等信息。
- 根据解析完毕的动态地图样式描述和线路数据信息，实现线路动态地图的自动生成和在终端上的显示。
- 接收并解析主控程序发送的列车实时状态信息，包括日期时间、列车位置、到站状态、开门侧、车门状态、紧急广播等信息，并根据这些信息更新动态地图。
- 拉取动态地图需要拉取的视频流，并正确呈现在动态地图的对应位置。

为进行功能验证，需要编写能够与平台通信的主控系统模拟程序，主控系统模拟程序需完成如下功能：
- 发现程序主机所在广播域内的显示终端，并建立与这些终端的连接。
- 选取存储在本地的动态地图样式描述和样式数据，发送给显示终端。
- 通过操作程序界面修改列车的实时运行状态，并以定时自动发送和手动发送两种方式发送运行状态给显示终端。
- 向显示终端通知视频流地址，以便显示终端启动拉流；实现本地文件的推流功能，以便测试视频流功能。

本文所称主控程序，均指车载PIS主控系统模拟程序，不考虑轨道交通指挥中心PIS、多线路中心PIS、单线路中心PIS等高级PIS主控系统的影响。

本文所称地图平台、地图生成平台、动态地图平台、动态地图生成平台，均指地铁动态地图自动生成平台。

#### 技术需求

平台需运行于x86或ARM架构的通用计算机和嵌入式计算机下，主机应至少具备2个处理器核心和4GB内存，操作系统为Linux。主控程序需运行于x86架构的通用计算机下，主机应至少具备4个处理器核心和8GB内存，操作系统为Windows或Linux。

平台所在主机需要与主控程序处于同一广播域，以便与主控程序实现信息交换。平台和主控程序需要实现基于TCP套接字的网络连接，通过可靠连接传输动态地图的样式描述、线路数据等内容；需要实现广播或组播套接字，通过该套接字进行网络发现、定期点名和发送列车实时状态等操作。

考虑到平台可能需要在动态地图内播放视频，故平台需要根据主控程序的指令拉取网络视频流并逐帧转码为合适的图像格式，以便在地图界面上实时显示，与此同时主控程序需要通过网络指令实现视频流的播放控制。

### 总体设计方案

动态地图生成平台为Qt Quick程序，运行于显示终端，除连接到终端显示屏外，还通过TCP和UDP端口连接到网络上的主控程序。TCP端口负责传输样式描述、线路数据等高可靠性要求的数据；UDP端口负责通过主控程序指令建立和维护连接，同时传输列车运行状态等低可靠性要求的数据。

主控程序为Qt Widget程序，运行于车载通用计算机，该计算机应在本地存储地图生成所必需的样式描述文件和线路数据文件，并确保与各显示终端连接到同一局域网。主控程序维护一个存有与各显示终端连接的TCP连接池用于发送可靠数据，另维护一个UDP端口用于发送连接指令和列车状态数据。

动态地图生成平台设计为5个子模块：
- 样式描述解析模块：从TCP端口接收并解析样式描述文件，解析结果呈递地图生成模块。
- 线路数据解析模块：从TCP端口接收并解析线路数据，解析结果呈递地图生成模块。
- 列车状态解析模块：从UDP端口接收并解析列车的实时运行状态，根据运行状态更新动态地图中的对应内容。
- 视频流拉取模块：根据主控程序的命令创建或销毁拉流线程，拉流线程负责拉取指定网络地址的RTSP视频流，并将视频帧转码为RGB图像显示于动态地图的指定位置。
- 地图生成模块：根据解析模块的解析结果，运用动态地图生成算法生成动态地图，将地图全屏显示于显示终端。

主控程序设计为用户界面和4个子模块：
- 用户界面：为程序各项主要功能提供可操作图形化界面。
- 样式描述加载模块：从用户指定的本地目录加载样式描述文件，通过TCP端口发送。
- 线路数据加载模块：从用户指定的本地目录加载线路数据文件，通过TCP端口发送。
- 列车状态发送模块：以定时自动发送或手动发送方式之一，将当前的列车运行状态通过UDP端口组播发送。
- 视频流控制模块：通过UDP端口发送视频流创建和销毁命令；允许从指定的本地视频启动RTSP推流。

### 总体设计框图

根据前文的总体设计方案，绘制总体设计框图如下所示：

![[cumulative_design.png]]

## 详细设计

基于前面的总体设计部分，对各模块进行详细设计如下。

### 程序流程设计

主控程序和地图生成平台都通过有限状态机实现程序流程的控制。在任一时刻，程序必处于一个合法状态，而在指定的事件发生时，会迁移到另一个合法状态。

主控程序的UML状态图如下所示：



### 网络接口设计

主控程序维护3个网络设施：
- TCP套接字：固定于主机的端口，监听来自显示终端的连接请求。用QTcpServer实现。
- TCP连接池：存储与每个显示终端的TCP连接。用从套接字地址到QTcpSocket指针的带锁哈希表实现。
- UDP套接字：加入组播组，向组内的显示终端发送连接命令和列车状态数据。用QUdpSocket实现。

地图生成平台维护两个网络设施：
- TCP套接字：与主控程序连接，接收样式描述和线路数据。用QTcpSocket实现。
- UDP套接字：加入组播组，接收主控程序发送的连接命令和列车状态数据。用QUdpSocket实现。

